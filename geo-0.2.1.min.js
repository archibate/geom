!function(){"use strict";function t(t){return t>=0?1:-1}function e(t,e){var n=t.toString();if("0"===n||n.indexOf(".")<0||n.indexOf("e")>=0)return n;n=t.toFixed(e);for(var i=n.length-1;i>0;){if("0"!==n.charAt(i))break;--i}return"."===n.charAt(i)&&--i,n.slice(0,i+1)}function n(t,e,n){var i=e.x-t.x,r=e.y-t.y,a=n.x-t.x,s=n.y-t.y,o=i*s-a*r;return 0==o||bs(o)<fs}function i(t,e,n){var i=e.x+n.x-2*t.x,r=e.y+n.y-2*t.y;return ms(i*i+r*r)<fs}function r(t,e,n,i){var r=e.x-t.x,a=e.y-t.y,s=i.x-n.x,o=i.y-n.y,l=a*s-o*r;return 0==l||bs(l)<fs}function a(t,e,n,i){var r=e.x-t.x,a=e.y-t.y,s=i.x-n.x,o=i.y-n.y,l=r*s+a*o;return 0==l||bs(l)<fs}function s(t,e,n,i){if(!r(t,e,n,i))return!1;var a=(e.x-t.x)*(i.x-n.x),s=(e.y-t.y)*(i.y-n.y);return bs(a)<fs?s>0:bs(s)<fs?a>0:a>0&&s>0}function o(t,e,n){var i=n.p1,r=n.p2,a=i.x,s=i.y,o=r.x,l=r.y,u=o-a,_=l-s,h=_,c=-u,p=o*s-a*l,f=h*h+c*c,v=ms(f),d=(h*t+c*e+p)/v,y=bs(d),g=(u*(t-a)+_*(e-s))/f,b=g,m=!0,x=n.t_range;return x&&(g<x.min?(g=x.min,m=!1):g>x.max&&(g=x.max,m=!1)),{x:b*u+a,y:b*_+s,t:g,d:y,d_p:d,t_old:b,in_range:m}}function l(t,e){var n=e.x-t.x,i=e.y-t.y;return ms(n*n+i*i)}function u(t,e){if(0==t&&0==e)return 0;var n=ms(t*t+e*e),i=ws(e/n);return t<0&&e>=0?i=vs-i:t<0&&e<=0?i=vs-i:t>=0&&e<0&&(i=ds+i),i}function _(t,e){var n=Os(e,t);return n<0?n+ds:n}function h(t,e){for(var n=e-t;n<0;)n+=ds;for(;n>ds;)n-=ds;return n}function c(t,e,n){var i=l(e,n),r=l(n,t),a=l(t,e);return js((a*a+i*i-r*r)/(2*a*i))}function p(t,e,n,i){var r=_(e.x-t.x,e.y-t.y);return h(_(i.x-n.x,i.y-n.y),r)}function f(t,e){var n=t.y-e.y,i=e.x-t.x,r=(t.x+e.x)/2,a=(t.y+e.y)/2,s=r+n,o=a+i;return{A:o-a,B:r-s,C:s*a-r*o}}function v(t,e,n,i){var r=t.x,a=t.y,s=e.x,o=e.y,l=n.x,u=n.y,_=i.x,h=i.y,c=s-r,p=l-_,f=r-l,v=o-a,d=u-h,y=a-u,g=v*p-c*d;if(0==g)return null;var b=(d*f-p*y)/g;return{x:c*b+r,y:v*b+a,t1:b,t2:(c*y-v*f)/g}}function d(t,e,n){var i=f(t,e),r=f(e,n);if(!i||!r)return null;var a=r.A*i.B-i.A*r.B;return 0==a?null:{x:(r.B*i.C-i.B*r.C)/a,y:(i.A*r.C-r.A*i.C)/a}}function y(t,e,n){var i=t.x,r=t.y,a=e.x,s=e.y,o=n.x,l=n.y;return v(t,{x:i+(s-l),y:r-(a-o)},e,{x:a+(r-l),y:s-(i-o)})}function g(t,e,n){var i=l(e,n),r=l(n,t),a=l(t,e),s=i+r+a;return{x:(i*t.x+r*e.x+a*n.x)/s,y:(i*t.y+r*e.y+a*n.y)/s}}function b(t,e){var n=e.delta||0,i=e.x2-e.x1,r=e.y2-e.y1;if(0==i&&0==r)return e.exist=!1,e;var a=e.t_min,s=e.t_max;void 0===a&&(a=gs),void 0===s&&(s=ys);var o=0,l=0;if(0!=i)o=(t.left-n-e.x1)/i,l=(t.right+n-e.x1)/i,i>0?(o>a&&(a=o),l<s&&(s=l)):i<0&&(o<s&&(s=o),l>a&&(a=l));else if(e.x1<t.left-n||e.x1>t.right+n)return e.exist=!1,e;var u=0,_=0;if(0!=r)u=(t.top-n-e.y1)/r,_=(t.bottom+n-e.y1)/r,r>0?(u>a&&(a=u),_<s&&(s=_)):r<0&&(u<s&&(s=u),_>a&&(a=_));else if(e.y1<t.top-n||e.y1>t.bottom+n)return e.exist=!1,e;return e.t_min=a,e.t_max=s,e.exist=a<s,e.exist&&(e.x2=s*i+e.x1,e.y2=s*r+e.y1,e.x1=a*i+e.x1,e.y1=a*r+e.y1),e}function m(t,e,n){var i={x:0,y:0},r=n.p1.x,a=n.p1.y,s=n.p2.x,o=n.p2.y,l=o-a,u=r-s,_=s*a-r*o;if(0==l&&0==u)return i;var h=l*l+u*u;return i.x=((u*u-l*l)*t-2*l*u*e-2*l*_)/h,i.y=((l*l-u*u)*e-2*l*u*t-2*u*_)/h,i}function x(t,e,n,i,r){var a=r.x-n.x,s=r.y-n.y,o=i.x-n.x,l=i.y-n.y,u=t-n.x,_=e-n.y,h=a*a+s*s,c=a*o+s*l,p=a*u+s*_,f=o*o+l*l,v=o*u+l*_,d=h*f-c*c;if(0==d)return!1;var y=(f*p-c*v)/d;if(y<0||y>1)return!1;var g=(h*v-c*p)/d;return!(g<0||g>1)&&y+g<=1}function k(t,e,n){var i=t.x-e.x,r=t.y-e.y;if(!i&&!r)return null;var a=n.x-e.x,s=n.y-e.y;if(!a&&!s)return null;if(bs(i*s-a*r)<1e-6)return null;var o=zs/ms(i*i+r*r),l=zs/ms(a*a+s*s),u=(o*i+l*a)/2+e.x,_=(o*r+l*s)/2+e.y;return u==e.x&&_==e.y?null:{x:u,y:_}}function w(){var t=Cs.DEF_colors;return t[Ts(Es()*t.length)]}function j(){return!0}function O(t,e,n){return t.split(e).join(n)}function P(t){return O(O(t,"[","_{"),"]","}")}function A(t,e){var n=t.indexOf(e);return n>=0&&(t.splice(n,1),!0)}function S(t){return t.__proto__||Object.getPrototypeOf(t)||t.constructor.prototype}function T(t,e){return t.layer<e.layer?-1:t.layer>e.layer?1:t.obj_id<e.obj_id?-1:1}function E(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(t[n]);return e}function z(t){return t.sort(function(t,e){return t.s_id<e.s_id?-1:1}),t}function C(t){for(var e={},n=0;n<t.length;++n){var i=t[n],r=i.obj_id;e.hasOwnProperty(r)||(e[r]=i,I(i,e))}return e}function I(t,e){var n=t.children();if(n&&n.length)for(var i=0;i<n.length;++i){var r=n[i];e.hasOwnProperty(r.obj_id)||(e[r.obj_id]=r,I(r,e))}}function B(t){for(var e=0;e<t.length;++e)t[e].valpha=1,t[e].visible=!0}function N(t){for(var e=0;e<t.length;++e)t[e].valpha=1,t[e].visible=!1}function M(t){for(var e=0;e<t.length;++e)if(t[e].visible)return!1;return!0}function q(t){M(t)?B(t):N(t)}function R(t,e){return qs(t.prototype,e)}function F(t,e,n){!function t(i,r){var a=S(i);a&&a!==i&&r<100&&t(a,r+1),i.hasOwnProperty(e)&&n(i[e])}(t,0)}function D(t,e,n){var i=Fs[e];if(!i)return void console.warn("Unsupport option name: "+e);switch(i.m){case"C":t[i.n]=X(n);break;case"L":t.gsf_read_label(n[0],n);break;case"P":t[i.n]=i.v;break;case"Q":t[i.n]=n[0];break;default:console.error("Unsupport option mode: "+i.m)}}function L(t){return t>=0&&t<16?Ds[t]:t.toString(16)}function X(t){return"string"==typeof t?t:1==t.length?t[0]:"#"+L(t[0])+L(t[1])+L(t[2])}function Y(t){switch(t){case 1:return Ls.dot;case 2:return Ls.smallPoint;case 4:return Ls.large}return Ls.mediumPoint}function U(t){return bs(t-Ls.dot)<fs?"dot":bs(t-Ls.smallPoint)<fs?"smallPoint":bs(t-Ls.mediumPoint)<fs?"mediumPoint":bs(t-Ls.large)<fs?"large":""}function H(t){switch(t){case 1:return Xs.hairline;case 2:return Xs.lightline;case 4:return Xs.thick}return Xs.mediumLine}function W(t){return bs(t-Xs.hairline)<fs?"hairline":bs(t-Xs.lightline)<fs?"lightline":bs(t-Xs.mediumLine)<fs?"mediumLine":bs(t-Xs.thick)<fs?"thick":""}function V(t){switch(t){case 0:return"solid";case 1:return"dashed";case 2:return"dotted";default:return""}}function G(t){return t instanceof Array}function J(t){return"string"==typeof t}function Q(t){return"number"==typeof t}function K(t){return"function"==typeof t}function Z(t){return" "===t||"\r"===t||"\n"===t||"\t"===t}function tt(t){var e=t.charCodeAt(0);return 65<=e&&e<=90||97<=e&&e<=122}function et(t){var e=t.charCodeAt(0);return 48<=e&&e<=57}function nt(t){var e=parseInt(t);return!isNaN(e)&&e.toString()===t}function it(t){return Gs[t]}function rt(t){return Js[t]}function at(t){return Qs[t]}function st(t){return Ks[t]}function ot(t){return Zs[t]}function lt(t){return to[t]}function ut(t,e){var n=t.bold?"bold ":"";return n+=t.italic?"italic ":"",(n+=e+"px ")+t.family}function _t(t){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e];void 0===n.d&&(n.d=0),void 0===n.c&&(n.c=e)}}function ht(t,e,n){if(!e)return 0;if(e.isKern||t.isKern)return 0;var i=e.type,r=t.type;i<0?i=0:i>7&&(i=7),r<0?r=0:r>7&&(r=7);var a=Po[i][r];return 0==a?0:a<0&&n.style>=Ws.S?0:(a<0&&(a=-a),(a+2)*n.size/18)}function ct(t,e,n){var i=t.type;i!=Vs.BIN||null!=e&&!$o[e.type]?null!=n&&i==Vs.BIN&&Ao[n.type]&&(t.type=Vs.ORD):t.type=Vs.ORD}function pt(t){return.05*t.size}function ft(t){return t.style===Ws.D?Hs.sup1*t.size:t.style===st(t.style)?Hs.sup3*t.size:Hs.sup2*t.size}function vt(t,e){var n=new xo(e);return n.init_size(t),n}function dt(t){return t instanceof So&&1==t.count()?t.get(0):t}function yt(t,e){!0!==t.visible&&(e.visible=t.visible)}function gt(t){var e=void 0,n=new hs("{#"+t.id+"} "+t.name+"("),i=t.pars;if(i)for(e=0;e<i.length;++e)e&&n.p(", "),n.p(bt(i[e]));n.p(")"),t.pars2,t.pars_arr,n.p(" [");var r=t.props,a=void 0,s=void 0;for(var o in r)if(r.hasOwnProperty(o)){switch(s=r[o],a&&n.p(", "),o){case"label":n.p(s);break;case"color":mt(n,s);break;case"hidden":n.p("hidden");break;case"point_size":xt(n,s);break;case"line_width":kt(n,s);break;case"line_style":wt(n,s);break;default:s===Lo?n.p(o):n.p(o,"(",bt(s),")")}a=1}return n.p("];"),n.toString()}function bt(t){return t instanceof Xo?"#"+t.s_id:"string"==typeof t?JSON.stringify(t):t.toString()}function mt(t,e){e=e.toLowerCase();var n=Yo[e];n?t.p(n):t.p('color("'+e+'")')}function xt(t,e){var n=U(e);n?t.p(n):t.p("point_size("+e+")")}function kt(t,e){var n=W(e);n?t.p(n):t.p("line_width("+e+")")}function wt(t,e){var n=V(e);n?t.p(n):t.p("line_style("+e+")")}function jt(t){var e={};return F(t,"_jpda",function(n){if(n&&n.length)for(var i=0;i<n.length;++i){var r=n[i];if("string"==typeof r)e[r]=t[r];else{if("function"!=typeof r)throw new Error("Unknown key in jpda: "+r);r(t,e)}}}),e}function Ot(t,e){e.forEach(function(e){Object.getOwnPropertyNames(e.prototype).forEach(function(n){"constructor"!==n&&(t.prototype[n]=e.prototype[n])})})}function Pt(t,e,n,i,r,a){a||(a=[10,5]);var s=a.length,o=i-e,l=r-n,u=bs(o)>bs(l),_=u?l/o:o/l;t.moveTo(e,n);for(var h=ms(o*o+l*l),c=0;h>=.1;){var p=$s(h,a[c%s]),f=ms(p*p/(1+_*_));u?(o<0&&(f=-f),e+=f,n+=_*f):(l<0&&(f=-f),e+=_*f,n+=f),c%2==0?t.lineTo(e,n):t.moveTo(e,n),h-=p,c++}}function $t(t,e,n,i){t.beginPath();for(var r=i+e,a=n,s=0;s<6.283185307179586;){s+=.05235987755982988;var o=ks(s)*i+e,l=xs(s)*i+n;t.moveTo(r,a),t.lineTo(o,l),s+=.05235987755982988,r=ks(s)*i+e,a=xs(s)*i+n}t.stroke()}function At(t,e){var n=Ko;n&&n.width&&n.height&&(t.fillStyle=t.createPattern(n,"repeat"),t.fill(e||"evenodd"))}function St(){return[arguments.length>0&&void 0!==arguments[0]?arguments[0]:-4,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.381]}function Tt(t){return t&&t.path_type&&K(t.path_info)}function Et(t,e){if(!t.exist||!e.exist)return[];var n=t.p1,i=t.p2,r=e.p1,a=e.p2,s=i.x-n.x,o=r.x-a.x,l=r.x-n.x,u=i.y-n.y,_=r.y-a.y,h=r.y-n.y,c=u*o-s*_;if(0==c)return[{x:0,y:0,obj1:t,obj2:e,isel:0,exist:!1}];var p=(o*h-_*l)/c,f=(u*l-s*h)/c,v=t.t_range.in_range(p)&&e.t_range.in_range(f);return[{x:v?p*s+n.x:0,y:v?p*u+n.y:0,obj1:t,obj2:e,isel:0,exist:v}]}function zt(t,e){var n=t.p1.x,i=t.p1.y,r=t.p2.x-n,a=t.p2.y-i,s=n-e.op.x,o=i-e.op.y,l=e.get_radius(),u=r*r+a*a,_=2*(r*s+a*o),h=s*s+o*o-l*l,c=_*_-4*u*h;if(c<0)return[];var p=(-_-ms(c))/(2*u),f=(-_+ms(c))/(2*u),v=t.t_range.in_range(p),d=t.t_range.in_range(f);return[{x:v?p*r+n:0,y:v?p*a+i:0,obj1:t,obj2:e,isel:1,exist:v},{x:d?f*r+n:0,y:d?f*a+i:0,obj1:t,obj2:e,isel:2,exist:d}]}function Ct(t,e){var n=t.op.x,i=t.op.y,r=e.op.x-n,a=e.op.y-i;if(0==r&&0==a)return[];var s=ms(r*r+a*a),o=t.get_radius(),l=e.get_radius();if(0==o||0==l)return[];if(s>o+l||s<bs(o-l))return[];var u=(o*o-l*l+r*r+a*a)/(2*o*s),_=ms(1-u*u),h=o/s;return[{x:(r*u+a*_)*h+n,y:(a*u-r*_)*h+i,obj1:t,obj2:e,isel:1,exist:!0},{x:(r*u-a*_)*h+n,y:(a*u+r*_)*h+i,obj1:t,obj2:e,isel:2,exist:!0}]}function It(t){var e=t.p1,n=t.p2,i=e.exist&&n.exist;i&&e.x==n.x&&e.y==n.y&&(i=!1),t.exist=i}function Bt(t){return"line"===t.type}function Nt(t,e){var n=t.children();if(!n)return null;for(var i=0;i<n.length;++i){var r=n[i];if(e(r))return r}return null}function Mt(t,e){var n=t-e;return n>=0?n:n+2*vs}function qt(t,e){function n(n){var i=n-a;if(i<-o||i>o)return 0;var r=ms(o*o-i*i),l=s+r,_=void 0;return e.top<=l&&l<=e.bottom&&(_=u(i,r),t._in_arc(_))?1:(l=s-r,e.top<=l&&l<=e.bottom&&(_=u(i,-r),t._in_arc(_))?1:0)}function i(n){var i=n-s;if(i<-o||i>o)return 0;var r=ms(o*o-i*i),l=a-r,_=void 0;return e.left<=l&&l<=e.right&&(_=u(-r,i),t._in_arc(_))?1:(l=a+r,e.left<=l&&l<=e.right&&(_=u(r,i),t._in_arc(_))?1:0)}var r=t.op,a=r.x,s=r.y,o=t.r;return!!n(e.left)||(!!n(e.right)||(!!i(e.top)||!!i(e.bottom)))}function Rt(t){return this.start_angle<this.end_angle?this.start_angle<=t&&t<=this.end_angle:this.start_angle<=t||t<=this.end_angle}function Ft(){var t=this.start_pt,e=this.end_pt,n=t.x,i=t.y,r=n,a=i;e.x<n&&(n=e.x),e.y<i&&(i=e.y),e.x>r&&(r=e.x),e.y>a&&(a=e.y);var s=this.op,o=s.x,l=s.y,u=this.r,_=void 0,h=void 0;return this._in_arc(0)&&(_=o+u,h=l,_<n&&(n=_),h<i&&(i=h),_>r&&(r=_),h>a&&(a=h)),this._in_arc(vs/2)&&(_=o,h=l+u,_<n&&(n=_),h<i&&(i=h),_>r&&(r=_),h>a&&(a=h)),this._in_arc(vs)&&(_=o-u,h=l,_<n&&(n=_),h<i&&(i=h),_>r&&(r=_),h>a&&(a=h)),this._in_arc(3*vs/2)&&(_=o,h=l-u,_<n&&(n=_),h<i&&(i=h),_>r&&(r=_),h>a&&(a=h)),{left:n,top:i,right:r,bottom:a}}function Dt(t,e,n,i,r){var a=t.left,s=t.top,o=t.right,l=t.bottom,u=i-e,_=r-n,h=void 0,c=void 0;do{if(n<s&&r<s||n>s&&r>s||e<a&&i<a||e>o&&i>o)break;if(h=(s-n)*u/_+e,a<=h&&h<=o)return!0}while(0);do{if(n<l&&r<l||n>l&&r>l||e<a&&i<a||e>o&&i>o)break;if(h=(l-n)*u/_+e,a<=h&&h<=o)return!0}while(0);do{if(e<a&&i<a||e>a&&i>a||n<s&&r<s||n>l&&r>l)break;if(c=(a-e)*_/u+n,s<=c&&c<=l)return!0}while(0);do{if(e<o&&i<o||e>o&&i>o||n<s&&r<s||n>l&&r>l)break;if(c=(o-e)*_/u+n,s<=c&&c<=l)return!0}while(0);return!1}function Lt(t){if(null==t||t.length<3)return 0;for(var e=t[0],n=0,i=1;i<t.length;++i){var r=t[i];n+=e.x*r.y-r.x*e.y,e=r}return n+=e.x*t[0].y-t[0].x*e.y,bs(n/2)}function Xt(t,e,n){var i=t.x,r=t.y,a=e.x,s=e.y,o=a-i,l=s-r,u=l,_=-o,h=a*r-i*s,c=u*n.x+_*n.y+h;return bs(c)<fs?0:c>0?1:-1}function Yt(t,e){if(t.width<=0)return!1;var n=t.left,i=n+t.width;if(n<e.left&&(n=e.left),i>e.right&&(i=e.right),n>i)return!1;var r=t.top,a=r+t.height;return r<e.top&&(r=e.top),a>e.bottom&&(a=e.bottom),!(r>a)}function Ut(t,e){if(!t.exist)return!1;var n=e.cur_x-e.last_x,i=e.cur_y-e.last_y;return(0!=n||0!=i)&&(t.left+=n,t.top+=i,!0)}function Ht(t){return 1===t||2===t||3===t||4===t?t:1}function Wt(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:7,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:25;a=a*vs/180,r/=ks(a);var s=r*ks(i+a),o=r*xs(i+a),l=r*ks(i-a),u=r*xs(i-a);t.beginPath(),t.moveTo(e,n),t.lineTo(e+l,n+u),t.lineTo(e+s,n+o),t.closePath(),t.fill()}function Vt(t){return t&&K(t.calc_perimeter)}function Gt(t){return t&&K(t.calc_circum)}function Jt(t){return t&&K(t.calc_area)}function Qt(t){return t&&K(t.get_radian)}function Kt(t){return t&&K(t.get_radius)}function Zt(t){return t instanceof ml?0==t.line_type:t instanceof pl}function te(t){return{pad:t,timer_id:null,tick_count:0,cur_anis:[]}}function ee(t){t._all_anim=null}function ne(t){null===t.timer_id&&(t.tick_count=0,t.timer_id=setInterval(function(){re(t)},50))}function ie(t){null!==t.timer_id&&(clearInterval(t.timer_id),t.timer_id=null)}function re(t){var e=t.cur_anis;if(e&&e.length){var n=t.pad;++t.tick_count,e=e.slice(0);for(var i=!1,r=0;r<e.length;++r){var a=e[r],s=a.tick();switch(s){case Kl:i=!0;break;case Zl:break;default:a.finish(s),n.remove_animate(a),i=!0}}i&&n.draw(),t.cur_anis&&t.cur_anis.length||ie(t)}}function ae(t,e){return{mp:t,dp:e,dist:l(t,e),speed:.5,fsh:!1}}function se(t){var e=t.length,n=void 0;for(n=e-1;n>=0;--n){if("0123456789".indexOf(t.charAt(n))<0)break}if(n==e-1)return null;var i=t.substr(n+1);return nt(i)?parseInt(i):null}function oe(t){return t+1}function le(t,e){var n=document.createElement(t);return e&&(n.className=e),n}function ue(t,e){var n=document.createElement("option");return n.text=t,null!=e&&(n.value=e.toString()),n}function _e(t,e){return t&&t.appendChild(e),e}function he(t,e,n){return _e(t,le(e,n))}function ce(t,e){t.setAttribute("name",e)}function pe(t){t.stopPropagation(),t.preventDefault(),t.cancelBubble=!0}function fe(t){t.menus||(t.menus=["edit","show","cons","xfrm","meas"],de(t))}function ve(t,e,n,i){t.menu_div=n,fe(i),be(t,e);for(var r=t.menu_ul=le("ul","dropdown"),a=i.menus,s=0;s<a.length;++s){Pe(t,e,ge(t,a[s]))}if(_e(n,r),i.show_fast_label){var o=i.fast_label_items||"",l=null;i.fast_label_items_ex&&(l=i.fast_label_items_ex.split(",")),we(n,t,o,l)}}function de(t){var e=[],n=!1,i=void 0;t.dis_edit_menu?n=!0:(i=t.set_edit_menu)?(i=ye(ju.edit,i),e.push("edit: "+i.join(" ")),n=!0):e.push("edit"),t.dis_show_menu?n=!0:(i=t.set_show_menu)?(i=ye(ju.show,i),e.push("show: "+i.join(" ")),n=!0):e.push("show"),t.dis_cons_menu?n=!0:(i=t.set_cons_menu)?(i=ye(ju.cons,i),e.push("cons: "+i.join(" ")),n=!0):e.push("cons"),t.dis_xfrm_menu?n=!0:(i=t.set_xfrm_menu)?(i=ye(ju.xfrm,i),e.push("xfrm: "+i.join(" ")),n=!0):e.push("xfrm"),t.dis_meas_menu?n=!0:(i=t.set_meas_menu)?(i=ye(ju.meas,i),e.push("meas: "+i.join(" ")),n=!0):e.push("meas"),n&&(t._old_menu=e)}function ye(t,e){for(var n=t.split(" "),i=[],r=0;r<e.length;++r){var a=e[r];if(a)if("-"==a)i.push("-");else if("-all"==a)i=[];else if("+all"==a)i=n.slice(0);else if("+"==a.charAt(0)){var s=n.indexOf(a.substr(1));s>=0&&i.push(n[s])}else if("-"==a.charAt(0)){var o=i.indexOf(a.substr(1));o>=0&&i.splice(o,1)}}return i}function ge(t,e){var n=e.split(":"),i=n[0],r={n:i,t:i,items:(n[1]||"").trim()},a=Ou[i];return a&&("string"==typeof a?r.t=a:(a.t&&(r.t=a.t),!r.items&&a.items&&(r.items=a.items))),r}function be(t,e){e.top_enter=function(t){me(e.gmenu,e,this,t)},e.top_leave=function(t){xe(e.gmenu,e,this,t)},e.top_click=function(){je(e.gmenu,e,this)},e.item_click=function(){ke(e.gmenu,e,this)},e.second_enter=function(){je(e.gmenu,e,this)},e.second_leave=function(){$(this).find("> ul:first").hide()}}function me(t,e,n,i){pe(i);var r=(new Date).getTime();if(null===e._top_timer){if(e._last_ts&&r-e._last_ts<200)return void je(t,e,n);e._top_timer=setTimeout(function(){e._top_out||(je(t,e,e._top_li),e._last_ts=(new Date).getTime()),e._top_timer=null,e._top_li=null},500),e._top_out=!1,e._top_li=n,e._top_ts=r}else{r-e._top_ts<500&&(e._top_out=!1,e._top_li=n,e._top_ts=r)}}function xe(t,e,n,i){pe(i),$(n).find("> ul:first").hide(),null!==e._top_timer&&(e._top_out=!0),e._last_ts=(new Date).getTime()}function ke(t,e,n){if(!$(n).hasClass("disabled")){var i=n.getAttribute("name");e._top_out=!0,setTimeout(function(){$(t.menu_ul).find("ul").hide(),t.owner.on_menu_click(i)},0)}}function we(t,e,n,i){function r(t){he(he(a,"li"),"span","set_label").textContent=t}for(var a=le("ul","set_label_cont"),s=n,o=0;o<s.length;++o)r(s.charAt(o));if(i)for(var l=0;l<i.length;++l)r(i[l]);$(a).find("span").click(function(){var t=this.textContent;t&&e.owner.on_set_label(t)}),_e(t,a)}function je(t,e,n){var i=$(n);if(!i.find("> span:first").hasClass("disabled")){var r=i.find("> ul:first");if(r.length&&!r.is(":visible")){for(var a=r.find("> li > span"),s=0;s<a.length;++s){var o=a[s],l=o.getAttribute("name");l&&(t.owner.on_menu_status(l)?$(o).removeClass("disabled"):$(o).addClass("disabled"))}r.show()}}}function Oe(t,e,n){var i=he(e,"li"),r=he(i,"span");return r.textContent=t,n&&ce(r,n),i}function Pe(t,e,n){var i=t.menu_ul,r=n.t.replace(/\(.+\)/,""),a=Oe(r,i,n.n);if(!n.items)return void $(a).find("span").click(e.item_click);var s=he(a,"ul");$(a).hover(e.top_enter,e.top_leave).click(e.top_click);for(var o=n.items.split(/[,\s]+/),l=0;l<o.length;++l)$e(t,e,s,o[l])}function $e(t,e,n,i){if(i){var r=Ou[i];if(r){"string"==typeof r&&(r={n:i,t:r});var a=he(n,"li"),s=he(a,"span");return r.b?(s.className="menubreak",a):(s.textContent=r.t,ce(s,i),r.color?function(){var n=he(a,"ul");Ae(t,e,n),$(a).hover(e.second_enter,e.second_leave)}():r.items?function(n){for(var i=he(a,"ul"),r=n.items.split(/[,\s]+/),s=0;s<r.length;++s)$e(t,e,i,r[s]);$(a).hover(e.second_enter,e.second_leave).click(e.top_click)}(r):$(s).click(e.item_click),a)}}}function Ae(t,e,n){for(var i=Cs.DEF_colors,r=0;r<i.length;++r){var a=he(n,"li"),s=he(a,"span");ce(s,i[r]),s.className="color_mitem",s.style.backgroundColor=i[r],$(s).click(e.item_click)}}function Se(t){if(!("tools"in t))for(var e="point,lines,seg,ray,line,circle".split(","),n=0;n<e.length;++n)!function(e){e in t||(t[e]=!0)}(e[n])}function Te(t){t.m_enter=function(){if(!Cs.support_touch){$(this).find("> ul:first").show()}},t.m_leave=function(){if(!Cs.support_touch){$(this).find("> ul:first").hide()}},t.m_click=function(){var e=$(this),n=e.find("> span:first");if(n.length){var i=n.attr("name"),r=e.find("> ul:first");if(r.length&&Cs.support_touch)return void r.toggle();Re(t),n.addClass("selected"),0===i.indexOf("macro_")?t.pad.on_macro_tool(i.substring(6)):t.pad.on_tool_clicked(i)}},t.m_click2=function(e){pe(e);var n=$(this),i=n.find("> span:first");if(i.length){var r=(i[0],i.attr("name"));Re(t),i.addClass("selected");var a=n.parent().parent(),s=a.find("> span:first"),o=s[0];o.className=i[0].className,o.title=i[0].title,s.attr("name",i.attr("name")),t.pad.on_tool_clicked(r)}}}function Ee(t,e){var n=le("li"),i=he(n,"span");return i.className="geo_tool "+t,ce(i,t),i.title=e||$u[t]||"工具 "+t,n}function ze(t,e,n){var i=Ee(e,n);return $(i).hover(t.m_enter,t.m_leave).click(t.m_click),i}function Ce(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",r=ze(e,n,i);return t.appendChild(r),r}function Ie(t,e){var n=Ee(e);return $(n).hover(t.m_enter,t.m_leave).click(t.m_click2),n}function Be(t,e,n){var i=[];if(n.seg&&i.push("segment"),n.ray&&i.push("ray"),n.line&&i.push("line"),i.length||i.push("segment"),1==i.length)return Ce(t,e,i[0]);if(!n.expand_lines){var r=Me(e,i);return qe(e,i[0],t,r)}for(var a=0;a<i.length;++a)Ce(t,e,i[a])}function Ne(t,e){return qe(e,"polygon",t,Me(e,["polygon","polygon2","polygon3"]))}function Me(t,e){var n=le("ul"),i=e.length;n.style.width=36*i+1+"px";for(var r=0;r<i;++r){_e(n,Ie(t,e[r]))}return n}function qe(t,e,n,i){var r=ze(t,e);return _e(r,i),_e(n,r),r}function Re(t,e){var n=$(t.root_ul);n.find("li ul").hide(),e||n.find("li dd").hide(),n.find("span.selected").removeClass("selected")}function Fe(t,e,n,i){function r(){$(this).find("> dd").show()}function a(){$(this).find("> dd").hide()}function s(t){pe(t)}$(n).hover(r,a).click(s),n.setAttribute("class","macro");for(var o=le("dd",i),l=0;l<e.length;++l){var u=e[l],_=he(o,"dt"),h=he(_,"span");h.textContent=u.title,h.setAttribute("class",u.name),ce(h,u.name),h.setAttribute("title",u.title)}$(o).find("> dt").click(function(){Re(t),$(t.root_ul).find("span.cls").addClass("selected");var e=$(this).find("> span"),n=e.attr("name");e.addClass("selected"),t.pad.on_macro_tool(n)}),n.appendChild(o)}function De(t,e,n){function i(){$(this).find("> dd").show()}function r(){$(this).find("> dd").hide()}function a(t){pe(t)}if(n.expd_macro)for(var s=Cs.MacroTools2.groups,o=0;o<s.length;++o){var l="",u=s[o],_=ze(this,u,$u[u]+"工具");e.appendChild(_),l=Cs.MacroTools2[u].tools,Fe(t,l,_,u)}else if(n.expd_macro||!(n.expd_angle||n.expd_triangle||n.expd_quadrangle||n.expd_solid_figure)){var h=Ee("macros");_e(e,h),$(h).click(function(){Re(t,1),$(this).find("> span:first").addClass("selected"),$(this).find("> dd").toggle()});for(var c=le("dd","geo_macros"),p=Cs.MacroTools2,f=p.groups,v=0;v<f.length;++v){var d=p[f[v]],y=he(c,"dt"),g=he(y,"span");g.textContent=d.title,Le(t,d,y),$(y).hover(i,r).click(a)}h.appendChild(c)}else{if(n.expd_angle){var b=Cs.MacroTools2.angle.tools,m=ze(this,"angle","角工具");e.appendChild(m),Fe(t,b,m,"angle")}if(n.expd_triangle){var x=Cs.MacroTools2.triangle.tools,k=ze(this,"triangle","三角形工具");e.appendChild(k),Fe(t,x,k,"triangle")}if(n.expd_quadrangle){var w=Cs.MacroTools2.quadrangle.tools,j=ze(this,"quadrangle","四边形工具");e.appendChild(j),Fe(t,w,j,"quadrangle")}if(n.expd_solid_figure){var O=Cs.MacroTools2.solid_figure.tools,P=ze(this,"solid_figure","立体几何工具");e.appendChild(P),Fe(t,O,P,"solid_figure")}}}function Le(t,e,n){for(var i=le("dd"),r=e.tools,a=0;a<r.length;++a){var s=r[a],o=he(i,"dt"),l=he(o,"span");l.textContent=s.title,ce(l,s.name)}$(i).find("> dt").click(function(){Re(t),$(t.root_ul).find("span.macros").addClass("selected");var e=$(this).find("> span"),n=e.attr("name");t.pad.on_macro_tool(n)}),_e(n,i)}function Xe(t,e,n,i){var r=Ee(n,i);r.className="li_macro",_e(e,r),$(r).click(function(){var e=$(this).find("> span"),n=e.attr("name");$(t.root_ul).find("span.selected").removeClass("selected"),e.addClass("selected"),t.pad.on_macro_tool(n)})}function Ye(t){t.objX=t.offsetX,t.objY=t.offsetY}function Ue(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=t.get_track_point();n&&(n.visible=e)}function He(){var t=$("#geo_dialog_cont");return t.length||(t=$('<div id="geo_dialog_cont" style="display:none"></div>').appendTo(document.body)),t}function We(t,e,n){function i(){o&&document.body.removeChild(o),Cs._load_script_callback=r}var r=void 0,a=void 0,s=void 0;!function(){r=Cs._load_script_callback,Cs._load_script_callback=function(t,e){a=t,s=e}}(),"."===t.charAt(0)&&(t=Cs.DATA_PATH+t);var o=document.createElement("script");o.type="text/javascript",o.onload=function(){e&&e(a,s),i()},o.onerror=function(){n&&n(),i()},o.src=t,document.body.appendChild(o)}function Ve(t){for(var e=t;e;e=e.originalEvent)if("keydown"==e.type&&27==e.keyCode&&t.stopPropagation)return void t.stopPropagation()}function Ge(t,e){function n(){$(".tex_menu_item").click(r),$("#tex_support").click(a),_.dialog({title:"编辑文本",modal:!0,width:570,height:350,dialogClass:"prop-dialog",open:s,close:o,buttons:{"确定":l,"取消":u}})}function i(t,e){if(t&&""!==e){var n=document;if(n.selection){n.selection.createRange().text=e}else if("number"==typeof t.selectionStart&&"number"==typeof t.selectionEnd){var i=t.selectionStart,r=t.selectionEnd,a=t.value;t.value=a.substring(0,i)+e+a.substring(r,a.length);var s=i+e.length;t.selectionStart=t.selectionEnd=s}else t.value+=e}}function r(t){var e=this.name;if(e){var n=$("#tex_input");n&&n.length&&(i(n.get(0),e),n.focus())}}function a(){var t=$(".tex_menu");this.checked?t.show():t.hide()}function s(){var t=e.mode;$("#tex_support").prop("checked",!!t),$(".tex_menu").css("display",t?"":"none"),$("#tex_input").val(e.get_text())}function o(){}function l(){var n=$("#tex_input").val().trim(),i=$("#tex_support").prop("checked")?1:0;_.dialog("close"),e.mode=i,e.set_text(n),e.update(),t.draw()}function u(){_.dialog("close")}var _=He();We("../data/dialog/tex_edit_dialog.js",function(t,e){_.html(e),n()})}function Je(t,e){return t*t+e*e<=28}function Qe(t){for(var e={},n=0;n<t.length;++n){var i=t[n];e[i.obj_id]=i}return e}function Ke(t){var e=t.selected_objs,n=void 0,i={};n=Qe(e);for(var r in n)n.hasOwnProperty(r)&&tn(n[r],i);for(;;)if(!en(n,i))break;return n}function Ze(t){var e={};for(var n in t)t.hasOwnProperty(n)&&I(t[n],e);var i=E(e);return z(i),i}function tn(t,e){var n=t.children();if(n&&n.length)for(var i=0;i<n.length;++i){var r=n[i],a=r.obj_id;a in e||2!=r.free_value&&(e[a]=r,tn(r,e))}}function en(t,e){var n=!1;for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];if(0==r.free_value||r.obj_id in e){delete t[i];var a=r.move_ctrlrs();if(a)for(var s=0;s<a.length;++s){var o=a[s];t[o.obj_id]=o,tn(o,e)}n=!0}}return n}function nn(t){var e=t.get_selected();if(e&&e.length){var n=C(e),i=E(n);z(i),t.unselect_all();var r=t.get_history();r.do_oper("删除对象",function(){for(var e=i.length-1;e>=0;--e){var n=i[e];r.add_delete_rec(n),t.delete_obj(n)}})}}function rn(t,e,n){t.addEventListener(e,n,!1)}function an(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=t.ctx;if(n){e&&t.clear_canvas();for(var i=t.get_paint_q(),r=i.length,a=0;a<r;++a){var s=i[a];s.exist&&s.visible&&s.draw(n,t)}var o=t.track_point;o&&o.visible&&o.draw(n,t),t.sel_box&&sn(t,n)}}function sn(t,e){var n=t.sel_box,i=void 0,r=void 0,a=void 0,s=void 0;n.left<n.right?(i=n.left,a=n.right):(i=n.right,a=n.left),n.top<n.bottom?(r=n.top,s=n.bottom):(r=n.bottom,s=n.top),i!=a&&r!=s&&(e.beginPath(),e.rect(i+1,r+1,a-i-2,s-r-2),e.fillStyle="#ff00ff",e.globalAlpha=.1,e.fill(),e.beginPath(),e.rect(i,r,a-i,s-r),e.lineWidth=.5,e.strokeStyle="#ff00ff",e.globalAlpha=1,e.stroke())}function on(t){t.reset_sid();for(var e=[],n=t.head_obj;n;n=n.next_obj)if(!n.is_temp){var i=n.to_gsf_str();e.push(i)}return e.push(""),e.join("\n")}function ln(t,e){function n(e){var n=dn(t,e);n&&(t.append_obj(n),n.update())}var i=new xu;try{i.parse(e,n)}catch(t){console.error("parse_jsp5() error: ",t)}}function un(){throw new Error("unimplement object-name handler")}function _n(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return new Cs.CircleByRadius(n,i)}function hn(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1];return Cs.Point.new_oopt(n,i)}function cn(t,e,n){var i=n.args[0],r=t.read_gobjs(i[0]),a=t.read_gobjs(i[1]);return Cs.Point.new_intpt(r,a,e)}function pn(t){return cn(this,0,t)}function fn(t){return cn(this,1,t)}function vn(t){return cn(this,2,t)}function dn(t,e){var n=Mu[e.name];if(!n)throw new SyntaxError("Unsupport object-name: "+e.name);var i=n.call(t,e);if(!i)throw new Error("Can not create object for "+e.name);if(!(i instanceof Xo))throw new Error("Object is not a GObject");i.pad=t;var r=e.formats;if(r)for(var a=0;a<r.length;++a){var s=r[a];G(s)?i._set_option(s[0],s.slice(1)):i._set_option(s)}return i}function yn(t){var e=new qu;return mn(e,t.head_obj),t.each(function(t){return t.to_jgex_0(e)}),t.each(function(t){return t.to_jgex_1(e)}),t.each(function(t){return t.to_jgex(e)}),xn(this.head_obj),e.add_line(""),e}function gn(t){for(var e="",n=0;n<t.length;++n){var i=t.charAt(n);Ru.test(i)&&(e+=i)}return e}function bn(t,e){for(;;){var n=Fu[t.name_x];if(0!=t.name_0&&(n+=t.name_0),!e[n])return n;++t.name_x>=Fu.length&&(t.name_x=0,++t.name_0)}}function mn(t,e){t.name_x=0,t.name_0=0;for(var n={},i=e;i;i=i.next_obj)if("point"===i.type&&(i.__name="",i.label&&""!=i.label.text)){var r=gn(i.label.text);""==r||n[r]||(i.__name=r,n[r]=i)}for(var a=e;a;a=a.next_obj)if("point"===a.type&&""==a.__name){a.__name=bn(t,n);var s=a.get_label_obj();s.text=a.__name,s.show=1,a.auto_label_pos(),n[a.__name]=a}t.name_map=n}function xn(t){for(var e=t;e;e=e.next_obj)delete e.__name}function kn(t,e,n){var i=n.sid,r=n.class_name,a=Cs[r];if(!a)throw new Error("Cannot find the ctor for "+r);var s=new a;if(!(s&&s instanceof Xo))throw new Error("Cannot instance "+r);if(e.obj_map[i]=s,s.pad=t,n.label){var o=s.label=s._create_label();o.text=n.label[0],o.show=n.label[1],o.pos=n.label.slice(2)}if(s._parents=e.map_parents(n.parents),qs(s,n.props),n.xformer){var l=n.xformer,u=Cs[l.class_name],_=new u;l.parents&&(_._parents=e.map_parents(l.parents)),l.props&&qs(_,l.props),_.unserialize(),s.xformer=_}return s.unserialize(n,e),s.update(),s}function wn(t){return t instanceof il}function jn(t,e,n){return t.filter(function(t){return wn(t)&&t.is_pt_on_line(e)&&t.is_pt_on_line(n)})}function On(t,e,n){return t.filter(function(t){return wn(t)&&t.is_segment(e,n)})}function Pn(t,e,n){return t.filter(function(t){return wn(t)&&t.as_ray(e,n)})}function $n(t,e,n){return t.filter(function(t){return wn(t)&&t.as_sline(e,n)})}function An(t,e,n){return t.filter(function(t){return t instanceof dl&&t.is_pt_on_line(e)&&t.is_pt_on_line(n)})}function Sn(t,e,n){return t.filter(function(t){return t instanceof yl&&t.is_pt_on_line(e)&&t.is_pt_on_line(n)})}function Tn(t,e,n){return t.filter(function(t){return wn(t)&&t.as_bisl(e,n)})}function En(t,e){return t.filter(function(t){return t instanceof sl&&t.op==e})}function zn(t,e,n){return t.filter(function(t){return t instanceof sl&&t.op==e&&t.is_pt_on_circ(n)})}function Cn(t,e,n,i){return t.filter(function(t){return t instanceof sl&&t.is_pt_on_circ(e)&&t.is_pt_on_circ(n)&&t.is_pt_on_circ(i)})}function In(t){return t.is_readonly()}function Bn(t){return t.get_selected().length>0}function Nn(t){return qn(t,Qo)}function Mn(t){for(var e=t.get_selected(),n=0,i=0;i<e.length;++i){if(!(e[i]instanceof Qo))return-1;++n}return n}function qn(t,e){for(var n=0,i=t.get_selected(),r=0;r<i.length;++r)i[r]instanceof e&&++n;return n}function Rn(t,e){for(var n=0,i=t.get_selected(),r=0;r<i.length;++r){if(!(i[r]instanceof e))return-1;++n}return n}function Fn(t,e){for(var n=t.length,i=void 0,r=0;r<n;++r)if(e(i=t[r]))return i;return null}function Dn(t,e,n){t.get_history().do_oper(e,function(e){for(var i=t.get_selected(),r=0;r<i.length;++r)n(i[r],e);t.draw()})}function Ln(t,e){for(var n=t.get_selected(),i=0;i<n.length;++i){var r=n[i];if(r instanceof e)return r}return null}function Xn(t,e,n){if(!In(t)){var i=t.get_history(),r=[];return i.do_oper(e,function(){for(var e=t.get_selected(),a=0;a<e.length;++a){var s=n(e[a],i);s instanceof Xo&&r.push(s)}}),t.select_objs(r),t.draw(),r}}function Yn(t,e){t.append_obj(e),t.select_objs([e]),t.draw()}function Un(t){return fi(t)>0}function Hn(t){Un(t)&&Xn(t,"构造度量",function(e,n){if(!Zt(e))return null;var i=vi(t),r=new Rl(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function Wn(t){return 2==Mn(t)}function Vn(t){Wn(t)&&t.get_history().do_oper("构造测量距离",function(e){var n=t.get_selected(),i=n[0],r=n[1],a=vi(t),s=new Fl(i,r,a.x,a.y);e.add_create_rec(s),Yn(t,s)})}function Gn(t){return di(t)>0}function Jn(t){Gn(t)&&Xn(t,"构造测量周长",function(e,n){var i=vi(t),r=new Dl(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function Qn(t){return yi(t)>0}function Kn(t){Qn(t)&&Xn(t,"构造测量圆周长",function(e,n){
var i=vi(t),r=new Ll(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function Zn(t){return 3==Mn(t)}function ti(t){Zn(t)&&t.get_history().do_oper("构造测量角度",function(e){var n=t.get_selected(),i=vi(t),r=void 0;if(3!=Mn(t))throw new Error("todo: Angles");var a=n[0],s=n[1],o=n[2];r=new Xl(a,s,o,i.x,i.y),e.add_create_rec(r),Yn(t,r)})}function ei(t){return gi(t)>0}function ni(t){ei(t)&&Xn(t,"构造测量面积",function(e,n){var i=vi(t),r=new Ul(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function ii(t){return bi(t)>0}function ri(t){ii(t)&&Xn(t,"构造测量弧度角",function(e,n){var i=vi(t),r=new Hl(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function ai(t){return mi(t)>0}function si(t){ai(t)&&Xn(t,"构造测量弧长",function(e,n){var i=vi(t),r=new Wl(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function oi(t){return pi(t,Kt)>0}function li(t){oi(t)&&Xn(t,"构造测量半径",function(e,n){var i=vi(t),r=new Vl(e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r})}function ui(t){return null!=xi(t)||null!=ki(t)}function _i(t){t.get_history().do_oper("构造测量比值",function(e){var n=vi(t),i=void 0,r=xi(t);if(r)i=new Gl(r[0],r[1],n.x,n.y);else{var a=ki(t);if(!a)return;i=new Jl(a[0],a[1],a[2],n.x,n.y)}e.add_create_rec(i),Yn(t,i)})}function hi(t){return pi(t,function(t){return t instanceof al})>0}function ci(t){hi(t)&&Xn(t,"构造测量点的值",function(e,n){if(e instanceof al){var i=vi(t),r=new Ql(e.path,e,i.x,i.y);return n.add_create_rec(r),t.append_obj(r),r}return null})}function pi(t,e){for(var n=t.get_selected(),i=0,r=0;r<n.length;++r){if(!e(n[r]))return-1;++i}return i}function fi(t){return pi(t,Zt)}function vi(t){var e=t._last_meas_pos;e||(t._last_meas_pos=e={x:10,y:10});var n={x:e.x,y:e.y};return e.y+=24,e.y>t.height-20&&(e.x+=100,e.y=10,e.x>t.width-40&&(e.x=20)),n}function di(t){return pi(t,Vt)}function yi(t){return pi(t,Gt)}function gi(t){return pi(t,Jt)}function bi(t){return pi(t,Qt)}function mi(t){return pi(t,function(t){return Qt(t)&&Kt(t)})}function xi(t){var e=t.get_selected();if(2!=e.length)return null;var n=e[0],i=e[1];return Zt(n)&&Zt(i)?[n,i]:null}function ki(t){var e=t.get_selected();if(3!=e.length)return null;var i=e[0],r=e[1],a=e[2];return i instanceof Qo&&r instanceof Qo&&a instanceof Qo&&n(i,r,a)?[i,r,a]:null}function wi(t){return t.get_history().can_undo()}function ji(t){t.get_history().undo(),t.draw()}function Oi(t){return t.get_history().can_redo()}function Pi(t){t.get_history().redo(),t.draw()}function $i(t){return!In(t)&&Bn(t)}function Ai(t){In(t)||(nn(t),t.draw())}function Si(t){In(t)||(t.clear(),t.draw())}function Ti(t){var e=t.get_selected().slice(0);e.length&&(t.get_history().do_oper("创建显示隐藏按钮",function(n){var i=vi(t),r=new au(i.x,i.y,"显示对象|隐藏对象",e);r.pad=t,r.update(),t.append_obj(r),n.add_create_rec(r)}),t.draw())}function Ei(t){var e=t.get_selected().slice(0);e.length&&(t.get_history().do_oper("创建闪烁按钮",function(n){var i=vi(t),r=new su(i.x,i.y,"闪烁对象",e);r.pad=t,r.update(),t.append_obj(r),n.add_create_rec(r)}),t.draw())}function zi(t){return Rn(t,al)>0}function Ci(t){if(zi(t)){for(var e=t.get_selected().slice(0),n=[],i=[],r=[],a=[],s=0;s<e.length;++s){var o=e[s];n.push(o),n.push(o.path),i.push(3),r.push(!1),a.push(0)}var l=vi(t),u=new ou(l.x,l.y,"动画点",n,i,r,a);u.pad=t,u.update(),t.append_obj(u),t.draw()}}function Ii(t){return t.obj_count>0}function Bi(t){t.select_all(),t.draw()}function Ni(t){var e=(arguments.length>1&&void 0!==arguments[1]&&arguments[1],t.get_selected()[0]);if(!e)return null;var n=new Lu(t,e);return n.open(),n}function Mi(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=t.children("option"),r=i.length,a=0;a<r;++a){if(i[a].value==e)return void t.prop("selectedIndex",a)}t.prop("selectedIndex",n)}function qi(t,e){return t.prop("selectedIndex")<0?e:parseInt(t.val())}function Ri(t,e){function n(){l=$("#mobj_text"),u=$("#mobj_show"),_=$("#mobj_sample"),$("#mlabel_form").submit(i),l.change(s).keyup(s),o.dialog({title:"设置多个对象的标签",modal:!0,width:400,height:220,dialogClass:"prop-dialog",close:a,buttons:{"确定":i,"取消":r}})}function i(){var t=l.val().trim(),n=u.prop("checked");o.dialog("close"),e(t,n)}function r(){o.dialog("close")}function a(t){Ve(t),o.dialog("destroy"),o.empty()}function s(){var t=l.val().trim();if(t&&t!==h){h=t;var e=gu.parse_text(t),n=e.next()+","+e.next()+","+e.next()+","+e.next()+","+e.next()+", ...";_.text(n)}}var o=He();We("../data/dialog/mobj_label_dialog.js",function(t,e){o.html(e),n()});var l=void 0,u=void 0,_=void 0,h=null}function Fi(t){function e(){u.dialog({title:"构造列表",modal:!1,width:520,height:300,dialogClass:"prop-dialog",open:n,close:i,buttons:{"关闭":r}})}function n(){for(var e=$("#cons_list_table"),n=t.head_obj;n;n=n.next_obj){var i=$("<tr></tr>"),r=$("<td></td>"),a=$("<td></td>"),u=$("<td></td>");r.text("#"+n.obj_id).addClass("numcol").appendTo(i),a.html(n.visible?"可见":"否").addClass("viscol").click(s).appendTo(i),u.html(n.type_cname+n.get_disp_name()).hover(o,l).addClass("descol").appendTo(i),i.attr("gobj_id",n.obj_id).appendTo(e)}}function i(){}function r(){u.dialog("close")}function a(e){var n=$(e),i=n.parent(),r=i.attr("gobj_id"),a=t.obj_by_id[r];return a&&a._in_pad?a:null}function s(){var e=$(this),n=a(e);n&&(n.visible=!n.visible,e.html(n.visible?"可见":"否"),t.draw())}function o(){var e=a(this);e&&(_=e,h=e.visible,e.visible=!0,e.highlight=!0,t.draw())}function l(){var e=a(this);e&&(_&&(_.visible=h),e.highlight=!1,t.draw())}var u=He();We("../data/dialog/cons_list_dialog.js",function(t,n){console.log("todo: show_cons_list_dialog() name: ",t),u.html(n),e()});var _=null,h=!1}function Di(t){return Nn(t)>0}function Li(t,e){var n={pts_1:1,pts_2:2,pts_3:3,pts_4:4}[e]||1,i=Y(n);Dn(t,"设置点型",function(t,e){if(t instanceof Qo){var n=t.get_point_size();n!=i&&(t.set_point_size(i),e.add_update_rec(t,"point_size",n,i))}})}function Xi(t){return null!=Fn(t.get_selected(),Ki)}function Yi(t,e){var n={lnw_1:1,lnw_2:2,lnw_3:3,lnw_4:4}[e],i=H(n);Dn(t,"设置线宽",function(t,e){if(Ki(t)){var n=t.get_line_width();n!=i&&(e.add_update_rec(t,"line_width",n,i),t.set_line_width(i))}})}function Ui(t,e){var n={lns_0:0,lns_1:1,lns_2:2}[e]||0;Dn(t,"设置线型",function(t,e){if(Ki(t)){var i=t.get_line_style();i!=n&&(e.add_update_rec(t,"line_style",i,n),t.set_line_style(n))}})}function Hi(t){return null!=Fn(t.get_selected(),Zi)}function Wi(t,e){Dn(t,"设置颜色",function(t,n){if(Zi(t)){var i=t.get_color();i!=e&&(n.add_update_rec(t,"color",i,e),t.set_color(e))}})}function Vi(t){t.get_selected().forEach(function(t){t.visible&&t.hide()}),t.unselect_all(),t.draw()}function Gi(t){t.each(function(t){t.visible||null===t.visible||t.show()}),t.draw()}function Ji(t){t.label_dlg()}function Qi(t){Fi(t)}function Ki(t){return t&&K(t.set_line_width)}function Zi(t){return t&&K(t.set_color)}function tr(t){return!In(t)&&zr(t)>0}function er(t){Ir(t,"构造对象上的点",function(e,n){var i=e.random_oopt();return t.append_obj(i),n.add_create_rec(i),i})}function nr(t){return!In(t)&&Cr(t)>0}function ir(t){Ir(t,"构造中点",function(e,n){if(!(e instanceof pl))return null;var i=ll.find_midpt(e);return i?i.visible=!0:(i=ll.new_midpt(e),t.append_obj(i),n.add_create_rec(i)),i})}function rr(t){return!In(t)&&null!=Nr(t.get_selected())}function ar(t){if(!In(t)){var e=Nr(t.get_selected());if(e){var n=e.intp;G(n)||(n=[n]);var i=[];t.get_history().do_oper("构造交点",function(e){for(var r=0;r<n.length;++r){var a=n[r],s=ll.find_intpt(a.obj1,a.obj2,a.isel);s?s.visible=!0:(s=ll.new_intpt(a.obj1,a.obj2,a.isel),t.append_obj(s),e.add_create_rec(s)),i.push(s)}}),t.select_objs(i),t.draw()}}}function sr(t){return!In(t)&&Nn(t)>=2}function or(t){sr(t)&&Mr(t,bl.find_seg,bl.new_seg,"线段")}function lr(t){sr(t)&&Mr(t,bl.find_ray,bl.new_ray,"线段")}function ur(t){sr(t)&&Mr(t,bl.find_sline,bl.new_sline,"线段")}function _r(t){return!In(t)&&Rr(t)}function hr(t){if(_r(t)){var e=qr(t);e&&Ir(t,"构造平行线",function(n,i){if(!(n instanceof Qo))return null;var r=bl.find_paral(e,n);return r?r.visible=!0:(r=bl.new_paral(e,n),t.append_obj(r),i.add_create_rec(r)),r})}}function cr(t){if(_r(t)){var e=qr(t);e&&Ir(t,"构造垂线",function(n,i){if(!(n instanceof Qo))return null;var r=bl.find_perpl(e,n);return r?r.visible=!0:(r=bl.new_perpl(e,n),t.append_obj(r),i.add_create_rec(r)),r})}}function pr(t){return!In(t)&&(3==Nn(t)||Fr(t))}function fr(t){pr(t)&&t.get_history().do_oper("构造角平分线",function(e){function n(n,i,r){var a=bl.find_bisl(n,i,r);return a?a.visible=!0:(a=bl.new_bisl(n,i,r),t.append_obj(a),e.add_create_rec(a)),a}var i=t.get_selected(),r=void 0;if(3==Nn(t))r=n(i[0],i[1],i[2]);else{var a=Fr(t,!0);r=n(a[0],a[1],a[2])}t.select_objs([r]),t.draw()})}function vr(t){return!In(t)&&2==Nn(t)}function dr(t){if(vr(t)){var e=t.get_selected(),n=e[0],i=e[1];t.get_history().do_oper("构造圆",function(e){var r=xl.find_circle(n,i);r?r.visible=!0:(r=new xl(n,i),t.append_obj(r),e.add_create_rec(r)),t.select_objs([r]),t.draw()})}}function yr(t){return!In(t)&&null!=Yr(t)}function gr(t){if(!In(t)){var e=Yr(t);if(e){var n=e[0],i=e[1];t.get_history().do_oper("构造圆",function(e){var r=kl.fd_circ_r(n,i);r?r.visible=!0:(r=new kl(n,i),t.append_obj(r)),t.select_objs([r]),t.draw()})}}}function br(t){return!In(t)&&null!=Ur(t)}function mr(t){if(!In(t)){var e=Ur(t);if(e){var n=e[0],i=e[1],r=e[2];t.get_history().do_oper("构造过三点弧",function(e){var a=new Sl(n,i,r);e.add_create_rec(a),n.line_style!=Ys.dashed&&(e.add_update_rec(n,"line_style",n.line_style,Ys.dashed),n.line_style=Ys.dashed),Yn(t,a)})}}}function xr(t){return!In(t)&&3==Mn(t)}function kr(t){xr(t)&&t.get_history().do_oper("构造过三点弧",function(e){var n=t.get_selected(),i=n[0],r=n[1],a=n[2],s=new Tl(i,r,a);e.add_create_rec(s),Yn(t,s)})}function wr(t){return!In(t)&&Bn(t)}function jr(t){return!In(t)&&Mn(t)>2}function Or(t){jr(t)&&t.get_history().do_oper("构造多边形",function(e){var n=t.get_selected(),i=new Il(n);i.color=w(),e.add_create_rec(i),Yn(t,i)})}function Pr(t){if(In(t))return!1;var e=t.get_selected();return 1==e.length&&e[0]instanceof sl}function $r(t){Pr(t)&&t.get_history().do_oper("构造圆内部",function(e){var n=t.get_selected(),i=n[0],r=new jl(i);r.color=w(),e.add_create_rec(r),Yn(t,r)})}function Ar(t){if(In(t))return!1;var e=t.get_selected();return 1==e.length&&e[0]instanceof Al}function Sr(t){Ar(t)&&t.get_history().do_oper("构造扇形",function(e){var n=t.get_selected(),i=n[0],r=new zl(i);r.color=w(),e.add_create_rec(r),Yn(t,r)})}function Tr(t){Ar(t)&&t.get_history().do_oper("构造弓形",function(e){var n=t.get_selected(),i=n[0],r=new Cl(i);r.color=w(),e.add_create_rec(r),Yn(t,r)})}function Er(t){return t.path_type}function zr(t){for(var e=t.get_selected(),n=0,i=e.length,r=0;r<i;++r)Er(e[r])&&++n;return n}function Cr(t){return qn(t,pl)}function Ir(t,e,n){if(!In(t)){var i=t.get_history(),r=[];return i.do_oper(e,function(){for(var e=t.get_selected(),a=0;a<e.length;++a){var s=n(e[a],i);s instanceof Xo&&r.push(s)}}),t.select_objs(r),t.draw(),r}}function Br(t,e){return t instanceof il&&e instanceof il?Et(t,e):t instanceof il&&e instanceof sl?zt(t,e):t instanceof sl&&e instanceof il?zt(e,t):t instanceof sl&&e instanceof sl?Ct(t,e):null}function Nr(t){if(2!=t.length)return null;var e=t[0],n=t[1],i=Br(e,n);return i&&i.length?{target:[e,n],intp:i}:null}function Mr(t,e,n,i){var r=[];t.get_history().do_oper("构造"+i,function(i){for(var a=t.get_selected(),s=a.length,o=0;o<s&&(1!=o||2!=s);++o){var l=a[o],u=o+1==s?a[0]:a[o+1],_=e(l,u);_?_.visible=!0:(_=n(l,u),t.append_obj(_),i.add_create_rec(_)),r.push(_)}}),t.select_objs(r),t.draw()}function qr(t){return Ln(t,il)}function Rr(t){for(var e=t.get_selected(),n=0,i=0,r=0;r<e.length;++r)if(e[r]instanceof il)++n;else{if(!(e[r]instanceof Qo))return!1;++i}return 1==n&&i>0}function Fr(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=t.get_selected();if(n.length>3||n.length<2)return!1;for(var i=null,r=null,a=null,s=0;s<n.length;++s){var o=n[s];if(o instanceof Qo){if(null!=a)return!1;a=o}else if(o instanceof il)if(null==i)i=o;else{if(null!=r)return!1;r=o}}if(null==i||null==r)return!1;if("sline"==i.sub_type||"perpl"==i.sub_type||"paral"==i.sub_type)return!1;if("sline"==r.sub_type||"perpl"==r.sub_type||"paral"==r.sub_type)return!1;var l=Lr(i,r);return null!=l&&((!a||a==l)&&(!e||[Xr(t,i,l),l,Xr(t,r,l)]))}function Dr(t){return"segment"==t.sub_type?[t.p1,t.p2]:"ray"==t.sub_type?[t.p1]:"bisl"==t.sub_type?[t.p1]:(console.error("invalid sub_type"),null)}function Lr(t,e){var n=Dr(t),i=Dr(e);if(null==n||null==i)return null;for(var r=0;r<n.length;++r)for(var a=0;a<i.length;++a)if(n[r]==i[a])return n[r];return null}function Xr(t,e,n){if("segment"==e.sub_type)return e.p1==n?e.p2:e.p1;if("ray"==e.sub_type)return e.p2;var i=e.children();if(null!=i)for(var r=0;r<i.length;++r){var a=i[r];if(a instanceof Qo&&a!=n)return a}var s=ll.new_oopt(e,1.2+Es());return t.append_obj(s),t.get_history().add_create_rec(s),s}function Yr(t){var e=t.get_selected();if(2!=e.length)return null;var n=e[0],i=e[1];return"segment"==n.sub_type&&"point"==i.type?[i,n]:"point"==n.type&&"segment"==i.sub_type?[n,i]:null}function Ur(t){var e=t.get_selected();if(3!=e.length)return null;for(var n=null,i=null,r=null,a=0;a<3;++a){var s=e[a];if(s instanceof sl){if(n)return null;n=s}else{if(!(s instanceof Qo))return null;if(i){if(r)return null;r=s}else i=s}}return n&&i&&r&&n.pt_on(i)&&n.pt_on(r)?[n,i,r]:null}function Hr(t,e){function n(t,e){h.html(e),i()}function i(){$("#xform_dlg").submit(l),h.dialog({title:"平移变换",modal:!0,width:400,height:300,dialogClass:"prop-dialog",open:a,close:_,buttons:{"确定":l,"取消":u}})}function r(){var e=t.get_xlate_vec();return!!e&&(e.pS._in_pad&&e.pE._in_pad)}function a(){if($("#xlate_ord2").click(s),$("#xlate_ord3").click(o),r()){$("#xlate_ord3").prop("disabled",!1).prop("checked",!0);var e=t.get_xlate_vec(),n=e.pS,i=e.pE;$("#xvec_from_div").text("点 "+n.get_disp_name(1)),$("#xvec_to_div").text("点 "+i.get_disp_name(1)),o()}else $("#xlate_val1").select().focus()}function s(){$("#xval_div").show(),$("#yval_div").show(),$("#xvec_from").hide(),$("#xvec_to").hide()}function o(){$("#xval_div").hide(),$("#yval_div").hide(),$("#xvec_from").show(),$("#xvec_to").show()}function l(){var t=$("#xlate_ord2").prop("checked"),n=$("#xlate_ord3").prop("checked"),i=$("#xlate_xunit1").prop("checked")?"cm":"px",r=$("#xlate_yunit1").prop("checked")?"cm":"px",a=parseFloat($("#xlate_val1").val().trim()),s=parseFloat($("#xlate_val2").val().trim());if(h.dialog("close"),!t||!isNaN(a)&&!isNaN(s)){"cm"==i&&(a*=Cs.PIX2CM),"cm"==r&&(s*=Cs.PIX2CM);return e(a,s,{ord2:t,ord3:n,dx:a,dy:s}),!1}}function u(){h.dialog("close")}function _(t){Ve(t),h.dialog("destroy"),h.empty()}var h=He();We("../data/dialog/xlate_dialog.js",n)}function Wr(t,e){(new Xu).show(e)}function Vr(t){return 1==Mn(t)}function Gr(t){if(Vr(t)){var e=t.get_selected()[0];t.set_rotate_center(e,!0),t.unselect_obj(e)}}function Jr(t){return 1==Rn(t,il)}function Qr(t){if(Jr(t)){var e=t.get_selected()[0];t.set_mirror_line(e,!0),t.unselect_obj(e)}}function Kr(t){return 2==Mn(t)}function Zr(t){if(Kr(t)){var e=t.get_selected(),n=e[0],i=e[1];t.set_xlate_vec(n,i)}}function ta(t){return _a(t,null)}function ea(t){Hr(t,function(e,n,i){i.ord2?na(t,e,n):ia(t),t.draw()})}function na(t,e,n){ua(t,new Ho(e,n))}function ia(t){var e=t.get_xlate_vec();if(e&&e.pS._in_pad&&e.pE._in_pad){ua(t,new Wo(e.pS,e.pE))}}function ra(t){var e=t.get_rotate_center();return!(!e||!e._in_pad)&&_a(t,e)}function aa(t){ra(t)&&Wr(t,function(e){var n=t.get_rotate_center();if(n){var i=new Vo(n,e.rad,e.scale);ua(t,i),t.draw()}})}function sa(t){var e=t.get_mirror_line();return!(!e||!e._in_pad)&&_a(t,e)}function oa(t){if(sa(t)){var e=t.get_mirror_line();ua(t,new Jo(e)),t.draw()}}function la(t){return t&&K(t.xform_obj)}function ua(t,e){t.get_history().do_oper("创建变换对象",function(n){var i=[];t.get_selected().forEach(function(r){if(la(r)){var a=r.xform_obj(e);n.add_create_rec(a),t.append_obj(a),i.push(a)}}),t.select_objs(i)})}function _a(t,e){for(var n=t.get_selected(),i=n.length,r=0,a=0;a<i;++a){var s=n[a];if(!la(s))return!1;if(s===e)return!1;++r}return r>0}function ha(t){return null!=t.find(function(t){return!t.visible&&null!==t.visible})}function ca(t){t.preventDefault(),t.stopPropagation()}function pa(t){Ye(t),ca(t)}function fa(t){return t._mouse_tool||t.select_tool("select"),t._mouse_tool}function va(t,e,n){if(t.length<2)return null;for(var i=null,r=t.length-1;r>=0;--r)for(var a=r-1;a>=0;--a){var s=ga(t[r],t[a],e,n);s&&((!i||i.d2>s.d2)&&(i=s))}return i}function da(t){return"line"==t.type}function ya(t){return"circle"==t.type}function ga(t,e,n,i){if(da(t)){if(da(e))return ma(t,e,n,i);if(ya(e))return xa(t,e,n,i)}else if(ya(t)){if(da(e))return xa(e,t,n,i);if(ya(e))return ka(t,e,n,i)}return null}function ba(t){if(!t)return!1;if(!t.length)return!1;for(var e=0;e<t.length;++e)if(t[e].exist)return!0;return!1}function ma(t,e,n,i){var r=Et(t,e);if(!ba(r))return null;var a=r[0],s=n-a.x,o=i-a.y;return a.d2=s*s+o*o,a.d2>Cs.INTS_D2?null:a}function xa(t,e,n,i){return wa(zt(t,e),n,i)}function ka(t,e,n,i){return wa(Ct(t,e),n,i)}function wa(t,e,n){if(!ba(t))return null;for(var i=null,r=0;r<t.length;++r){var a=t[r];a.exist&&(a.d2=(a.x-e)*(a.x-e)+(a.y-n)*(a.y-n),a.d2>Cs.INTS_D2||(null==i||i.d2>a.d2)&&(i=a))}return i}function ja(t,e){if(!t.exist||!t.visible)return!1;if(e.is_on_line(t))return!0;var n=t.point_proj_info(e.x,e.y);return n.d<fs&&n.in_range}function Oa(t,e){if(!t.exist||!t.visible)return!1;if(t.rp===e)return!0;if(e.type==ll.POINT_ON_OBJ&&e.path===t)return!0;if(e.type==ll.INTER_POINT&&(e.obj1===t||e.obj2===t))return!0;var n=e.x-t.op.x,i=e.y-t.op.y,r=ms(n*n+i*i);return bs(r-t.get_radius())<fs}function Pa(t,e){for(var n=[],i=t.head_obj;i;i=i.next_obj)i instanceof il&&ja(i,e)&&n.push(i);return n}function $a(t,e){for(var n=[],i=t.head_obj;i;i=i.next_obj)i instanceof Qo&&ja(e,i)&&n.push({t:null,pt:i});for(var r=0;r<n.length;++r)n[r].t=e.calc_pt_t(n[r].pt);return n.sort(function(t,e){return t.t-e.t}),n}function Aa(t,e){function n(t,e){return t.a<e.a?-1:t.a>e.a?1:0}var i=Pa(t,e);if(!i||!i.length)return null;var r=void 0,a=[];for(r=0;r<i.length;++r)Ta(a,i[r],e);for(r=0;r<a.length;++r){var s=a[r];s.a=u(s.x,s.y)}return a.sort(n),a}function Sa(t,e,n){function i(){return"{r t="+this.t+", α="+this.a+", dir="+this.dir+", v="+this.x+","+this.y+"}"}return t.toString=i,t.line=e,t.pt=n,t.a=0,1==t.dir?(t.x=e.p2.x-e.p1.x,t.y=e.p2.y-e.p1.y):(t.x=e.p1.x-e.p2.x,t.y=e.p1.y-e.p2.y),t}function Ta(t,e,n){var i=e.calc_pt_t(n),r=e.t_range;i<=r.min?t.push(Sa({t:0,dir:1},e,n)):i>=r.max?t.push(Sa({t:1,dir:-1},e,n)):(t.push(Sa({t:i,dir:1},e,n)),t.push(Sa({t:i,dir:-1},e,n)))}function Ea(t,e){var n=void 0,i=t.length;for(n=0;n<i&&!(t[n].a>=e);++n);var r=void 0,a=void 0;return n<i?(r=0==n?t[i-1]:t[n-1],a=t[n]):(r=t[i-1],a=t[0]),[r,a]}function za(t,e){var n=t.x+e.x,i=t.y+e.y;return new ll(n,i)}function Ca(t,e){for(var n=t.length-1;n>=0;--n)if(t[n].t<e)return n;return-1}function Ia(t,e){for(var n=0;n<t.length;++n)if(t[n].t>e)return n;return-1}function Ba(t){return t.pad.filter(function(e){return"line"==e.type?ja(e,t):"circle"==e.type&&Oa(e,t)})}function Na(t,e,n){var i=function(){for(var t=Ma(),e=0;e<t.length;++e){var n=t[e],i=bs(n.x+n.y+2*Do.WH)+1;n.v=.01/(i*i)}return t}();!function(){for(var t=0;t<n.length;++t){var r=n[t];"line"==r.type?Ra(e,r,i):"circle"==r.type&&Fa(e,r,i)}}();var r=function(){for(var t=null,e=0;e<i.length;++e){var n=i[e];(!t||t.v>n.v)&&(t=n)}return t}(),a=Da(0,0,Do.WH+t.width/2,Do.WH+t.height/2,100*r.x,100*r.y);t.auto_pos=!0,t.pos[0]=a[0]-t.width/2,t.pos[1]=a[1]-t.height/2,e.calc_label_pos(t)}function Ma(){var t=[],e=Do.WH,n=Do.STEP,i=0,r=void 0,a=void 0;for(r=-e;r<e;++i,r+=n)t.push({i:i,x:r,y:-e,v:0});for(a=-e;a<e;++i,a+=n)t.push({i:i,x:e,y:a,v:0});for(r=e;r>-e;++i,r-=n)t.push({i:i,x:r,y:e,v:0});for(a=Do.WH;a>-e;++i,a-=n)t.push({i:i,x:-e,y:a,v:0});return t}function qa(t,e){return t>vs&&(t-=vs),t>vs/2&&(t-=vs/2),t>vs/4&&(t-=vs/4),e/2/ks(t)}function Ra(t,e,n){function i(t){var e=1-xs(t/2);return e<0?0:e}function r(t){return t<1?t*t:t<2?ms(t):1.415}function a(t,e){for(var r=0;r<n.length;++r){var a=n[r],s=s_[r].a,o=h(s,e);a.v+=i(o)*t}}var s=e.p2.x-e.p1.x,o=e.p2.y-e.p1.y,l=ms(s*s+o*o),c=_(s,o),p=e.calc_pt_t(t),f=qa(c,Do.WH),v=e.t_range;if(p<v.max){var d=void 0;d=v.max===Number.POSITIVE_INFINITY?2:(v.max-p)*l/f,a(r(d),c)}if(p>v.min){var y=void 0;y=v.max===Number.NEGATIVE_INFINITY?r:(p-v.min)*l/f;var g=u(-s,-o);a(r(y),g)}}function Fa(t,e,n){for(var i=e.get_radius(),r=e.op.x-t.x,a=e.op.y-t.y,s=0;s<n.length;++s){var o=n[s],l=o.x-r,u=o.y-a,_=ms(l*l+u*u)-i,h=0;h=_>=0?10/(Ps(_/2)+9):5/(Ps(-_/4)+9),o.v+=h}}function Da(t,e,n,i,r,a){var s=t-n,o=e-i,l=t+n,u=e+i;if(r>=s&&r<=l&&a>=o&&a<=u)return[r,a];if(r==t)return a<e?[t,o]:[t,u];var _=(a-e)/(r-t),h=r<t?s:l,c=(h-t)*_+e;return c>=o&&c<=u?[h,c]:(c=a<e?o:u,h=(c-e)/_+t,[h,c])}function La(t){return u_.hasOwnProperty(t)}function Xa(t){return null==t?"<null>":J(t)?t:K(t.get_name)?t.get_name():t.name?t.name:t instanceof Xo?t.get_label():t.toString()}function Ya(t){return t instanceof d_}function Ua(){return g_||(g_=Ha()),g_}function Ha(){function t(t,n){e.add_rule(new __(t,n))}var e=new y_(null);return t("object",{error:"检查错误.",false:"判定失败."}),t("point",{unlabel:"请标记出点 $x.",errtype:"对象 $x 不是点类型.",multi:"多个点被标记为 $x.",invisible:"点 $x 不可见.",unexist:"点 $x 不存在."}),t("line",{unlabel:"请标记出线 $x.",errtype:"对象 $x 不是线类型.",multi:"多个线被标记为 $x.",invisible:"线 $x 不可见.",unexist:"线 $x 不存在."}),t("seg",{unlabel:"请标记出线段 $x.",errtype:"对象 $x 不是线段类型.",multi:"多个线段被标记为 $x.",invisible:"线段 $x 不可见.",unexist:"线段 $x 不存在."}),t("ray",{unlabel:"请标记出射线 $x.",errtype:"对象 $x 不是射线类型.",multi:"多个射线被标记为 $x.",invisible:"射线 $x 不可见.",unexist:"射线 $x 不存在."}),t("circle",{unlabel:"请标记出圆 $x.",errtype:"对象 $x 不是圆.",multi:"多个圆被标记为 $x.",invisible:"圆 $x 不可见.",unexist:"圆 $x 不存在."}),t("amark",{unlabel:"请标记出角 $x.",errtype:"对象 $x 不是一个角标记.",multi:"多个角标记的名字为 $x.",invisible:"角标记 $x 不可见.",unexist:"角标记 $x 不存在."}),t("judge",{false:"判定结果为假."}),t("func",{false:"判定结果为假."}),t("coll",{false:"点 $x,$y,$z 不共线."}),t("not_coll",{false:"点 $x 不在 $y$z 线之外."}),t("para",{false:"线 $x 不平行于线 $y."}),t("perp",{false:"线 $x 不垂直于线 $y."}),t("intpt_ll",{false:"点 $x 不是线 $y 和线 $z 的交点."}),t("midpt",{false:"点 $x 不是 $y,$z 的中点."}),t("cycl",{false:"四点 $x,$y,$z,$u 不共圆."}),t("eqdist",{false:"距离 $x 不等于 $y."}),t("eqang",{false:"∠$x 不等于 ∠$y."}),t("con_tri",{false:"△$x 不全等于 △$y."}),t("sim_tri",{false:"△$x 不相似于 △$y."}),t("equ_tri",{false:"△$x 不是等边三角形."}),t("ang_is",{false:"∠$x 不等于 $y°."}),t("tri",{false:"点 $x$y$z 共线, 不能构成三角形."}),t("acute_tri",{false:"三角形 $x$y$z 不是锐角三角形."}),t("right_tri",{false:"三角形 $x$y$z 不是直角三角形."}),t("obtuse_tri",{false:"三角形 $x$y$z 不是钝角三角形."}),t("amark",{unexist:"∠$x$y$z 的标记不存在."}),t("lmark",{unexist:"线 $x$y 之间的标记不存在."}),t("mk_ss",{false:"线标记样式不同."}),t("ratio_2",{false:"比例 $x:$y 不等于 $z:$u"}),t("ratio",{false:"比例 $x:$y 不等于 $z:$u"}),t("is_square",{false:"四边形 $x$y$z$u 不是正方形."}),t("is_rect",{false:"四边形 $x$y$z$u 不是长方形."}),t("is_diam",{false:"四边形 $x$y$z$u 不是菱形."}),t("is_paralg",{false:"四边形 $x$y$z$u 不是平行四边形."}),t("at_ray",{false:"点 $x 不在射线 $y$z 上."}),t("at_seg",{false:"点 $x 不在线段 $y$z 上."}),t("intpt",{false:"点 $x 不是交点."}),t("bisln",{false:"$x 不是 ∠$y 的角平分线."}),e}function Wa(t){return Ya(t)||J(t)||Q(t)}function Va(){throw new SyntaxError("Incorrect parameter count.")}function Ga(t,e,n){var i=void 0,r=t.length;if(1===r)return t[0];var a=void 0;for(i=0;i<r;++i)if(a=t[i],a.is_sline(e,n))return a;for(i=0;i<r;++i)if(a=t[i],a.as_sline(e,n))return a;for(i=0;i<r;++i){if(a=t[i],a.as_ray(e,n))return a;if(a.as_ray(n,e))return a}return a[0]}function Ja(t,e){return t===e||(t instanceof d_&&t.name===e||t instanceof m_&&t.name===e)}function Qa(t,e){return bs(t-e)<fs}function Ka(t){return bs(t-Math.PI/2)<fs}function Za(t,e,n,i){var r=c(i,t,e);return!!Ka(r)&&(r=c(t,e,n),!!Ka(r)&&(r=c(e,n,i),!!Ka(r)&&(r=c(n,i,t),!!Ka(r))))}function ts(t,e,n,i,r,a){var s=c(t,e,n),o=c(i,r,a);return!(bs(s-o)>=fs)}function es(t){var e=Number(t);return isNaN(e)&&(e=0),e}function ns(t){return null==t?"":"string"==typeof t?t:t instanceof d_?t.name:t instanceof m_?t.name:String(t)}function is(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];switch(e.length){case 0:return{name:""};case 1:return e[0]}for(var i="",r=0;r<e.length;++r)i+=Xa(e[r]);return{name:i}}function rs(t){return O_[t]}function as(t,e){return t===c_?P_[e]:P_[t]}var ss=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},os=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),ls=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},us=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},_s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},hs=function(){function t(){ss(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this._a=n}return os(t,[{key:"p",value:function(){for(var t=this,e=t._a,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return e.push.apply(e,i),t}},{key:"clear",value:function(){return this._a=[],this}},{key:"append",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this._a.push(t),this}},{key:"append_ln",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this._a.push(t+"\n"),this}},{key:"toString",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this._a.join(t)}},{key:"shrink",value:function(){return this._a=[this.toString()],this}}]),t}(),cs=Function("return this")(),ps=Math,fs=1e-6,vs=ps.PI,ds=2*vs,ys=Number.POSITIVE_INFINITY,gs=Number.NEGATIVE_INFINITY,bs=ps.abs,ms=ps.sqrt,xs=ps.sin,ks=ps.cos,ws=ps.asin,js=ps.acos,Os=ps.atan2,Ps=ps.exp,$s=ps.min,As=ps.max,Ss=ps.round,Ts=ps.floor,Es=ps.random,zs=94.7,Cs={HITTEST_DIST:4,INTS_D2:25,PIX2CM:50,Geo_opt:{},DEF_colors:["#000000","#ff0000","#ff8000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#8a66d9","#800080","#008000","#000080","#800000","#c0854a","#c0c0c0","#808080"],isIE:-1!=navigator.userAgent.indexOf("MSIE"),support_touch:"ontouchend"in document,disable_keydown:!1,have_canvas:!0,DATA_PATH:function(){var t=document.getElementsByTagName("script"),e=t[t.length-1],n=e.attributes.src;n&&(n=n.value),n||(n=e.src);var i=n.lastIndexOf("/"),r=n.lastIndexOf("\\");return-1==i&&-1==r?"../data/":(i<r&&(i=r),n.substring(0,i+1)+"../data/")}(),_load_script_callback:function(){}};cs.GPad=Cs;var Is=Object.freeze([]),Bs=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ss(this,t),this.left=e,this.top=n,this.right=i,this.bottom=r}return os(t,[{key:"width",value:function(){return this.right-this.left}},{key:"height",value:function(){return this.bottom-this.top}},{key:"is_empty",value:function(){return this.right<=this.left||this.bottom<=this.top}},{key:"normalize",value:function(){var t=this;if(t.left>t.right){var e=t.left;t.left=t.right,t.right=e}if(t.top>t.bottom){var n=t.top;t.top=t.bottom,t.bottom=n}}}]),t}();Bs.EMPTY=Object.freeze(new Bs(0,0,0,0));var Ns=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};ss(this,t),this.id=0,this.opt={},this.width=0,this.height=0,this.rc=new Bs,this.head_obj=null,this.tail_obj=null,this.obj_count=0,this.obj_by_id={},this._last_objid=0,this._events={},this.canvas=null,this.ctx=null,this.paint_q=[],this.point_size=3.5,this._selected_objs=[],this._highlighted_objs=[],this._tmp_objs=[],this._readonly=!1,this.init(e)}return os(t,[{key:"destroy",value:function(){t._notify_hooks(this,t.onDestroy)}},{key:"update",value:function(){this.each(function(t){return t.update()})}},{key:"next_obj_id",value:function(){return++this._last_objid}},{key:"get_object_by_id",value:function(t){return this.obj_by_id.hasOwnProperty(String(t))?this.obj_by_id[t]:null}},{key:"append_obj",value:function(t){t.obj_id||(t.obj_id=this.next_obj_id()),this.insert_after(t,this.tail_obj)}},{key:"find_insert_pos",value:function(t){if(!this.tail_obj)return null;for(var e=null,n=this.head_obj;n;n=n.next_obj)if(!(n.obj_id<0)){if(n.obj_id>t)return e;e=n}return e}},{key:"insert_after",value:function(t,e){var n=this;if(!t||!t.obj_id)throw new Error("Invalid obj");if(t._in_pad)return void console.warn("Object already in pad.");if(t.pad=n,t.on_insert(!1),t._in_pad=!0,n.obj_by_id[t.obj_id]=t,e){if(!e._in_pad)return void console.warn("Prev_obj not in pad.");var i=e.next_obj;t.prev_obj=e,t.next_obj=i,i&&(i.prev_obj=t),e.next_obj=t,n.tail_obj===e&&(n.tail_obj=t),t.s_id=e.s_id+1,n.reset_sid(t)}else{var r=n.head_obj;r?(r.prev_obj=t,t.next_obj=r,t.prev_obj=null,n.head_obj=t,n.reset_sid()):(n.head_obj=n.tail_obj=t,t.prev_obj=t.next_obj=null,t.s_id=1)}++n.obj_count;var a=t.parents();if(a&&a.length)for(var s=0;s<a.length;++s)a[s].add_child(t);n._insert_to_pq(t),t.label&&t.label.update_data(this),t.on_insert(!0)}},{key:"delete_obj",value:function(t){var e=this;t.on_delete(!1),e._remove_from_pq(t);var n=t.parents();if(n&&n.length)for(var i=0;i<n.length;++i)n[i].remove_child(t);var r=t.prev_obj,a=t.next_obj;r?r.next_obj=a:e.head_obj=a,a?a.prev_obj=r:e.tail_obj=r,--e.obj_count,e.reset_sid(r),t._in_pad=!1,delete e.obj_by_id[t.obj_id],t.on_delete(!0)}},{key:"_insert_to_pq",value:function(t){var e=this,n=e.paint_q,i=0,r=n.length-1;if(-1===r)return void n.push(t);for(;i<=r;){var a=i+r>>1,s=n[a];if(s===t)return;T(s,t)<0?i=a+1:r=a-1}n.splice(i,0,t)}},{key:"_remove_from_pq",value:function(t){var e=this,n=e.paint_q,i=n.lastIndexOf(t);i<0||n.splice(i,1)}},{key:"each",value:function(t){for(var e=this.head_obj;e;e=e.next_obj)t(e);return this}},{key:"map",value:function(t){for(var e=[],n=this.head_obj;n;n=n.next_obj)e.push(t(n));return e}},{key:"reduce",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=e,i=this.head_obj;i;i=i.next_obj)n=t(n,i);return n}},{key:"find",value:function(t){for(var e=this.head_obj;e;e=e.next_obj)if(t(e))return e;return null}},{key:"filter",value:function(t){for(var e=[],n=this.head_obj;null!=n;n=n.next_obj)t(n)&&e.push(n);return e}},{key:"filter_objs",value:function(t){for(var e=null,n=0,i=this.head_obj;i;i=i.next_obj)t(i)&&(0==n?e=i:1==n?e=[e,i]:e.push(i),++n);return e}},{key:"reset_sid",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=t?t.s_id:1,n=t||this.head_obj;n;n=n.next_obj)n.s_id=e++}},{key:"append_to_tmp",value:function(t){t.is_temp=!0,this._tmp_objs.push(t),this._insert_to_pq(t)}},{key:"remove_tmp_obj",value:function(t){if(t){t.is_temp=!1,this._remove_from_pq(t);var e=this._tmp_objs.indexOf(t);e<0||this._tmp_objs.splice(e,1)}}},{key:"get_selected",value:function(){return this._selected_objs||[]}},{key:"select_objs",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]||this.unselect_all(),t&&t.length)for(var e=this._selected_objs,n=0;n<t.length;++n){var i=t[n];e.indexOf(i)<0&&e.push(i),i.on_select(!0),i.selected=!0}}},{key:"select_all",value:function(){for(var t=this,e=[],n=t.head_obj;n;n=n.next_obj)n.exist&&n.visible&&(n.on_select(!0),n.selected=!0,e.push(n));return t._selected_objs=e,t}},{key:"unselect_obj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(t)return A(this._selected_objs,t),t.on_select(!1),t.selected=!1,this}},{key:"unselect_all",value:function(){
for(var t=this,e=t._selected_objs,n=e.length,i=0;i<n;++i)e[i].on_select(!1),e[i].selected=!1;return t._selected_objs=[],n}},{key:"highlight_objs",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=this,n=e._highlighted_objs;if(n&&n.length>0)for(var i=0;i<n.length;++i)n[i].highlight=!1;if(t&&t.length){e._highlighted_objs=t.slice(0);for(var r=0;r<t.length;++r)t[r].highlight=!0}else e._highlighted_objs=[];return this}},{key:"get_paint_q",value:function(){return this.paint_q}},{key:"clear_canvas",value:function(){this.ctx&&this.ctx.clearRect(0,0,this.width,this.height)}},{key:"set_key_focus",value:function(){Cs.last_pad_focus=this;try{Cs.isIE?document.body.focus():this.canvas.focus()}catch(t){}}},{key:"auto_label_pos",value:function(){for(var t=this.head_obj;t;t=t.next_obj)"point"==t.type&&t.auto_label_pos()}},{key:"is_readonly",value:function(){return!!this._readonly}},{key:"set_readonly",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._readonly=t,this}},{key:"get_tool",value:function(){return this._mouse_tool}},{key:"get_history",value:function(){return this._history}},{key:"make_name_for",value:function(t){if(!t.get_label_obj().text){var e="";"point"==t.type?e=this.pt_namer.next():"line"==t.type?e=this.ln_namer.next():"circle"==t.type&&(e=this.cir_namer.next()),t.set_label(e,1)}}}],[{key:"_notify_hooks",value:function(t,e){if(t&&e)for(var n=0;n<e.length;++n)e[n].apply(t)}}]),t}();Ns.onCreate=[],Ns.onDestroy=[],Ns.onClear=[];var Ms=Ns.prototype,qs=$.extend,Rs=function t(e,n,i,r){ss(this,t),this.id=e,this.name=n,this.pars=i,this.props=r},Fs={label:{m:"L"},color:{m:"C",n:"color"},point_size:{m:"Q",n:"point_size"},line_width:{m:"Q",n:"line_width"},line_style:{m:"Q",n:"line_style"},white:{m:"P",n:"color",v:"#ffffff"},black:{m:"P",n:"color",v:"#000000"},red:{m:"P",n:"color",v:"#ff0000"},yellow:{m:"P",n:"color",v:"#ffff00"},green:{m:"P",n:"color",v:"#008000"},lime:{m:"P",n:"color",v:"#00ff00"},cyan:{m:"P",n:"color",v:"#00ffff"},blue:{m:"P",n:"color",v:"#0000ff"},magenta:{m:"P",n:"color",v:"#ff00ff"},gray:{m:"P",n:"color",v:"#808080"},navyblue:{m:"P",n:"color",v:"#000080"},dot:{m:"P",n:"point_size",v:1.2},smallPoint:{m:"P",n:"point_size",v:2.5},mediumPoint:{m:"P",n:"point_size",v:3.5},large:{m:"P",n:"point_size",v:5},hairline:{m:"P",n:"line_width",v:.3},lightline:{m:"P",n:"line_width",v:.8},mediumLine:{m:"P",n:"line_width",v:2},thick:{m:"P",n:"line_width",v:4},solid:{m:"P",n:"line_style",v:0},dashed:{m:"P",n:"line_style",v:1},dotted:{m:"P",n:"line_style",v:2},hidden:{m:"P",n:"visible",v:!1},fsize:{m:"Q",n:"font_size"},family:{m:"Q",n:"font_family"},prec:{m:"Q",n:"prec"}},Ds=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f"],Ls={dot:1.2,smallPoint:2.5,mediumPoint:3.5,large:5},Xs={hairline:.3,lightline:.8,mediumLine:2,thick:4},Ys={solid:0,dashed:1,dotted:2,0:"solid",1:"dashed",2:"dotted"},Us=function(){function t(){ss(this,t)}return os(t,[{key:"get_line_width",value:function(){return this.line_width}},{key:"set_line_width",value:function(t){this.line_width=t}},{key:"get_line_style",value:function(){return this.line_style}},{key:"set_line_style",value:function(t){this.line_style=0===t||1===t||2===t?t:0}}]),t}(),Hs={bigopspacing5:.1,bigopspacing4:.6,bigopspacing3:.2,bigopspacing2:.166667,bigopspacing1:.111112,default_rule_thickness:.039999,xHeight:.430555,scriptfactor:.7,scriptscriptfactor:.5,num1:.676508,num2:.393732,num3:.443731,denom1:.685951,denom2:.344841,sup1:.412892,sup2:.362892,sup3:.288889,sub1:.15,sub2:.247217,sup_drop:.386108,sub_drop:.05,axisheight:.25},Ws={D:0,D_P:1,T:2,T_P:3,S:4,S_P:5,SS:6,SS_P:7};Hs.TexStyle=Ws;var Vs={ORD:0,OP:1,BIN:2,REL:3,OPEN:4,CLOSE:5,PUNCT:6,INNER:7};Hs.AtomType=Vs;var Gs=[1,1,1,1,.7,.7,.5,.5],Js=[5,5,5,5,7,7,7,7],Qs=[4,5,4,5,6,7,6,7],Ks=[1,1,3,3,5,5,7,7],Zs=[2,3,4,5,6,7,6,7],to=[3,3,5,5,7,7,7,7],eo=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;ss(this,t),this.ctx=e,this.style=n,this.org_fsize=i,this.size=i*it(n),this.for_label=!1}return os(t,[{key:"string_width",value:function(t,e){return this.ctx.font=e,this.ctx.measureText(t).width}},{key:"get_sub_env",value:function(){var e=rt(this.style);return new t(this.ctx,e,this.org_fsize)}},{key:"get_super_env",value:function(){var e=at(this.style);return new t(this.ctx,e,this.org_fsize)}},{key:"get_num_env",value:function(){var e=ot(this.style);return e===this.style?this:new t(this.ctx,e,this.org_fsize)}},{key:"get_denom_env",value:function(){var e=lt(this.style);return e===this.style?this:new t(this.ctx,e,this.org_fsize)}},{key:"get_cramp_env",value:function(){var e=st(this.style);return e===this.style?this:new t(this.ctx,e,this.org_fsize)}}]),t}(),no=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];ss(this,t),this.family=e,this.bold=n,this.italic=i}return os(t,[{key:"toString",value:function(){var t=this.bold?"bold ":"";return this.italic&&(t+="italic "),t+this.family}}]),t}(),io=new no("Times"),ro=new no("Times New Roman"),ao=new no("Times New Roman",!1,!0),so=new no("Times New Roman",!0,!0),oo=function(){var t={0:{c:"0",w:.5,h:.68},1:{c:"1",w:.5,h:.68},2:{c:"2",w:.5,h:.68},3:{c:"3",w:.5,h:.68},4:{c:"4",w:.5,h:.68},5:{c:"5",w:.5,h:.68},6:{c:"6",w:.5,h:.68},7:{c:"7",w:.5,h:.68},8:{c:"8",w:.5,h:.68},9:{c:"9",w:.5,h:.68},A:{w:.75,h:.683},B:{w:.708,h:.683},C:{w:.722,h:.683},D:{w:.764,h:.683},E:{w:.681,h:.683},F:{w:.653,h:.683},G:{w:.785,h:.683},H:{w:.75,h:.683},I:{w:.361,h:.683},J:{w:.514,h:.683},K:{w:.778,h:.683},L:{w:.625,h:.683},M:{w:.917,h:.683},N:{w:.75,h:.683},O:{w:.778,h:.683},P:{w:.681,h:.683},Q:{w:.778,h:.683,d:.194},R:{w:.736,h:.683},S:{w:.556,h:.683},T:{w:.722,h:.683},U:{w:.75,h:.683},V:{w:.75,h:.683,ic:.0139},W:{w:1.03,h:.683,ic:.0139},X:{w:.75,h:.683},Y:{w:.75,h:.683,ic:.025},Z:{w:.611,h:.683},a:{w:.5,h:.431},b:{w:.556,h:.694},c:{w:.444,h:.431},d:{w:.556,h:.694},e:{w:.444,h:.431},f:{w:.306,h:.694,ic:.0778},g:{w:.5,h:.431,d:.194,ic:.0139},h:{w:.556,h:.694},i:{w:.278,h:.668},j:{w:.306,h:.668,d:.194},k:{w:.528,h:.694},l:{w:.278,h:.694},m:{w:.833,h:.431},n:{w:.556,h:.431},o:{w:.5,h:.431},p:{w:.556,h:.431,d:.194},q:{w:.528,h:.431,d:.194},r:{w:.392,h:.431},s:{w:.394,h:.431},t:{w:.389,h:.615},u:{w:.556,h:.431},v:{w:.528,h:.431,ic:.0139},w:{w:.722,h:.431,ic:.0139},x:{w:.528,h:.431},y:{w:.528,h:.431,d:.194,ic:.0139},z:{w:.444,h:.431}};return _t(t),t._default={w:0,h:.8,d:.2},t._font_info=io,t}(),lo=function(){var t={A:{w:.75,h:.683},B:{w:.708,h:.683},C:{w:.722,h:.683},D:{w:.764,h:.683},E:{w:.681,h:.683},F:{w:.653,h:.683},G:{w:.785,h:.683},H:{w:.75,h:.683},I:{w:.361,h:.683},J:{w:.514,h:.683},K:{w:.778,h:.683},L:{w:.625,h:.683},M:{w:.917,h:.683},N:{w:.75,h:.683},O:{w:.778,h:.683},P:{w:.681,h:.683},Q:{w:.778,h:.683,d:.194},R:{w:.736,h:.683},S:{w:.556,h:.683},T:{w:.722,h:.683},U:{w:.75,h:.683},V:{w:.75,h:.683,ic:.0139},W:{w:1.03,h:.683,ic:.0139},X:{w:.75,h:.683},Y:{w:.75,h:.683,ic:.025},Z:{w:.611,h:.683},a:{w:.529,h:.431},b:{w:.429,h:.694},c:{w:.433,h:.431},d:{w:.52,h:.694},e:{w:.466,h:.431},f:{w:.49,h:.694,d:.194},g:{w:.477,h:.431,d:.194},h:{w:.576,h:.694},i:{w:.345,h:.66},j:{w:.412,h:.66,d:.194},k:{w:.521,h:.694},l:{w:.298,h:.694},m:{w:.878,h:.431},n:{w:.6,h:.431},o:{w:.485,h:.431},p:{w:.503,h:.431,d:.194},q:{w:.446,h:.431,d:.194},r:{w:.451,h:.431},s:{w:.469,h:.431},t:{w:.361,h:.615},u:{w:.572,h:.431},v:{w:.485,h:.431},w:{w:.716,h:.431},x:{w:.572,h:.431},y:{w:.49,h:.431,d:.194,ic:.0359},z:{w:.465,h:.431}};return _t(t),t._font_info=ao,t}(),uo=function(){var t={"!":{c:"!",w:.278,h:.694},"(":{w:.389,h:.75,d:.2},")":{w:.389,h:.75,d:.2},"*":{c:"*",w:.5,h:.665,yf:.14},"+":{c:"+",w:.778,h:.583,d:.0833},",":{c:",",w:.278,h:.106,d:.194},"-":{c:"−",w:.333,h:.431,_c:"-"},".":{c:".",w:.278,h:.106},"/":{c:"/",w:.5,h:.75},":":{c:":",w:.278,h:.48},";":{c:";",w:.278,h:.48,d:.194},"<":{c:"<",w:.778,h:.65,yf:.09},"=":{c:"=",w:.5,h:.55},">":{c:">",w:.778,h:.65,yf:.09},"?":{c:"?",w:.472,h:.694},"[":{c:"[",w:.278,h:.75,d:.25},"]":{c:"]",w:.278,h:.75,d:.25},"|":{c:"|",w:.278,h:.75,d:.25}};return _t(t),t._font_info=ro,t}(),_o=[oo,lo,uo],ho=function t(){ss(this,t)};ho.prototype.width=0,ho.prototype.height=0,ho.prototype.depth=0,ho.prototype.shift=0,ho.prototype.color="black";var co=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.fi=t,i.ch=n,i}return us(e,t),os(e,[{key:"init_size",value:function(t){this.font=ut(this.fi,t.size),this.width=t.string_width(this.ch.c,this.font),this.ch.yf&&(this.y_ofs=this.ch.yf*t.size),this.height=this.ch.h*t.size,this.depth=this.ch.d*t.size}},{key:"draw",value:function(t,e,n){t.font!=this.font&&(t.font=this.font),t.fillText(this.ch.c,e,n+(this.y_ofs||0))}}]),e}(ho),po=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.cmf=t,i.fi=t._font_info,i.text=n,i}return us(e,t),os(e,[{key:"init_size",value:function(t){this.font=ut(this.fi,t.size),this.width=t.string_width(this.text,this.font);for(var e=0,n=0,i=0;i<this.text.length;++i){var r=this.text.charAt(i),a=this.cmf[r];a&&(e<a.h&&(e=a.h),n<a.d&&(n=a.d))}this.height=t.size*e,this.depth=t.size*n}},{key:"draw",value:function(t,e,n){t.font!=this.font&&(t.font=this.font),t.fillText(this.text,e,n)}}]),e}(ho),fo=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.lineWidth=.3,a.draw=t,a.width=n,a.height=i,a.depth=r,a}return us(e,t),os(e,[{key:"draw",value:function(){}},{key:"draw_arc",value:function(t,e,n){t.beginPath(),t.lineWidth=this.lineWidth,t.moveTo(e,n),t.quadraticCurveTo(e+this.width/2,n-1.5*this.height,e+this.width,n),t.stroke()}}]),e}(ho),vo=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.width=t,a.height=n,a.depth=i,a.shift=r,a}return us(e,t),os(e,[{key:"draw",value:function(){}}]),e}(ho),yo=function(t){function e(){ss(this,e);var t=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.children=[],t.curPos=0,t}return us(e,t),os(e,[{key:"add",value:function(t){return this.recalc(t),this.children.push(t),this}},{key:"recalc",value:function(t){this.curPos+=t.width,this.width=As(this.width,this.curPos),this.height=As(this.height,t.height-t.shift),this.depth=As(this.depth,t.depth+t.shift)}},{key:"draw",value:function(t,e,n){for(var i=e,r=this.children,a=r.length,s=0;s<a;++s){var o=r[s];o.draw(t,i,n+o.shift),i+=o.width}}}],[{key:"new_hbox2",value:function(t,n){var i=new e,r=n-t.width,a=new vo(r/2);return i.add(a).add(t).add(a),i}}]),e}(ho),go=function(t){function e(){ss(this,e);var t=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.children=[],t.leftMostPos=Number.MAX_VALUE,t.rightMostPos=Number.MIN_VALUE,t}return us(e,t),os(e,[{key:"add",value:function(t){return this.children.push(t),1===this.children.length?(this.height=t.height,this.depth=t.depth):this.depth+=t.height+t.depth,this.recalc_width(t),this}},{key:"recalc_width",value:function(t){this.leftMostPos=$s(this.leftMostPos,t.shift),this.rightMostPos=As(this.rightMostPos,t.shift+(t.width>0?t.width:0)),this.width=this.rightMostPos-this.leftMostPos}},{key:"draw",value:function(t,e,n){for(var i=n-this.height,r=0;r<this.children.length;++r){var a=this.children[r];i+=a.height,a.draw(t,e+a.shift-this.leftMostPos,i),i+=a.depth}}}]),e}(ho),bo=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.width=n,r.height=t,r.shift=i,r}return us(e,t),os(e,[{key:"draw",value:function(t,e,n){t.fillRect(e,n-this.height,this.width,this.height)}}]),e}(ho),mo={c:"√",w:.505,h:.898,d:0},xo=function(t){function e(t){ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.fi=ro,n.ch=mo,n.height=t,n}return us(e,t),os(e,[{key:"init_size",value:function(t){this.font=ut(this.fi,t.size),this.ch_height=t.size*this.ch.h,this.width=t.size*this.ch.w;var e=this.height/this.ch_height;e<1&&(this.width*=e)}},{key:"draw",value:function(t,e,n){t.font!=this.font&&(t.font=this.font);var i=void 0;this.height<this.ch_height?(i=this.height/this.ch_height,t.save(),t.scale(i,i),t.fillText(this.ch.c,e/i,n/i),t.restore()):(i=this.height/this.ch_height,t.save(),t.scale(1,i),t.fillText(this.ch.c,e,n/i),t.restore())}}]),e}(ho),ko=function t(){ss(this,t)};ko.prototype.type=Vs.ORD;var wo=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.width=t,r.height=n,r.depth=i,r}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=t.size*Hs.xHeight;return new vo(this.width*e,this.height*e,this.depth*e)}}]),e}(ko);wo.prototype.isKern=!0;var jo=function(t){function e(t,n,i){ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.type=t,r.fi=n,r.ch=i,r}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=void 0;return e=t.for_label&&t.style==Ws.D&&this.fi==ao?new co(so,this.ch):new co(this.fi,this.ch),e.init_size(t),e}}]),e}(ko),Oo=function(t){function e(t,n,i){ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.type=t,r.cmf=n,r.text=i,r}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=new po(this.cmf,this.text);return e.init_size(t),e}}]),e}(ko),Po=[[0,1,-2,-3,0,0,0,-1],[1,1,-0,-3,0,0,0,-1],[-2,-2,-0,-0,-2,-0,-0,-2],[-3,-3,-0,0,-3,0,0,-3],[0,0,-0,0,0,0,0,0],[0,1,-2,-3,0,0,0,0],[-1,-1,-0,-1,-1,-1,-1,-1],[-1,1,-2,-3,-1,0,-1,-1]],$o=[0,1,1,1,1,0,1,0],Ao=[0,0,0,1,0,1,1,0],So=function(t){function e(){ss(this,e);var t=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.type=Vs.ORD,t.list=[],t}return us(e,t),os(e,[{key:"add",value:function(t){return this.list.push(t),this}},{key:"count",value:function(){return this.list.length}},{key:"get",value:function(t){return this.list[t]}},{key:"last",value:function(){return this.list.length>0?this.list[this.list.length-1]:null}},{key:"replace_last",value:function(t){return this.list[this.list.length-1]=t,this}},{key:"range",value:function(t){for(var n=new e,i=t;i<this.list.length;++i)n.add(this.list[i]);return n}},{key:"delete_from",value:function(t){return this.list.length=t,this}},{key:"create_box",value:function(t){for(var e=new yo,n=null,i=0;i<this.list.length;++i){var r=this.list[i];ct(r,n,i>=this.list.length?null:this.list[i+1]);var a=ht(r,n,t);a&&e.add(new vo(a));var s=r.create_box(t);e.add(s),n=r}return e}}]),e}(ko),To=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.type=t.type,r.nuc=t,r.sub_script=n,r.super_script=i,r}return us(e,t),os(e,[{key:"create_box",value:function(t){return this.sub_script||this.super_script?this.super_script?null==this.sub_script?this._only_super(t):this._both_script(t):this._only_sub(t):this.nuc.create_box(t)}},{key:"_only_sub",value:function(t){var e=this.nuc.create_box(t),n=new yo;n.add(e);var i=t.get_sub_env(),r=0;this.nuc instanceof jo?((this.nuc.ch.ic||0)*t.size,r=0):(0,r=e.depth+Hs.sub_drop*i.size);var a=this.sub_script.create_box(i);a.width+=pt(t);var s=Hs.sub1*t.size,o=a.height-4*Hs.xHeight*t.size/5,l=Math.max(r,s,o);return a.shift=l,n.add(a),n}},{key:"_only_super",value:function(t){var e=this.nuc.create_box(t),n=new yo;n.add(e);var i=t.get_super_env(),r=0;this.nuc instanceof jo?((this.nuc.ch.ic||0)*t.size,r=0):(0,r=e.height-Hs.sup_drop*i.size);var a=this.super_script.create_box(i);a.width+=pt(t);var s=ft(t),o=a.depth+Hs.xHeight*t.size/4;return r=Math.max(r,s,o),a.shift=-r,n.add(a),n}},{key:"_both_script",value:function(t){var e=this.nuc.create_box(t),n=new yo;n.add(e);var i=t.get_sub_env(),r=t.get_super_env(),a=0,s=0,o=0;this.nuc instanceof jo?(a=(this.nuc.ch.ic||0)*t.size,s=0,o=0):(a=0,s=e.height-Hs.sup_drop*r.size,o=e.depth+Hs.sub_drop*i.size);var l=this.super_script.create_box(r);l.width+=pt(t);var u=ft(t),_=l.depth+Hs.xHeight*t.size/4;s=Math.max(s,u,_);var h=this.sub_script.create_box(i);h.width+=pt(t),o=Math.max(o,Hs.sub2*t.size);var c=Hs.default_rule_thickness*t.size,p=s-l.depth-(h.height-o);if(p<4*c){o=4*c-s+l.depth+h.height;var f=4*Hs.xHeight*t.size/5-(s-l.depth);f>0&&(s+=f,o-=f)}var v=new go;return l.shift=a,v.add(l),p=s-l.depth-(h.height-o),0!=p&&v.add(new vo(0,p,0,0)),v.add(h),v.height=l.height+s,v.depth=h.depth+o,n.add(v),n}}]),e}(ko),Eo=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments[1],i=arguments[2];ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.type=Vs.ORD,r._from=t,r.num=n,r.denom=i,r}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=Hs.default_rule_thickness*t.size,n=this.num.create_box(t.get_num_env()),i=this.denom.create_box(t.get_denom_env()),r=Math.max(n.width,i.width);r+=.1*t.size,n.width<r&&(n=yo.new_hbox2(n,r)),i.width<r&&(i=yo.new_hbox2(i,r));var a=void 0,s=void 0;if(t.style<Ws.T?(a=Hs.num1*t.size,s=Hs.denom1*t.size):(a=0==e?Hs.num2*t.size:Hs.num3*t.size,s=Hs.denom2*t.size),0==e)throw new Error("todo: when xita == 0 for \\atop cmd");var o=t.style<Ws.T?3*e:e,l=Hs.axisheight*t.size,u=a-n.depth-(l+e/2),_=o-u;_>0&&(a+=_,u+=_);var h=l-e/2-(i.height-s),c=o-h;c>0&&(s+=o-h,h+=c);var p=new go;return p.add(n),p.add(new vo(0,u)),p.add(new bo(e,r,0)),p.add(new vo(0,h)),p.add(i),p.height=n.height+a,p.depth=i.depth+s,p}}]),e}(ko),zo=function(t){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.type=t,r.nuc=n,r.root=i,r}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=this.nuc.create_box(t.get_cramp_env()),n=new yo;n.add(new vo(.08*t.size)),n.add(e);var i=Hs.default_rule_thickness*t.size,r=t.style<Ws.T?Hs.xHeight*t.size:i,a=i+Math.abs(r)/4,s=vt(t,n.height+n.depth+a+i);s.shift=n.depth;var o=new go;o.add(new vo(0,i)),o.add(new bo(i,n.width)),o.add(new vo(0,a)),o.add(n),o.shift=-n.height-i-a;var l=new yo;return l.add(s),l.add(o),l}}]),e}(ko),Co=function(t){function e(t){ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.type=Vs.ORD,n.nuc=t,n}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=this.nuc.create_box(t.get_cramp_env()),n=Hs.default_rule_thickness*t.size,i=new go;return i.add(new vo(0,n)),i.add(new bo(n,e.width)),i.add(new vo(0,3*n)),i.add(e),i.height=e.height+5*n,i.depth=e.depth,i}}]),e}(ko),Io=function(t){function e(t){ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.type=Vs.ORD,n.nuc=t,n}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=this.nuc.create_box(t),n=Hs.default_rule_thickness*t.size,i=new go;return i.add(e),i.add(new vo(0,3*n)),i.add(new bo(n,e.width)),i.add(new vo(0,n)),i.height=e.height,i.depth=e.depth+5*n,i}}]),e}(ko),Bo=function(t){function e(t){ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.nuc=t,n}return us(e,t),os(e,[{key:"create_box",value:function(t){var e=this.nuc.create_box(t),n=Hs.default_rule_thickness*t.size,i=new go;i.add(new vo(0,n));var r=new fo(fo.prototype.draw_arc,e.width,6*n,0);return r.lineWidth=n,i.add(r),i.add(new vo(0,2*n)),i.add(e),i.height=e.height+9*n,i.depth=e.depth,i}}]),e}(ko),No=function(t){function e(t){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return us(e,t),e}(Error),Mo={"!":[5,2,"!"],"(":[4,2,"("],")":[5,2,")"],"*":[2,2,"*"],"+":[2,2,"+"],",":[6,2,","],"-":[2,2,"-"],".":[0,2,"."],"/":[0,2,"/"],":":[3,2,":"],";":[6,2,";"],"<":[3,2,"<"],"=":[3,2,"="],">":[3,2,">"],"?":[5,2,"?"],"[":[4,2,"["],"]":[5,2,"]"],"|":[0,2,"|"]},qo={text:"text",newln:"_ignore",frac:"frac",sqrt:"sqrt",sin:"named_op",cos:"named_op",overline:"overline",underline:"underline",overarc:"overarc",",":["spacer",1/6],":":["spacer",1/6],">":["spacer",2/9],";":["spacer",5/18],"!":["spacer",-1/6],space:["spacer",1],enspace:["spacer",.5],quad:["spacer",1],qquad:["spacer",2],thinspace:["spacer",1/6],negthinspace:["spacer",-1/6]},Ro=function(){function t(e){ss(this,t),this.str=e,this._scan_start=0,this._scan_end=e.length,this.mlist=new So,this.ptr=this._scan_start,this.data={prev:null,openI:null}}return os(t,[{key:"parse",value:function(){for(;this.ptr<this._scan_end;){var t=this.str.charAt(this.ptr++);if("\\"==t)this.handle_cmd();else if("{"==t)this.handle_open(t);else if("}"==t)this.handle_close(t);else if("^"==t)this.handle_super_script();else if("_"==t)this.handle_sub_script();else if(Z(t));else{var e=this.convert_char(t);this.mlist.add(e)}}return this.mlist}},{key:"result",value:function(){return this.mlist}},{key:"convert_char",value:function(t){if(tt(t))return new jo(Vs.ORD,ao,lo[t]);if(et(t))return new jo(Vs.ORD,io,oo[t]);var e=Mo[t];if(e)return this.handle_tex_char(e[0],e[1],e[2]);var n={c:t,w:.8,h:.82,d:.12};return new jo(Vs.ORD,io,n)}},{key:"handle_tex_char",value:function(t,e,n){var i=_o[e],r=i[n];r||(r={c:n,w:.8,h:.8,d:.2});var a=i._font_info;return new jo(t,a,r)}},{key:"handle_super_script",value:function(){var t=this.mlist.last();if(t||(t=new Oo(Vs.ORD,oo,""),this.mlist.add(t)),t instanceof To&&t.super_script)throw new No("Double exponent.");var e=this.process_script_arg("superscript");t instanceof To?t.super_script=e:this.mlist.replace_last(new To(t,null,e))}},{key:"handle_sub_script",value:function(){var t=this.mlist.last();if(t||(t=new Oo(Vs.ORD,oo,""),this.mlist.add(t)),t instanceof To&&t.sub_script)throw new No("Double subscripts.");var e=this.process_script_arg("subscript");t instanceof To?t.sub_script=e:this.mlist.replace_last(new To(t,e,null))}},{key:"handle_open",value:function(t){var e={prev:this.data,openI:this.mlist.count()};this.data=e}},{key:"handle_close",value:function(t){if(null==this.data.openI)throw new No("Extra close brace");var e=this.mlist.range(this.data.openI);this.mlist.delete_from(this.data.openI),this.mlist.add(e),this.data=this.data.prev}},{key:"get_command",value:function(){var t=this.ptr;if(this.ptr>=this._scan_end)throw new No("Invalid command");var e=this.str[this.ptr++];if(!tt(e))return e;for(;this.ptr<this._scan_end;){if(e=this.str[this.ptr],!tt(e))return this.str.substring(t,this.ptr);++this.ptr}return this.str.substring(t)}},{key:"skip_ws",value:function(){for(;this.ptr<this._scan_end;){if(!Z(this.str.charAt(this.ptr)))return;++this.ptr}}},{key:"get_argument",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.skip_ws(),this.ptr>=this._scan_end){if(!e)throw new No("Missing argument for "+t);return null}var n=this.str.charAt(this.ptr);if("}"===n){if(!e)throw new No("Extra close brace");return null}if("\\"===n)return++this.ptr,"\\"+this.get_command();if("{"!==n)return++this.ptr,n;for(var i=++this.ptr,r=1;this.ptr<this._scan_end;)if("\\"===(n=this.str.charAt(this.ptr++)))++this.ptr;else if("{"===n)++r;else if("}"===n){if(0==r)throw new No("Extra close brace");if(0==--r)return this.str.substring(i,this.ptr-1)}throw new No("Missing close brace")}},{key:"process",value:function(e){var n=new t(e);n.parse();var i=n.mlist;return 0==i.count()?null:1==i.count()?i.get(0):i}},{key:"process_arg",value:function(t){var e=this.get_argument(t);return this.process(e)}},{key:"process_script_arg",value:function(t){var e=this.get_argument(t);return"\\"==e[0]&&("\\frac"==e?(e+="{"+this.get_argument("frac")+"}",e+="{"+this.get_argument("frac")+"}"):"\\sqrt"==e&&(e+="{"+this.get_argument("sqrt")+"}")),this.process(e)}},{key:"handle_cmd",value:function(){var t=this.get_command(),e=qo[t];if(e){if("string"==typeof e)return this[e](t);return this[e[0]].call(this,t,e[1],e[2],e[3])}throw new No("Unsupport cmd "+t)}},{key:"text",value:function(){var t=this.get_argument("\\text"),e=new Oo(Vs.ORD,oo,t);this.mlist.add(e)}},{key:"_ignore",value:function(){}},{key:"frac",value:function(){var t=this.process_arg("\\frac"),e=this.process_arg("\\frac"),n=new Eo("frac",t,e);this.mlist.add(n)}},{key:"sqrt",value:function(){var t=this.process_arg("\\sqrt"),e=new zo(Vs.ORD,t,null);this.mlist.add(e)}},{key:"named_op",value:function(t){var e=new Oo(Vs.OP,oo,t);this.mlist.add(e)}},{key:"overline",value:function(){var t=this.process_arg("\\overline"),e=new Co(t);this.mlist.add(e)}},{key:"underline",value:function(){var t=this.process_arg("\\underline"),e=new Io(t);this.mlist.add(e)}},{key:"overarc",value:function(){var t=this.process_arg("\\overarc"),e=new Bo(t);this.mlist.add(e)}},{key:"spacer",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=new wo(e);this.mlist.add(n)}}]),t}(),Fo=function(){function t(e,n){ss(this,t),this.str=e,this.ctx=n}return os(t,[{key:"parse",value:function(){try{var t=P(this.str);return dt(new Ro(t).parse())}catch(t){return new Oo(0,null,this.str)}}},{key:"layout",value:function(t){var e=new eo(this.ctx,Ws.D,20);return e.for_label=!0,t.create_box(e)}}]),t}(),Do=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";ss(this,t),this.text="",this.show=1,this.x=0,this.y=0,this.width=0,this.height=0,this.auto_pos=!0,e&&this.init(e,n)}return os(t,[{key:"init",value:function(t,e){this.owner=t,this.text=e,this.show=0,this.pos=[]}},{key:"toString",value:function(){return"(Label "+this.text+")"}},{key:"update_data",value:function(t){if(t&&t.ctx){if(!this.text)return this._q_text=this.text,this._box=null,void(this.width=this.height=0);if(this._q_text!==this.text){var e=new Fo(this.text,t.ctx),n=e.parse();this._box=e.layout(n),this._q_text=this.text}this.width=this._box.width,this.height=this._box.height+this._box.depth,this.owner&&this.owner.calc_label_pos(this)}}},{key:"draw",value:function(t,e){if(this.owner&&this.show&&this.text){if(!this._box||!this.width){if(this.update_data(e),!this._box||!this.width)return;this.owner.calc_label_pos(this)}var n=this.color;t.fillStyle!=n&&(t.fillStyle=n),t.strokeStyle!=n&&(t.strokeStyle=n),t.textAlign="start",t.textBaseline="alphabetic",this._box.draw(t,this.x,this.y+this._box.height)}}},{key:"hit_test",value:function(t,e){if(!this.show||!this.text||!this.width)return!1;this.owner.calc_label_pos(this);var n=this.x,i=this.y;return t>=n&&e>=i&&t<=n+this.width&&e<=i+this.height}},{key:"on_move",value:function(t){this.owner.move_label_pos(this,t)}},{key:"set_data",value:function(t){}},{key:"get_data",value:function(){for(var t=[this.text,this.show?1:0],e=0;e<this.pos.length;++e)t.push(function(t){return Ss(1e3*t)/1e3}(this.pos[e]));return t}},{key:"pot_all_path",value:function(t,e){}}]),t}();Do.WH=8,Do.STEP=1,Do.prototype.color="#000000";var Lo={},Xo=function(){function t(){ss(this,t),this.label=this._create_label("")}return os(t,[{key:"init",value:function(){}},{key:"unserialize",value:function(t,e){}},{key:"update",value:function(){}},{key:"draw",value:function(t,e){}},{key:"hit_test",value:function(t,e){return!1}},{key:"rc_hit_test",value:function(t){return!1}},{key:"on_insert",value:function(t){}},{key:"on_delete",value:function(t){}},{key:"on_select",value:function(t){}},{key:"on_move",value:function(t){return!1}},{key:"parents",value:function(){return this._parents||Is}},{key:"children",value:function(){return this._children||Is}},{key:"has_child",value:function(t){var e=this._children;return!(!e||!e.length)&&e.indexOf(t)>=0}},{key:"add_child",value:function(t){var e=this._children;return e||(e=this._children=[]),!(e.indexOf(t)>=0)&&(e.push(t),!0)}},{key:"remove_child",value:function(t){var e=this._children;if(!e)return!1;var n=e.indexOf(t);return n>=0&&e.splice(n,1),n>=0}},{key:"move_ctrlrs",value:function(){return this._move_ctrls?this._move_ctrls:0==this.free_value?this.parents():null}},{key:"pos_snapshot",value:function(){}},{key:"unpos_snapshot",value:function(t){}},{key:"_create_label",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return new Do(this,t)}},{key:"get_label",value:function(){return this.get_label_obj().text}},{key:"set_label",value:function(t,e){var n=this.get_label_obj();n.text=t,n.show=void 0===e?t?1:0:e?1:0,n.update_data(this.pad);var i=this.children();if(i&&i.length)for(var r=0;r<i.length;++r){var a=i[r];a.label_changed&&a.label_changed(this)}}},{key:"get_label_obj",value:function(){return this.label||(this.label=this._create_label("")),this.label}},{key:"calc_label_pos",value:function(t){t.x=t.y=0}},{key:"move_label_pos",value:function(t,e){}},{key:"get_name",value:function(){return this.get_disp_name()}},{key:"sget_name",value:function(){var t=this.get_label();return t?P(t):"#"+this.obj_id}},{key:"get_color",value:function(){return this.color}},{key:"set_color",value:function(t){this.color=t}},{key:"show",value:function(){return this.visible=!0,this}},{key:"hide",value:function(){return this.visible=!1,this}},{key:"show_hide",value:function(t){return this.visible=t,this}},{key:"_set_option",value:function(t,e){D(this,t,e)}},{key:"gsf_id",value:function(){return this.s_id||0}},{key:"gsf_name",value:function(){return this.class_name}},{key:"gsf_pars",value:function(){return Is}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t||(t={});var e=this,n=e.label;return n&&n.text&&(t.label=e.gsf_write_label()),e.visible||(t.hidden=""),t}},{key:"gsf_read_label",value:function(t,e){var n=this.get_label_obj(),i=e.length;n.text=t,n.show=i<2||e[1]?1:0;for(var r=2;r<i;++r)n.pos[r-2]=e[r]}},{key:"gsf_write_label",value:function(){var t=this.label;if(!t||!t.text)return"";var e=t.get_data();return e[0]=JSON.stringify(e[0]),"label("+e.join(",")+")"}},{key:"to_gsf_rec",value:function(){var t=this;return new Rs(t.gsf_id(),t.gsf_name(),t.gsf_pars(),t.gsf_props())}},{key:"to_gsf_str",value:function(){return gt(this.to_gsf_rec())}},{key:"to_jgex_0",value:function(t){}},{key:"to_jgex_1",value:function(t){}},{key:"to_jgex",value:function(t){}},{key:"to_json",value:function(t){var e=jt(this),n={sid:this.s_id,class_name:this.class_name,props:e},i=this.parents();return i&&i.length&&(n.parents=function(t){if(!t||!t.length)return null;for(var e=[],n=0;n<t.length;++n)e.push(t[n].s_id);return e}(i)),this.label&&(n.label=this.label.get_data()),this.xformer&&(n.xformer=this.xformer.to_json()),n}},{key:"is_type",value:function(t){return this.type===t||this.sub_type===t}},{key:"as_type",value:function(t){return this.is_type(t)}},{key:"get_prop_pages",value:function(){return["object","label"]}},{key:"init_object_ppage",value:function(t){t.std_init_object_page(this)}},{key:"init_label_ppage",value:function(t){t.std_init_label_page(this)}},{key:"apply_prop_change",value:function(t){var e=this,n=e.get_prop_pages();if(n&&n.length)for(var i=0;i<n.length;++i){var r=n[i];switch(r){case"object":e.apply_object_change(t.object);break;case"label":e.apply_label_change(t.label);break;case"value":e.apply_value_change(t.value);break;case"animate":e.apply_animate_change(t.animate);break;case"mark":e.apply_mark_change(t.mark);break;case"move":e.apply_move_change(t.move);break;case"text":e.apply_text_change(t.text);break;case"shbtn":
e.apply_shbtn_change(t.shbtn);break;default:console.error("todo: apply_prop_change() for page: "+r)}}}},{key:"apply_object_change",value:function(t){this.visible=t.visible,this.selectable=t.selectable,this.visible||this.selected&&this.pad&&this._in_pad&&this.pad.unselect_obj(this)}},{key:"apply_label_change",value:function(t){this.set_label(t.text,t.show)}},{key:"get_disp_name",value:function(t){return this.label&&this.label.text?this.label.text:"#"+this.obj_id}}]),t}();R(Xo,{class_name:"GObject",type:"gobject",sub_type:"gobject",type_cname:"对象",obj_id:0,s_id:0,exist:!0,visible:!0,selectable:!0,valpha:1,free_value:0,layer:1e3,color:"#000000",selected:!1,highlight:!1,prev_obj:null,next_obj:null,pad:null,_in_pad:!1,is_temp:!1,_parents:null,_children:null,_move_ctrls:null,_jpda:[yt]});var Yo={"#000000":"black","#ff0000":"red","#ffff00":"yellow","#008000":"green","#00ffff":"cyan","#0000ff":"blue","#ff00ff":"magenta","#808080":"gray","#000080":"navyblue","#00ff00":"lime"};Xo.gsfrec_to_str=gt;var Uo=function(){function t(){ss(this,t)}return os(t,[{key:"unserialize",value:function(){}},{key:"defined",value:function(){return!0}},{key:"trans_leng",value:function(t){return t}},{key:"add_parents",value:function(t){}},{key:"gsf_name",value:function(){return this.class_name}},{key:"gsf_pars",value:function(t){return[t]}}]),t}();R(Uo,{type:"xform"});var Ho=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.dx=t,i.dy=n,i}return us(e,t),os(e,[{key:"transform",value:function(t){return{x:t.x+this.dx,y:t.y-this.dy}}},{key:"gsf_pars",value:function(t){return[t,this.dx,this.dy]}},{key:"to_json",value:function(){return{class_name:this.class_name,props:{dx:this.dx,dy:this.dy}}}}]),e}(Uo);R(Ho,{class_name:"Translation"});var Wo=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.pS=t,i.pE=n,i._parents=[t,n],i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.pS=this._parents[0],this.pE=this._parents[1]}},{key:"defined",value:function(){return this.pS.exist&&this.pE.exist}},{key:"transform",value:function(t){return{x:t.x+this.pE.x-this.pS.x,y:t.y+this.pE.y-this.pS.y}}},{key:"add_parents",value:function(t){t.push(this.pS),t.push(this.pE)}},{key:"gsf_pars",value:function(t){return[t,this.pS,this.pE]}},{key:"to_json",value:function(){return{class_name:this.class_name,parents:[this.pS.s_id,this.pE.s_id]}}}]),e}(Uo);R(Wo,{class_name:"VectorTranslation",sub_type:"vxlate"});var Vo=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.init(t,n,i),r}return us(e,t),os(e,[{key:"init",value:function(t,e,n){t&&(this.pC=t,this.rad=e||0,this.scale=n||1,this._cosa=ks(e),this._sina=xs(e))}},{key:"unserialize",value:function(){this.pC=this._parents[0],this._cosa=ks(this.rad),this._sina=xs(this.rad)}},{key:"defined",value:function(){return this.pC.exist}},{key:"transform",value:function(t){var e=this.pC,n=e.x,i=e.y,r=this.scale*(t.x-n),a=this.scale*(t.y-i);return{x:n+(r*this._cosa+a*this._sina),y:i+(-r*this._sina+a*this._cosa)}}},{key:"trans_leng",value:function(t){return t*this.scale}},{key:"add_parents",value:function(t){t.push(this.pC)}},{key:"gsf_pars",value:function(t){return[t,this.pC,this.rad,this.scale]}},{key:"to_json",value:function(){return{class_name:this.class_name,parents:[this.pC.s_id],props:{rad:this.rad,scale:this.scale}}}}]),e}(Uo);R(Vo,{class_name:"Rotation",sub_type:"rota"});var Go=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t&&(i.pC=t,i.ratio=n),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.pC=this._parents[0]}},{key:"defined",value:function(){return this.pC&&this.pC.exist}},{key:"transform",value:function(t){var e=this,n=e.pC,i=n.x,r=n.y,a=e.ratio;return{x:(t.x-i)*a+i,y:(t.y-r)*a+r}}},{key:"trans_leng",value:function(t){return t*this.ratio}},{key:"add_parents",value:function(t){t.push(this.pC)}},{key:"gsf_pars",value:function(t){return[t,this.pC,this.ratio]}},{key:"to_json",value:function(){return{class_name:"Dilation",parents:[this.pC.s_id],props:{ratio:this.ratio}}}}]),e}(Uo);R(Go,{class_name:"Dilation",sub_type:"dila"});var Jo=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.mirror=t,n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.mirror=this._parents[0]}},{key:"defined",value:function(){return this.mirror.exist}},{key:"transform",value:function(t){return m(t.x,t.y,this.mirror)}},{key:"add_parents",value:function(t){t.push(this.mirror)}},{key:"gsf_pars",value:function(t){return[t,this.mirror]}},{key:"to_json",value:function(){return{class_name:this.class_name,parents:[this.mirror.s_id]}}}]),e}(Uo);R(Jo,{class_name:"Reflection",sub_type:"refl"});var Qo=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;ss(this,n);var i=_s(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.point_size=3.5,i.x=t,i.y=e,i}return us(n,t),os(n,[{key:"toString",value:function(){var t=this,n=t.label,i=n&&n.text?n.text:"";return i?i+=" #"+t.obj_id:i="#"+t.obj_id,"("+t.class_name+" "+i+" "+e(t.x,3)+" "+e(t.y,3)+")"}},{key:"draw",value:function(t,e){var n=this;if(n.exist){n.label&&n.label.show&&n.label.draw(t,e);var i=n.x,r=n.y,a=n.point_size+(n.highlight?2.5:0);i<e.left-a||i>e.right+a||r<e.top-a||r>e.bottom+a||(n.valpha<1&&(t.globalAlpha=n.valpha),t.beginPath(),t.arc(i,r,a,0,ds),t.fillStyle!=n.color&&(t.fillStyle=n.color),t.fill(),a>1.9&&(t.strokeStyle=n.border_color,t.lineWidth=.4,t.stroke()),n.selected&&(t.beginPath(),t.arc(i,r,a+2.2,0,ds),t.strokeStyle="#ff00ff",t.lineWidth=1.2,t.stroke()),n.valpha<1&&(t.globalAlpha=1))}}},{key:"hit_test",value:function(t,e){var n=this;if(n.exist){var i=n.x-t,r=n.y-e;n.pad;if(i*i+r*r<=36)return 1}return 0}},{key:"rc_hit_test",value:function(t){var e=this;return!!e.exist&&(e.x>=t.left&&e.x<=t.right&&e.y>=t.top&&e.y<=t.bottom)}},{key:"get_point_size",value:function(){return this.point_size}},{key:"set_point_size",value:function(t){this.point_size=t}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=qs(t,{color:this.color,point_size:this.point_size}),ls(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"gsf_props",this).call(this,t)}},{key:"to_jgex",value:function(){console.log("todo: to_jgex()")}},{key:"calc_label_pos",value:function(t){var e=t.pos;e&&2==e.length?(t.x=this.x+e[0],t.y=this.y+e[1]):(t.x=this.x+4,t.y=this.y+4)}},{key:"move_label_pos",value:function(t,e){"down"==e.event?e.old_pos=t.pos.slice(0):(e.old_pos&&2==e.old_pos.length||(e.old_pos=[4,4]),t.pos[0]=e.old_pos[0]+e.delta_x,t.pos[1]=e.old_pos[1]+e.delta_y,"up"==e.event&&(t.auto_pos=!1),this.calc_label_pos(t))}},{key:"set_label_pos",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,n=this.label.pos;n[0]=t,n[1]=e}},{key:"is_on_line",value:function(t){return t.p1===this||t.p2===this||("paral"===t.sub_type||"perpl"===t.sub_type)&&this===t.p3}},{key:"sget_name",value:function(){var t=this.get_label();if(!t){if(!this.pad)return"#"+this.obj_id;this.set_label(this.pad.pt_namer.next()),this.auto_label_pos(),t=this.get_label()}return P(t)}}]),n}(Xo);R(Qo,{class_name:"PointBase",type:"point",sub_type:"point_base",type_cname:"点",free_value:2,point_size:3.5,color:"#ff0000",border_color:"#000000",layer:3e3,x:0,y:0,_jpda:["color","point_size"]});var Ko=new Image,Zo=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];ss(this,t),this.min=e,this.max=n,this.min_inc=i,this.max_inc=r}return os(t,[{key:"toString",value:function(){var t=this.min_inc?"[":"(";return t+=this.min+", "+this.max,t+=this.max_inc?"]":")"}},{key:"in_range",value:function(t){if(this.min_inc){if(t<this.min)return!1}else if(t<=this.min)return!1;if(this.max_inc){if(t>this.max)return!1}else if(t>=this.max)return!1;return!0}}]),t}(),tl=new Zo(0,1,!0,!0),el=new Zo(0,ys,!0,!1),nl=new Zo(gs,ys,!1,!1),il=function(e){function n(){return ss(this,n),_s(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return us(n,e),os(n,[{key:"toString",value:function(){var t=this.class_name||"Line",e=function(t){return t&&t.text?t.text+" ":""}(this.label);return"("+t+" #"+this.obj_id+" "+e+" #"+this.p1.obj_id+" #"+this.p2.obj_id+")"}},{key:"as_type",value:function(t){switch(t){case"seg":case"segment":return 0==this.line_type;case"ray":return 1==this.line_type;case"sline":return 2==this.line_type;case"paral":return"paral"==this.sub_type;case"perpl":return"perpl"==this.sub_type;case"bisl":return"bisl"==this.sub_type;case"line":return"line"==this.type}return!1}},{key:"leng",value:function(){var t=this.p1.x-this.p2.x,e=this.p1.y-this.p2.y;return ms(t*t+e*e)}},{key:"formula",value:function(){var t=this,e=t.p1,n=t.p2,i=e.x,r=e.y,a=n.x,s=n.y;return{A:s-r,B:i-a,C:a*r-i*s}}},{key:"draw_line",value:function(t,e,n,i,r,a){if(n!=r||i!=a){var s=this,o=s.highlight?4:s.line_width,l=s.highlight?"#ff0000":s.color;if(s.valpha<1&&(e.globalAlpha=s.valpha),e.beginPath(),1==s.line_style?Pt(e,n,i,r,a,[10,5]):2==s.line_style?Pt(e,n,i,r,a,[3,4]):(e.moveTo(n,i),e.lineTo(r,a)),e.lineWidth=o,e.strokeStyle=l,e.stroke(),s.selected){var u=ms((r-n)*(r-n)+(a-i)*(a-i)),_=o/2+2,h=-_*(a-i)/u,c=_*(r-n)/u;e.lineWidth=.5,e.strokeStyle="#ff00ff",e.beginPath(),e.moveTo(n+h,i+c),e.lineTo(r+h,a+c),e.moveTo(n-h,i-c),e.lineTo(r-h,a-c),e.stroke()}s.valpha<1&&(e.globalAlpha=1)}}},{key:"draw",value:function(t,e){var n=this;n.label&&n.label.draw(t,e);var i=n.p1,r=n.p2,a=n.t_range,s={x1:i.x,y1:i.y,x2:r.x,y2:r.y,t_min:a.min,t_max:a.max,delta:3},o=b(e.rc,s);o.exist&&n.draw_line(e,t,o.x1,o.y1,o.x2,o.y2)}},{key:"hit_test",value:function(t,e){var n=this,i=n.p1,r=n.p2,a=i.x,s=i.y,o=r.x,l=r.y,u=o-a,_=l-s,h=(n.pad,_),c=-u,p=u*s-_*a,f=h*h+c*c,v=ms(f),d=bs(h*t+c*e+p)/v;if(d*d>36)return!1;var y=u*(t-a)+_*(e-s);y/=f;var g=n.t_range;if(y<g.min){if((t-a)*(t-a)+(e-s)*(e-s)>36)return null}else if(y>g.max&&(t-o)*(t-o)+(e-l)*(e-l)>36)return null;return!0}},{key:"rc_hit_test",value:function(t){var e=this,n=e.p1,i=e.p2;return b(t,{x1:n.x,y1:n.y,x2:i.x,y2:i.y,t_min:e.t_range.min,t_max:e.t_range.max,delta:2}).exist}},{key:"gsf_name",value:function(){return this.class_name}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this;return t=qs(t,{color:e.color,line_width:e.line_width,line_style:e.line_style}),ls(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"gsf_props",this).call(this,t)}},{key:"to_jgex_1",value:function(t){var e=this,n=[],i="";switch(e.sub_type){case"segment":case"ray":case"sline":e.__out=!0,e.__point1=e.p1.__name,e.__point2=e.p2.__name,n.push(e.p1),n.push(e.p2);break;case"paral":case"perpl":case"bisl":e.__out=!1,e.__point1=e.p3.__name,n.push(e.p3);break;default:throw"Invalid!? line sub_type:"+this.sub_type}var r=e._child_objs;if(r&&r.length>0)for(var a=0;a<r.length;++a){var s=r[a];"point"==s.type&&n.push(s)}if(n.length>2){i="LINE";for(var o=0;o<n.length;++o)i+=" "+n[o].__name;t.add_line(i)}}},{key:"path_info",value:function(){return{min:0,max:1,closed:!1}}},{key:"calc_point_on",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.exist?{x:t*(this.p2.x-this.p1.x)+this.p1.x,y:t*(this.p2.y-this.p1.y)+this.p1.y}:null}},{key:"calc_tangent_on",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];return{x:this.p2.x-this.p1.x,y:this.p2.y-this.p1.y}}},{key:"move_oopt",value:function(t,e){var n=this;if(!n.exist)return!1;void 0===e.memo[t.obj_id]&&(e.memo[t.obj_id]=t.t);var i=e.cur_x-e.start_x,r=e.cur_y-e.start_y;if(0==i&&0==r)return!1;var a=n.p1.x,s=n.p1.y,o=n.p2.x,l=n.p2.y;if(a==o&&s==l)return!1;var u=a+i,_=s+r,h=(u-o)*(u-o)+(_-l)*(_-l),c=(u-a)*(u-a)+(_-s)*(_-s),p=(o-a)*(o-a)+(l-s)*(l-s),f=(c+p-h)/p/2;if(0==f)return!1;var v=e.memo[t.obj_id]+f;return v<n.t_range.min?v=n.t_range.min:v>n.t_range.max&&(v=n.t_range.max),t.t!=v&&(t.t=v,!0)}},{key:"point_proj_info",value:function(t,e){return o(t,e,this)}},{key:"random_oopt",value:function(){return ll.new_oopt(this,Es())}},{key:"create_ani_pt",value:function(t,e,n,i,r){return new Cs.PointOnStraightAnim(t,e,n,i,r)}},{key:"calc_pt_t",value:function(e){if(this.p1===e)return 0;if(this.p2===e)return 1;var n=this.p2.x-this.p1.x,i=this.p2.y-this.p1.y,r=n*n+i*i;if(0==r)return 0;var a=(e.x-this.p1.x)*(e.x-this.p1.x)+(e.y-this.p1.y)*(e.y-this.p1.y),s=ms(a/r),o=void 0;return o=bs(n)>=bs(i)?t(n)*t(e.x-this.p1.x):t(i)*t(e.y-this.p1.y),o>0?s:-s}},{key:"xform_obj",value:function(t){return new Cs.XformedLine(this,t)}},{key:"is_segment",value:function(t,e){return!1}},{key:"is_ray",value:function(t,e){return!1}},{key:"is_sline",value:function(t,e){return!1}},{key:"is_paral",value:function(t,e){return!1}},{key:"is_perpl",value:function(t,e){return!1}},{key:"is_bisl",value:function(t,e,n){return!1}},{key:"is_bisl_ex",value:function(t,e,n){return!1}},{key:"as_sline",value:function(t,e){return 2==this.line_type&&(this.is_pt_on_line(t)&&this.is_pt_on_line(e))}},{key:"as_ray",value:function(t,e){return!1}},{key:"as_bisl",value:function(t,e){return!1}},{key:"calc_label_pos",value:function(t){var e=t.pos;e&&2==e.length||(e=St());var n=e[0],i=e[1],r=this.p1,a=this.p2,s=a.x-r.x,o=a.y-r.y,l=ms(s*s+o*o),u=i*s+r.x,_=i*o+r.y,h=n*o/l,c=-n*s/l;t.x=u+h,t.y=_+c}},{key:"set_label_pos",value:function(t,e){this.label.pos=St(t,e)}},{key:"move_label_pos",value:function(t,e){if("down"==e.event)e.old_pos={x:t.x,y:t.y};else{var n=e.old_pos,i=n.x+e.delta_x,r=n.y+e.delta_y;t.x=i,t.y=r;var a=this.point_proj_info(i,r),s=t.pos;s[0]=a.d_p,s[1]=a.t_old}}},{key:"is_pt_on_line",value:function(t){var e=this;if(t.path===e)return!0;if((t.obj1===e||t.obj2===e)&&"intpt"===t.sub_type)return!0;if("segment"===e.sub_type||"ray"===e.sub_type||"sline"===e.sub_type){if(t===e.p1||t===e.p2)return!0}else{if("paral"===e.sub_type||"perpl"===e.sub_type)return t===e.p3;if("bisl"===e.sub_type)return t===e.pO}return!1}},{key:"sget_name",value:function(){var t=this,e=t.get_label();if(e)return P(e);if("point"==t.p1.type&&"point"==t.p2.type){return t.p1.sget_name()+t.p2.sget_name()}return t.pad?(t.set_label(t.pad.ln_namer.next()),P(t.get_label())):"#"+t.obj_id}}]),n}(Xo);R(il,{class_name:"LineBase",type:"line",sub_type:"",type_cname:"线",line_type:0,free_value:0,t_range:nl,color:"#000080",line_width:2,line_style:0,path_type:1,layer:2e3,p1:null,p2:null,_jpda:["color","line_width","line_style"]}),Ot(il,[Us]);var rl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof il&&(n.seg=t,n._parents=[t],n.update()),n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.seg=this._parents[0]}},{key:"update",value:function(){var t=this.seg;(this.exist=t.exist)&&(this.x=(t.p1.x+t.p2.x)/2,this.y=(t.p1.y+t.p2.y)/2)}},{key:"gsf_pars",value:function(){return[this.seg]}},{key:"to_jgex",value:function(t){var e=this,n="MIDPOINT "+e.__name+" "+e.path.p1.__name+" "+e.path.p2.__name;t.add_line(n)}},{key:"get_segment",value:function(){return this.seg}},{key:"is_midpt_of",value:function(t){return this.seg===t}},{key:"is_on_line",value:function(t){return this.seg===t||ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"is_on_line",this).call(this,t)}}]),e}(Qo);R(rl,{class_name:"Midpoint",sub_type:"midpt",type_cname:"中点",free_value:0});var al=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Xo&&Tt(t)&&(i.path=t,i.t=n||0,i._parents=[t],i.update()),i}return us(e,t),os(e,[{key:"valueOf",value:function(){return this.t}},{key:"unserialize",value:function(){this.path=this._parents[0]}},{key:"update",value:function(){var t=this.path;if(this.exist=t.exist){var e=t.calc_point_on(this.t);this.x=e.x,this.y=e.y}}},{key:"on_move",value:function(t){var e=this.path.move_oopt(this,t);return this.update(),e}},{key:"pos_snapshot",value:function(){return this.t}},{key:"unpos_snapshot",value:function(t){this.t=t}},{key:"is_on_line",value:function(t){return this.path===t||ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"is_on_line",this).call(this,t)}},{key:"gsf_name",value:function(){return"Point on object"}},{key:"gsf_pars",value:function(){return[this.path,this.t]}},{key:"to_jgex",value:function(t){function e(t,e,n){var i="";switch(e.__out=!0,e.__point2=n.__name,e.sub_type){case"paral":var r=e.line1;i="ON_PLINE "+n.__name+" "+e.__point1+" "+r.__point1+" "+r.__point2;break;case"perpl":var r=e.line1;i="ON_TLINE "+n.__name+" "+e.__point1+" "+r.__point1+" "+r.__point2;break;case"bisl":i="EQANGLE "+e.pA.__name+" "+e.pO.__name+" "+n.__name+" "+n.__name+" "+e.pO.__name+" "+e.pB.__name;break;default:throw"Unsupported line sub_type"}t.add_line(i)}function n(t,e,n){e.__out=!0,e.__point2=n.__name,t.add_line("EQDISTANCE "+e.__point1+" "+e.__point2+" "+e.rseg.__point1+" "+e.rseg.__point2)}function i(t,i,r){if("line"==i.type)e(t,i,r);else{if("circle"!=i.type)throw"Unsupported path.type";n(t,i,r)}}!function(t,e){var n=e.path;if(!n.__out)i(t,n,e)}(t,this)}}]),e}(Qo);R(al,{class_name:"PointOnObject",sub_type:"oopt",type_cname:"路径上的点",free_value:1,path:null,t:0,_jpda:["t"]});var sl=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),os(e,[{key:"toString",value:function(){return"(Circle #"+this.obj_id+" O="+this.op+", r="+this.r.toFixed(2)+")"}},{key:"draw",value:function(t,e){var n=this,i=n.label;i&&i.show&&i.draw(t,e);var r=n.r;if(!(r>1e5)){var a=n.op,s=a.x,o=a.y,l=n.highlight?4:n.line_width,u=n.highlight?"#ff0000":n.color;n.valpha<1&&(t.globalAlpha=n.valpha),t.beginPath(),t.lineWidth=l,t.strokeStyle=u,0==n.line_style?(t.arc(s,o,r,0,ds),t.stroke()):$t(t,s,o,r),n.selected&&(t.lineWidth=.5,t.strokeStyle="#ff00ff",r>l/2+2&&(t.beginPath(),t.arc(s,o,r-l/2-2,0,ds),t.closePath(),t.stroke()),t.beginPath(),t.arc(s,o,r+l/2+2,0,ds),t.closePath(),t.stroke()),n.valpha<1&&(t.globalAlpha=1)}}},{key:"hit_test",value:function(t,e){var n=this;if(!n.exist||!n.visible)return!1;var i=n.op,r=t-i.x,a=e-i.y,s=n.get_radius(),o=(n.pad,ms(r*r+a*a)),l=bs(o-s);return l*l<=36}},{key:"rc_hit_test",value:function(t){var e=this;if(!e.exist||!e.visible)return!1;var n=e.op.x,i=e.op.y,r=e.get_radius(),a=r*r,s=t.left,o=t.top,l=t.right,u=t.bottom;if(s<=n-r&&l>=n+r&&o<=i-r&&u>=i+r)return!0;var _=void 0,h=void 0,c=void 0,p=s;if(p>=n-r&&p<=n+r){if(c=ms(a-(p-n)*(p-n)),_=i+c,h=i-c,_>=o&&_<=u)return!0;if(h>=o&&h<=u)return!0}if((p=l)>=n-r&&p<=n+r){if(c=ms(a-(p-n)*(p-n)),_=i+c,h=i-c,_>=o&&_<=u)return!0;if(h>=o&&h<=u)return!0}var f=void 0,v=void 0,d=void 0,y=o;if(y>=i-r&&y<=i+r){if(d=ms(a-(y-i)*(y-i)),f=n+d,v=n-d,f>=s&&f<=l)return!0;if(v>=s&&v<=l)return!0}if((y=u)>=i-r&&y<=i+r){if(d=ms(a-(y-i)*(y-i)),f=n+d,v=n-d,f>=s&&f<=l)return!0;if(v>=s&&v<=l)return!0}return!1}},{key:"center",value:function(){return this.op}},{key:"get_radius",value:function(){return this.r}},{key:"create_ani_pt",value:function(t,e,n,i,r){return new Cs.PointOnCircleAnim(t,e,n,i,r)}},{key:"calc_circum",value:function(){return ds*this.get_radius()}},{key:"calc_area",value:function(){var t=this.get_radius();return t*t*vs}},{key:"random_oopt",value:function(){return Cs.Point.new_oopt(this,(2*Es()-1)*vs)}},{key:"path_info",value:function(){return{min:0,max:ds,closed:!0}}},{key:"calc_point_on",value:function(t){var e=this,n=e.op,i=e.get_radius();return{x:i*ks(t)+n.x,y:i*xs(t)+n.y}}},{key:"calc_tangent_on",value:function(t){var e=this.get_radius();return{x:-e*xs(t),y:e*ks(t)}}},{key:"move_oopt",value:function(t,e){void 0===e.memo[t.obj_id]&&(e.memo[t.obj_id]={t:t.t,x:t.x,y:t.y});var n=e.memo[t.obj_id];if(!this.exist)return!1;var i=n.x+e.cur_x-e.start_x,r=n.y+e.cur_y-e.start_y,a=this.point_proj_info(i,r);return t.t=a.t,!0}},{key:"point_proj_info",value:function(t,e,n){var i=this,r=i.op,a=t-r.x,s=e-r.y;if(0==a&&0==s)return null;var o=ms(a*a+s*s),l=Os(s,a),u=i.get_radius(),_=o-u;return{t:l,d:bs(_),d_p:_,x:r.x+u*ks(l),y:r.y+u*xs(l)}}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=qs(t,{color:this.color,line_width:this.line_width,line_style:this.line_style}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"calc_label_pos",value:function(t){var e=t.pos;e&&2==e.length||(e=[.75,4]);var n=e[0],i=e[1];if(this.op){var r=this.get_radius()+i;t.x=this.op.x+r*ks(n),t.y=this.op.y+r*xs(n)}else t.x=t.y=0}},{key:"set_label_pos",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.75,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;this.label.pos=[t,e]}},{key:"move_label_pos",value:function(t,e){if("down"==e.event)e.old_pos={x:t.x,y:t.y};else{var n=e.old_pos,i=n.x+e.delta_x,r=n.y+e.delta_y;t.x=i,t.y=r;var a=this.label.pos,s=this.point_proj_info(i,r);s?(a[0]=s.t,a[1]=s.d_p):(a[0]=.75,a[1]=4)}}},{key:"sget_name",value:function(){var t=this.get_label();return t||(this.pad&&this.set_label(this.pad.cir_namer.next()),this.get_label())}},{key:"pt_on",value:function(t){var e=l(t,this.op);return!(bs(e-this.get_radius())>fs)&&(t===this.rp||!!this.has_child(t))}},{key:"is_pt_on_circ",value:function(t){return t.path===this||("intpt"===t.sub_type&&(t.obj1===this||t.obj2===this)||t===this.rp)}},{key:"_jgex_circ",value:function(t,e){if(this._children)for(var n=0;n<this._children.length;++n){var i=this._children[n];"point"==i.type&&e.push(i)}if(e.length>=2){for(var r="CIRCLE "+this.op.__name,a=0;a<e.length;++a)r+=" "+e[a].__name;t.add_line(r)}}}]),e}(Xo);R(sl,{type:"circle",sub_type:"circle",type_cname:"圆",line_width:2,line_style:0,color:"#008000",free_value:0,op:null,r:0,path_type:2,layer:2e3,_jpda:["color","line_width","line_style"]}),Ot(sl,[Us]);var ol=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Xo&&n instanceof Xo&&(r.obj1=t,r.obj2=n,r.isel=0===i||1===i||2===i?i:0,r._parents=[t,n],r.update()),r}return us(e,t),os(e,[{key:"unserialize",value:function(){this.obj1=this._parents[0],this.obj2=this._parents[1],this.update()}},{key:"update",value:function(){var t=this.obj1,e=this.obj2;if(t&&e&&(this.exist=t.exist&&e.exist,this.exist)){var n=void 0;if(t instanceof il)if(e instanceof il)n=Et(t,e);else{if(!(e instanceof sl))throw new Error("Unsupported path type");n=zt(t,e)}else{if(!(t instanceof sl))throw new Error("Unsupported path type");if(e instanceof il)n=zt(e,t);else{if(!(e instanceof sl))throw new Error("Unsupported path type");n=Ct(t,e)}}if(n&&n.length){var i=void 0;i=0==this.isel?n[0]:1==this.isel?n[0]:2==this.isel?n.length>1?n[1]:null:n[0],i?(this.exist=i.exist,this.x=i.x,this.y=i.y):(this.exist=!1,this.x=0,this.y=0)}else this.exist=!1,this.x=0,this.y=0}}},{key:"is_on_line",value:function(t){return this.obj1===t||this.obj2===t||ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"is_on_line",this).call(this,t)}},{key:"gsf_name",value:function(){return this.isel?"Intersect"+this.isel:"Intersect"}},{key:"gsf_pars",value:function(){return[this.obj1,this.obj2]}},{key:"to_jgex",value:function(t){function e(t,e,n){var i="";switch(e.__out=!0,e.__point2=n.__name,e.sub_type){case"paral":var r=e.line1;i="ON_PLINE "+n.__name+" "+e.__point1+" "+r.__point1+" "+r.__point2;break;case"perpl":var r=e.line1;i="ON_TLINE "+n.__name+" "+e.__point1+" "+r.__point1+" "+r.__point2;break;case"bisl":i="EQANGLE "+e.pA.__name+" "+e.pO.__name+" "+n.__name+" "+n.__name+" "+e.pO.__name+" "+e.pB.__name;break;default:throw"Unsupported line sub_type"}t.add_line(i)}function n(t,e,n){e.__out=!0,e.__point2=n.__name,t.add_line("EQDISTANCE "+e.__point1+" "+e.__point2+" "+e.rseg.__point1+" "+e.rseg.__point2)}function i(t,i,r){if("line"==i.type)e(t,i,r);else{if("circle"!=i.type)throw"Unsupported path.type";n(t,i,r)}}!function(t,e){var n=e.obj1,r=e.obj2;n.__out||i(t,n,e),r.__out||i(t,r,e);var a="";a="line"==n.type&&"line"==r.type?"INTPT_LL ":"circle"==n.type&&"circle"==r.type?"INTPT_CC ":"INTPT_LC ",a+=e.__name+" "+n.__point1+" "+n.__point2+" "+r.__point1+" "+r.__point2,t.add_line(a)}(t,this)}},{key:"equals_intersect",value:function(t,e,n){if(t===this.obj1&&e===this.obj2&&n==this.isel)return!0;if(t instanceof il&&e instanceof il){if(t===this.obj2&&e===this.obj1)return!0}else{if(t instanceof il&&e instanceof sl)return!1;if(t instanceof sl&&e instanceof il){if(t==this.obj2&&e==this.obj1&&n==this.isel)return!0}else if(t instanceof sl&&e instanceof sl&&t==this.obj2&&e==this.obj1&&n!=this.isel)return!0}return!1}}]),e}(Qo);R(ol,{class_name:"IntersectPoint",sub_type:"intpt",type_cname:"交点",free_value:0,isel:0,_jpda:["isel"]});var ll=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return us(e,t),os(e,[{key:"on_move",value:function(t){var e=t.cur_x-t.last_x,n=t.cur_y-t.last_y;return!(!e&&!n)&&(this.x+=e,this.y+=n,!0)}},{key:"pos_snapshot",value:function(){return{x:this.x,y:this.y}}},{key:"unpos_snapshot",value:function(t){this.x=t.x,this.y=t.y}},{key:"gsf_pars",value:function(){return[this.x,this.y]}}],[{key:"_init_point",value:function(t,e){e&&(t.point_size=Ls.mediumPoint)}},{key:"find_oopt",value:function(t,e){var n=t.children();if(!n||!n.length)return null;for(var i=0;i<n.length;++i){var r=n[i];if(r instanceof al&&r.t==e)return r}return null}},{key:"find_intpt",value:function(t,e,n){var i=t.children();if(!i||!i.length)return null;for(var r=0;r<i.length;++r){var a=i[r];if(a instanceof ol&&a.equals_intersect(t,e,n))return a}return null}},{key:"find_midpt",value:function(t){if(!t)return null;var e=t.children();if(!e)return null;for(var n=0;n<e.length;++n){var i=e[n];if(i instanceof rl&&i.is_midpt_of(t))return i}return null}}]),e}(Qo);ll.FREE_POINT="freept",ll.MID_POINT="midpt",ll.POINT_ON_OBJ="oopt",ll.INTER_POINT="intpt",ll.XFORM_POINT="xfmpt",ll.UNIT_POINT="unpt",ll.SQUARE_UNIT_POINT="squpt",ll.FOOT_POINT="foot",ll.BIS_POINT="bispt",R(ll,{class_name:"Point",sub_type:"freept",type_cname:"自由点",_jpda:["x","y"]});var ul=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),e}(Qo);R(ul,{class_name:"VirtualPoint",sub_type:"vpoint",is_virtual:!0,type_cname:"虚拟点"});var _l=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Uo&&(i.orig_obj=t,i.xformer=n,i._parents=[t],n.add_parents(i._parents),i._move_ctrls=[t],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.orig_obj=this._parents[0],this._move_ctrls=[this.orig_obj]}},{key:"update",value:function(){if(this.exist=this.xformer.defined()&&this.orig_obj.exist,this.exist){var t=this.xformer.transform(this.orig_obj);this.x=t.x,this.y=t.y}}},{key:"gsf_name",value:function(){return this.xformer.gsf_name()}},{key:"gsf_pars",value:function(){return this.xformer.gsf_pars(this.orig_obj)}}]),e}(Qo);R(_l,{class_name:"XformedPoint",sub_type:"xfmpt",type_cname:"变换后的点",free_value:0,orig_obj:null,xformer:null});var hl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&(i.pO=t,i.unit=n>0?n:100,i._parents=[t]),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.pO=this._parents[0]}},{key:"update",value:function(){this.x=this.pO.x+this.unit,this.y=this.pO.y}},{key:"on_move",value:function(t){var e=t.cur_x-t.last_x;return!!e&&(this.unit+=e,this.unit<=1&&(this.unit=1),this.update(),!0)}},{key:"pos_snapshot",value:function(){return this.unit}},{key:"unpos_snapshot",value:function(t){this.unit=t}},{key:"gsf_pars",value:function(){return[this.pO,this.unit]}}]),e}(Qo);R(hl,{class_name:"UnitPoint",sub_type:"unpt",type_cname:"单位点",free_value:1,pO:null,unit:50,_jpda:["unit"]});var cl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof hl&&(n.pU=t,n._parents=[t]),n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.pU=this._parents[0]}},{key:"update",value:function(){var t=this.pU.pO;this.x=t.x,this.y=t.y-this.pU.unit}},{key:"gsf_pars",value:function(){return[this.pU]}}]),e}(Qo);R(cl,{class_name:"SquareUnitPoint",sub_type:"squpt",type_cname:"Y轴单位点",free_value:0,pU:null});var pl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Qo&&(i.p1=t,i.p2=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.p1=this._parents[0],this.p2=this._parents[1]}},{key:"update",value:function(){It(this)}},{key:"gsf_pars",value:function(){return[this.p2,this.p1]}},{key:"is_segment",value:function(t,e){return t===this.p1&&e===this.p2||e===this.p1&&t===this.p2}}]),e}(il);R(pl,{class_name:"Segment",sub_type:"segment",type_cname:"线段",line_type:0,t_range:tl});var fl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Qo&&(i.p1=t,i.p2=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.p1=this._parents[0],this.p2=this._parents[1]}},{key:"update",value:function(){It(this)}},{key:"gsf_pars",value:function(){return[this.p2,this.p1]}},{key:"is_ray",value:function(t,e){return t===this.p1&&e===this.p2}},{key:"as_ray",value:function(t,e){return this.p1===t&&(this.p2===e||this.is_pt_on_line(e))}}]),e}(il);R(fl,{class_name:"Ray",sub_type:"ray",type_cname:"射线",line_type:1,t_range:el});var vl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.p1=new ul,i.p2=new ul,t instanceof il&&n instanceof Qo&&i.init(t,n),i}return us(e,t),os(e,[{key:"init",value:function(t,e){t&&e&&(this.line1=t,this.p3=e,this._parents=[t,e],this._move_ctrls=[e],this.update())}},{key:"unserialize",value:function(){this.line1=this._parents[0],
this.p3=this._parents[1],this._move_ctrls=[this.p3]}},{key:"gsf_pars",value:function(){return this._parents}}]),e}(il);R(vl,{line_type:2,t_range:nl,p3:null,line1:null});var dl=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),os(e,[{key:"update",value:function(){var t=this.line1,e=this.p3;if(this.exist=t.exist&&e.exist,this.exist){var n=(t.p2.x-t.p1.x)/2,i=(t.p2.y-t.p1.y)/2;this.p1.x=e.x-n,this.p1.y=e.y-i,this.p2.x=e.x+n,this.p2.y=e.y+i}}},{key:"is_paral",value:function(t,e){return t===this.line1&&e===this.p3}}]),e}(vl);R(dl,{class_name:"Parallel",sub_type:"paral",type_cname:"平行线"});var yl=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),os(e,[{key:"update",value:function(){var t=this,e=t.line1,n=t.p3;if(t.exist=e.exist&&n.exist,t.exist){var i=-(e.p2.y-e.p1.y)/2,r=(e.p2.x-e.p1.x)/2;t.p1.x=n.x-i,t.p1.y=n.y-r,t.p2.x=n.x+i,t.p2.y=n.y+r}}},{key:"is_perpl",value:function(t,e){return t===this.line1&&e===this.p3}}]),e}(vl);R(yl,{class_name:"Perpendicular",sub_type:"perpl",type_cname:"垂线"});var gl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.p1=new ul(0,0),r.p2=new ul(0,0),t instanceof Qo&&n instanceof Qo&&i instanceof Qo&&(r.pA=t,r.pO=n,r.pB=i,r._parents=[t,n,i],r.update()),r}return us(e,t),os(e,[{key:"unserialize",value:function(){this.pA=this._parents[0],this.pO=this._parents[1],this.pB=this._parents[2]}},{key:"update",value:function(){this.p1=this.pO;var t=k(this.pA,this.pO,this.pB);t?(this.exist=!0,this.p2.x=t.x,this.p2.y=t.y):this.exist=!1}},{key:"gsf_pars",value:function(){return this._parents}},{key:"is_bisl",value:function(t,e,n){return e==this.pO&&(t==this.pA&&n==this.pB||n==this.pA&&t==this.pB)}},{key:"is_bisl_ex",value:function(t,e,n){return!(e.indexOf(this.pO)<0)&&(t.indexOf(this.pA)>=0&&n.indexOf(this.pB)>=0||n.indexOf(this.pA)>=0&&t.indexOf(this.pB)>=0)}},{key:"as_ray",value:function(t,e){return this.pO===t&&this.is_pt_on_line(e)}},{key:"as_bisl",value:function(t,e){return this.pO===t&&this.is_pt_on_line(e)}}]),e}(fl);R(gl,{class_name:"Bisector",sub_type:"bisl",type_cname:"角平分线",line_type:1,t_range:el,pA:null,pO:null,pB:null});var bl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Qo&&(i.p1=t,i.p2=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.p1=this._parents[0],this.p2=this._parents[1]}},{key:"update",value:function(){It(this)}},{key:"gsf_pars",value:function(){return[this.p2,this.p1]}},{key:"is_sline",value:function(t,e){return t===this.p1&&e===this.p2||e===this.p1&&t===this.p2}}],[{key:"new_seg",value:function(t,e){return new pl(t,e)}},{key:"new_ray",value:function(t,e){return new fl(t,e)}},{key:"new_sline",value:function(t,n){return new e(t,n)}},{key:"new_paral",value:function(t,e){return new dl(t,e)}},{key:"new_perpl",value:function(t,e){return new yl(t,e)}},{key:"new_bisl",value:function(t,e,n){return new gl(t,e,n)}},{key:"find_seg",value:function(t,e){return Nt(t,function(n){return n instanceof il&&n.is_segment(t,e)})}},{key:"find_ray",value:function(t,e){return Nt(t,function(n){return n instanceof il&&n.is_ray(t,e)})}},{key:"find_sline",value:function(t,e){return Nt(t,function(n){return n instanceof il&&n.is_sline(t,e)})}},{key:"find_paral",value:function(t,e){return Nt(t,function(n){return Bt(n)&&n.is_paral(t,e)})}},{key:"find_perpl",value:function(t,e){return Nt(t,function(n){return Bt(n)&&n.is_perpl(t,e)})}},{key:"find_bisl",value:function(t,e,n){return Nt(e,function(i){return Bt(i)&&i.is_bisl(t,e,n)})}}]),e}(il);bl.LINE_TYPE="line",bl.SEGMENT="segment",bl.RAY="ray",bl.SLINE="sline",bl.PARAL="paral",bl.PERPL="perpl",bl.BISL="bisl",R(bl,{class_name:"Line",sub_type:"sline",type_cname:"直线",line_type:2,t_range:nl});var ml=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof il&&n instanceof Uo&&i.init(t,n),i}return us(e,t),os(e,[{key:"init",value:function(t,e){var n=this;if(n.p1=new ul,n.p2=new ul,t&&e){switch(t.line_type){case 0:n.sub_type="segment";break;case 1:n.sub_type="ray";break;case 2:n.sub_type="sline"}n.line_type=t.line_type,n.t_range=t.t_range,n.orig_obj=t,n.xformer=e,n._parents=[t],e.add_parents(n._parents),n._move_ctrls=[t],n.update()}}},{key:"unserialize",value:function(){this.init(this._parents[0],this.xformer)}},{key:"update",value:function(){var t=this,e=t.orig_obj,n=t.xformer;if(t.exist=e.exist&&n.defined(),t.exist){var i=n.transform(e.p1);t.p1.x=i.x,t.p1.y=i.y;var r=n.transform(e.p2);t.p2.x=r.x,t.p2.y=r.y,t.p1.x==t.p2.x&&t.p1.y==t.p2.y&&(t.exist=!1)}}},{key:"gsf_name",value:function(){return this.xformer.class_name}},{key:"gsf_pars",value:function(){return this.xformer.gsf_pars(this.orig_obj)}}]),e}(il);R(ml,{class_name:"XformedLine",sub_type:"segment",type_cname:"变换后的线",line_type:0,t_range:tl});var xl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Qo&&(i.op=t,i.rp=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.op=this._parents[0],this.rp=this._parents[1]}},{key:"update",value:function(){var t=this;t.exist=t.op.exist&&t.rp.exist,t.r=l(t.op,t.rp),0==t.r&&(t.exist=!1)}},{key:"is_circle",value:function(t,e){return this.op===t&&this.rp===e}},{key:"gsf_pars",value:function(){return this._parents}},{key:"to_jgex_1",value:function(t){var e=this;e.__out=!0,e.__point1=e.op.__name,e.__point2=e.rp.__name,e._jgex_circ(t,[e.rp])}},{key:"sget_name",value:function(){var t=this.get_label();return t||(t="⊙"+this.op.sget_name()+this.rp.sget_name())}}],[{key:"new_circle",value:function(t,n){return new e(t,n)}},{key:"find_circle",value:function(t,n){var i=t.children();if(!i)return null;for(var r=0,a=i.length,s=void 0;r<a;++r)if((s=i[r])instanceof e&&s.is_circle(t,n))return s}}]),e}(sl);R(xl,{class_name:"Circle",sub_type:"circle",op:null,rp:null,_jpda:[]});var kl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.init(t,n),i}return us(e,t),os(e,[{key:"init",value:function(t,e){t instanceof Qo&&e instanceof il&&(this.op=t,this.rseg=e,this._parents=[t,e],this._move_ctrls=[t],this.update())}},{key:"unserialize",value:function(){this.op=this._parents[0],this.rseg=this._parents[1],this._move_ctrls=[this.op]}},{key:"update",value:function(){var t=this;t.exist=t.op.exist&&t.rseg.exist,t.exist?(t.r=t.rseg.leng(),t.r<fs&&(t.exist=!1,t.r=0)):t.r=0}},{key:"is_circ_r",value:function(t,e){return this.op==t&&this.rseg==e}},{key:"gsf_name",value:function(){return"Circle by radius"}},{key:"gsf_pars",value:function(){return[this.op,this.rseg]}},{key:"to_jgex_1",value:function(t){var e=this;e.__out=!1,e.__point1=this.op.__name,e._jgex_circ(t,[])}}],[{key:"fd_circ_r",value:function(t,n){var i=t.children();if(!i)return null;for(var r=0;r<i.length;++r){var a=i[r];if(a instanceof e&&a.is_circ_r(t,n))return a}return null}}]),e}(sl);R(kl,{class_name:"CircleByRadius",sub_type:"circ_r"});var wl=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.op=new ul,i.r=0,t instanceof sl&&n instanceof Uo&&(i.orig_obj=t,i.xformer=n,i._parents=[t],n.add_parents(i._parents),i._move_ctrls=[t],i.update()),i}return us(e,t),os(e,[{key:"update",value:function(){var t=this;if(t.exist=t.orig_obj.exist&&t.xformer.defined(),t.exist){var e=t.xformer.transform(t.orig_obj.op);this.op.x=e.x,this.op.y=e.y,t.r=t.xformer.trans_leng(t.orig_obj.get_radius()),(!t.r||t.r<0)&&(t.exist=!1)}}},{key:"gsf_name",value:function(){return this.xformer.gsf_name()}},{key:"gsf_pars",value:function(){return this.xformer.gsf_pars(this.orig_obj)}}]),e}(sl);R(wl,{class_name:"XformedCircle",sub_type:"xfm_circ",free_value:0});var jl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof sl&&(n.cr=t,n.op=t.op,n.r=t.get_radius(),n._parents=[t],n.update()),n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.cr=this._parents[0]}},{key:"draw",value:function(t){var e=this;if(e.exist){var n=e.op,i=n.x,r=n.y,a=e.r,s=e.color;t.globalAlpha=e.valpha*e.alpha,t.beginPath(),t.fillStyle=s,t.arc(i,r,a,0,ds),t.fill(),t.globalAlpha=1,e.selected&&At(t)}}},{key:"update",value:function(){(this.exist=this.cr.exist)&&(this.op=this.cr.op,this.r=this.cr.get_radius())}},{key:"hit_test",value:function(t,e){var n=this.op,i=n.x-t,r=n.y-e,a=i*i+r*r,s=this.r;return a<=s*s}},{key:"rc_hit_test",value:function(t){var e=t.left,n=t.top,i=t.right,r=t.bottom,a=this.op,s=a.x,o=a.y,l=this.r,u=l*l;if(e>s+l||i<s-l||n>o+l||r<o-l)return!1;if(e<=s-l&&n<=o-l&&i>=s+l&&r>=o+l)return!0;var _=e-s,h=n-o,c=_*_+h*h;if(c<u)return!0;if(h=r-o,(c=_*_+h*h)<u)return!0;if(_=i-s,(c=_*_+h*h)<u)return!0;if(h=n-o,(c=_*_+h*h)<u)return!0;if(n<o&&r>o){if(e>s-l&&e<s+l)return!0;if(i>s-l&&i<s+l)return!0}if(e<s&&i>s){if(n>o-l&&n<o+l)return!0;if(r>o-l&&r<o+l)return!0}return!1}},{key:"get_radius",value:function(){return this.r}},{key:"calc_area",value:function(){return vs*this.r*this.r}},{key:"gsf_name",value:function(){return"Circle interior"}},{key:"gsf_pars",value:function(){return[this.cr]}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=qs(t,{color:this.color}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}}]),e}(Xo);R(jl,{class_name:"CircleInterior",type:"interior",sub_type:"cir_interior",color:"#c0c0c0",layer:500,alpha:.3,cr:null,_jpda:["color","alpha"]});var Ol=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof hl&&(i.p1=t,i.p2=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.p1=this._parents[0],this.p2=this._parents[1]}},{key:"draw",value:function(t,e){this.p1&&this.p2&&e&&this.draw_line(e,t,-1,this.p1.y,e.width+1,this.p2.y)}},{key:"get_origin_point",value:function(){return this.p1}},{key:"get_unit_point",value:function(){return this.p2}},{key:"get_unit",value:function(){return this.p2.x-this.p1.x}},{key:"gsf_pars",value:function(){return[this.p1,this.p2]}}]),e}(il);R(Ol,{class_name:"HorizontalAxis",type:"axis",sub_type:"h_axis",line_width:.3,free_value:0});var Pl=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Qo&&(i.p1=t,i.p2=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.p1=this._parents[0],this.p2=this._parents[1]}},{key:"draw",value:function(t,e){this.p1&&this.p2&&e&&this.draw_line(e,t,this.p1.x,e.height+1,this.p2.x,-1)}},{key:"gsf_pars",value:function(){return[this.p1,this.p2]}}]),e}(il);R(Pl,{class_name:"VerticalAxis",type:"axis",sub_type:"v_axis",free_value:0,line_width:.3});var $l=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Ol&&n instanceof Pl&&(i.h_axis=t,i.v_axis=n,i._parents=[t,n],i.update()),i}return us(e,t),os(e,[{key:"unserialize",value:function(){this.h_axis=this._parents[0],this.v_axis=this._parents[1]}},{key:"update",value:function(){var t=this.h_axis,e=t.get_origin_point();this.x0=e.x,this.y0=e.y,this.unit=t.get_unit()}},{key:"get_unit",value:function(){return this.unit}},{key:"x2unit",value:function(t){return(t-this.x0)/this.unit}},{key:"y2unit",value:function(t){return(this.y0-t)/this.unit}},{key:"on_delete",value:function(){this.pad._coord===this&&(this.pad._coord=null)}},{key:"gsf_pars",value:function(){return[this.h_axis,this.v_axis]}},{key:"gsf_props",value:function(){return ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,{color:this.color})}}]),e}(Xo);R($l,{class_name:"CoordSysByAxes",type:"coord",sub_type:"axis_coord",unit:100});var Al=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),os(e,[{key:"valueOf",value:function(){return this.value}},{key:"radius",value:function(){return this.r}},{key:"draw",value:function(t,e){var n=this;if(n.exist&&n.visible){var i=n.get_radius();if(!(i>1e5)){var r=n.highlight?4:n.line_width,a=n.highlight?"#ff0000":n.color;n.valpha<1&&(t.globalAlpha=n.valpha);var s=n.op,o=s.x,l=s.y,u=n.start_angle,_=n.end_angle;t.beginPath(),t.arc(o,l,i,u,_,!1),t.lineWidth=r,t.strokeStyle=a,t.stroke(),n.selected&&(t.lineWidth=.5,t.strokeStyle="#ff00ff",i>r/2+2&&(t.beginPath(),t.arc(o,l,i-r/2-2,u,_,!1),t.stroke()),t.beginPath(),t.arc(o,l,i+r/2+2,u,_,!1),t.stroke()),n.valpha<1&&(t.globalAlpha=1)}}}},{key:"hit_test",value:function(t,e){if(!this.exist)return!1;var n=this.op,i=t-n.x,r=e-n.y,a=i*i+r*r,s=ms(a);if(bs(s-this.r)>3.5)return!1;var o=_(i,r);return this._in_arc(o)}},{key:"rc_hit_test",value:function(t){var e=this;e._min_rc||(e._min_rc=Ft.call(e));var n=t.left,i=t.top,r=t.right,a=t.bottom,s=e._min_rc;return!(n>s.right||r<s.left||i>s.bottom||a<s.top)&&(n<=s.left&&r>=s.right&&i<=s.top&&a>=s.bottom||qt(e,t))}},{key:"gsf_props",value:function(t){return t=qs(t,{color:this.color,line_width:this.line_width,line_style:this.line_style}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"path_info",value:function(){return{min:0,max:0,closed:!1}}},{key:"calc_point_on",value:function(t){var e=this;if(!e.exist||t<0||t>1)return null;var n=e.op,i=e.get_radius(),r=e.value*t+e.start_angle;return r>=2*vs&&(r-=2*vs),{x:n.x+i*ks(r),y:n.y+i*xs(r)}}},{key:"calc_tangent_on",value:function(t){return{x:0,y:0}}},{key:"move_oopt",value:function(t,e){var n=e.memo[t.obj_id];void 0===n&&(n=e.memo[t.obj_id]={t:t.t,x:t.x,y:t.y});var i=n.x+e.cur_x-e.start_x,r=n.y+e.cur_y-e.start_y,a=this.point_proj_info(i,r);return!!a&&(t.t=a.t,!0)}},{key:"point_proj_info",value:function(t,e,n){var i=this.op,r=this.get_radius(),a=t-i.x,s=e-i.y,o=this.start_angle,l=this.end_angle,u=void 0,c=void 0,p=void 0,f=void 0;if(0==a&&0==s)c=0,u=o;else{u=_(a,s);var v=u-o;if(v<0&&(v=2*vs+v),v<=this.value)c=v/this.value;else{if(o<=l){c=h((o+l)/2,u)>vs?0:1}else c=o-u>u-l?1:0;u=1==c?l:o}}return p=i.x+r*ks(u),f=i.y+r*xs(u),{t:c,x:p,y:f}}},{key:"random_oopt",value:function(){return ll.new_oopt(this,Es())}},{key:"create_ani_pt",value:function(t,e,n,i,r){return new Cs.PointOnStraightAnim(t,e,n,i,r)}},{key:"get_radius",value:function(){return this.r}},{key:"get_radian",value:function(){return this.value}}]),e}(Xo);R(Al,{class_name:"ArcBase",type:"arc",type_cname:"弧",color:"#008000",free_value:0,line_style:0,line_width:2,path_type:3,layer:2e3,op:null,r:0,start_angle:0,end_angle:0,value:0,_jpda:["color","line_style","line_width"],_in_arc:Rt}),Ot(Al,[Us]);var Sl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));if(t instanceof sl&&n instanceof Qo&&i instanceof Qo){var a=r;a.cr=t,a.p1=n,a.p2=i,a.start_pt=n,a.end_pt=i,a._parents=[t,n,i],a.update()}return r}return us(e,t),os(e,[{key:"unserialize",value:function(){this.cr=this._parents[0],this.start_pt=this.p1=this._parents[1],this.end_pt=this.p2=this._parents[2],this.start_angle=this.end_angle=0}},{key:"update",value:function(){var t=this,e=t.cr,n=t.p1,i=t.p2;if(t._min_rc=null,!(e&&n&&i&&e.exist&&n.exist&&i.exist))return t.r=t.value=0,void(t.exist=!1);var r=t.op=e.op;t.r=e.get_radius();var a=t.start_angle=u(i.x-r.x,i.y-r.y),s=t.end_angle=u(n.x-r.x,n.y-r.y);t.value=Mt(s,a)}},{key:"gsf_pars",value:function(){return[this.cr,this.p1,this.p2]}},{key:"sget_name",value:function(){var t=this.get_label();return t||("point"==this.p1.type&&"point"==this.p2.type?"\\overarc{"+this.p1.sget_name()+this.p2.sget_name()+"}":(this.set_label(this.pad.ln_namer.next()),this.get_label()))}}]),e}(Al);R(Sl,{class_name:"Arc",sub_type:"arc"});var Tl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));if(t instanceof Qo&&n instanceof Qo&&i instanceof Qo){var a=r;a.p1=t,a.p2=n,a.p3=i,a.start_pt=t,a.end_pt=i,a._parents=[t,n,i],a.update()}return r}return us(e,t),os(e,[{key:"unserialize",value:function(){this.start_pt=this.p1=this._parents[0],this.p2=this._parents[1],this.end_pt=this.p3=this._parents[2],this.start_angle=this.end_angle=0}},{key:"update",value:function(){function t(){return e.r=e.value=0,e.exist=!1,e}var e=this,n=e.p1,i=e.p2,r=e.p3;if(!(n.exist&&i.exist&&r.exist))return t();var a=d(n,i,r);if(!a)return t();e.op=new ul(a.x,a.y),e.exist=!0,e.r=(l(a,n)+l(a,i)+l(a,r))/3;var s=u(n.x-a.x,n.y-a.y),o=u(i.x-a.x,i.y-a.y),_=u(r.x-a.x,r.y-a.y);e.dif12=h(s,o),e.dif13=h(s,_),e.clockwise=e.dif12>e.dif13,e.clockwise?(e.start_angle=_,e.end_angle=s,e.start_pt=e.p3,e.end_pt=e.p1):(e.start_angle=s,e.end_angle=_,e.start_pt=e.p1,e.end_pt=e.p3),e.value=Mt(e.end_angle,e.start_angle)}},{key:"gsf_pars",value:function(){return[this.p1,this.p2,this.p3]}},{key:"sget_name",value:function(){var t=this.get_label();return t||("point"==this.p1.type&&"point"==this.p2.type&&"point"==this.p3.type?"\\overarc{"+this.p1.sget_name()+this.p2.sget_name()+this.p3.sget_name()+"}":(this.set_label(this.pad.ln_namer.next()),this.get_label()))}}]),e}(Al);R(Tl,{class_name:"ArcByThreePoint",sub_type:"arc3"});var El=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),os(e,[{key:"get_radius",value:function(){return this.r}},{key:"get_radian",value:function(){return this.value}},{key:"sget_name",value:function(){var t=this.get_label();return t||(this.arc.sget_name?this.arc.sget_name():(this.set_label(this.pad.ln_namer.next()),this.get_label()))}}]),e}(Xo);R(El,{class_name:"SecBase",type:"sec",free_value:0,color:"#c0c0c0",layer:500,_in_arc:Rt});var zl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Al&&(n.arc=t,n._parents=[t],n.update()),n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.arc=this._parents[0]}},{key:"update",value:function(){var t=this,e=t.arc;t.exist=e&&e.exist,t._min_rc=null,t.exist?(t.op=e.op,t.r=e.r,t.start_angle=e.start_angle,t.end_angle=e.end_angle,t.value=e.value):t.value=0}},{key:"draw",value:function(t,e){var n=this,i=n.arc,r=i.op,a=i.r,s=i.start_angle,o=i.end_angle;t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(r.x+a*ks(s),r.y+a*xs(s)),t.arc(r.x,r.y,a,s,o),t.globalAlpha=n.valpha,t.fillStyle=n.color,t.fill(),t.globalAlpha=1,n.selected&&At(t)}},{key:"hit_test",value:function(t,e){var n=this.op,i=t-n.x,r=e-n.y,a=this.r;if(i*i+r*r>a*a)return!1;var s=u(i,r);return this._in_arc(s)}},{key:"rc_hit_test",value:function(t){var e=t.left,n=t.top,i=t.right,r=t.bottom,a=this.op,s=a.x,o=a.y,l=this.r,u=this.start_angle,_=this.end_angle,h=this.get_min_rc();if(e>h.right||i<h.left||n>h.bottom||r<h.top)return!1;if(e<=h.left&&i>=h.right&&n<=h.top&&r>=h.bottom)return!0;if(this.hit_test(e,n)||this.hit_test(e,r)||this.hit_test(i,n)||this.hit_test(i,r))return!0;var c=s+l*ks(u),p=o+l*xs(u);return!!Dt(t,s,o,c,p)||(c=s+l*ks(_),p=o+l*xs(_),!!Dt(t,s,o,c,p)||qt(this,t))}},{key:"gsf_pars",value:function(){return[this.arc]}},{key:"gsf_props",value:function(t){return t=qs(t,{color:this.color}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"get_min_rc",value:function(){function t(t,n){e.left>t&&(e.left=t),e.right<t&&(e.right=t),e.top>n&&(e.top=n),e.bottom<n&&(e.bottom=n)}var e=this._min_rc;if(!e){var n=this.op,i=n.x,r=n.y,a=this.r,s=this.start_angle,o=this.end_angle;e={left:i,top:r,right:i,bottom:r},t(i+a*ks(s),r+a*xs(s)),t(i+a*ks(o),r+a*xs(o)),this._in_arc(0)&&t(i+a,r),this._in_arc(vs/2)&&t(i,r+a),this._in_arc(vs)&&t(i-a,r),this._in_arc(3*vs/2)&&t(i,r-a),this._min_rc=e}return e}},{key:"calc_perimeter",value:function(){return(2+this.value)*this.r}},{key:"calc_area",value:function(){var t=this.r;return this.value*t*t/2}}]),e}(El);R(zl,{class_name:"Sector",sub_type:"sec",type_cname:"扇形",color:"#008000",valpha:.3,_jpda:["color","valpha"]});var Cl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Al&&(n.arc=t,n._parents=[t],n.update()),n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.arc=this._parents[0]}},{key:"update",value:function(){var t=this.arc;this.exist=t.exist,this._min_rc=null,this.exist?(this.op=t.op,this.r=t.r,this.start_angle=t.start_angle,this.end_angle=t.end_angle,this.value=t.value):this.value=0}},{key:"draw",value:function(t,e){var n=this,i=n.arc,r=i.op,a=i.r,s=i.start_angle,o=i.end_angle;t.beginPath(),t.moveTo(r.x+a*ks(s),r.y+a*xs(s)),t.arc(r.x,r.y,a,s,o),t.globalAlpha=this.valpha,t.fillStyle=this.color,t.fill(),t.globalAlpha=1,n.selected&&At(t)}},{key:"hit_test",value:function(t,e){if(!this.exist)return!1;var n=this.op,i=t-n.x,r=e-n.y,a=this.r;if(i*i+r*r>a*a)return!1;var s=u(i,r);if(this.value>vs){if(this._in_arc(s))return!0}else if(!this._in_arc(s))return!1;var o={x:a*ks(this.start_angle),y:a*xs(this.start_angle)},l={x:a*ks(this.end_angle),y:a*xs(this.end_angle)},_={x:0,y:0},h=x(i,r,_,o,l);return this.value>vs?h:!h}},{key:"rc_hit_test",value:function(t){var e=t.left,n=t.top,i=t.right,r=t.bottom,a=this.op,s=a.x,o=a.y,l=this.r,u=this.start_angle,_=this.end_angle,h=this.get_min_rc();return!(e>h.right||i<h.left||n>h.bottom||r<h.top)&&(e<=h.left&&i>=h.right&&n<=h.top&&r>=h.bottom||(!!(this.hit_test(e,n)||this.hit_test(e,r)||this.hit_test(i,n)||this.hit_test(i,r))||(!!Dt(t,s+l*ks(u),o+l*xs(u),s+l*ks(_),o+l*xs(_))||qt(this,t))))}},{key:"gsf_pars",value:function(){return[this.arc]}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=qs(t,{color:this.color}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"get_min_rc",value:function(){function t(t,n){e.left>t&&(e.left=t),e.right<t&&(e.right=t),e.top>n&&(e.top=n),e.bottom<n&&(e.bottom=n)}var e=this._min_rc;if(!e){var n=this.op,i=n.x,r=n.y,a=this.r,s=this.start_angle,o=this.end_angle,l=i+a*ks(s),u=r+a*xs(s);e={left:l,top:u,right:l,bottom:u},t(i+a*ks(o),r+a*xs(o)),this._in_arc(0)&&t(i+a,r),this._in_arc(vs/2)&&t(i,r+a),this._in_arc(vs)&&t(i-a,r),this._in_arc(3*vs/2)&&t(i,r-a),this._min_rc=e}return e}},{key:"calc_perimeter",value:function(){var t=this.r,e=this.value;return t*e+2*t*xs(e/2)}},{key:"calc_area",value:function(){var t=this.r,e=this.value,n=e<vs?e:2*vs-e,i=e*t*t/2,r=t*t*xs(n)/2;return e<vs?i-r:i+r}}]),e}(El);R(Cl,{class_name:"Arched",sub_type:"arch",type_cname:"弓形",color:"#008000",valpha:.3,_jpda:["color","valpha"]});var Il=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t&&t.length>=3&&(n.vertexs=n._parents=t.slice(0),n.rect=new Bs(0,0,0,0),n.update()),n}return us(e,t),os(e,[{key:"unserialize",value:function(){this.vertexs=this._parents}},{key:"update",value:function(){var t=this;t.exist=!1;var e=t.vertexs;if(e&&!(e.length<3)){for(var n=t.rect=new Bs(ys,ys,gs,gs),i=0;i<e.length;++i){var r=e[i];if(!r.exist)return;r.x<n.left&&(n.left=r.x),r.x>n.right&&(n.right=r.x),r.y<n.top&&(n.top=r.y),r.y>n.bottom&&(n.bottom=r.y)}t.exist=!0}}},{key:"draw",value:function(t,e){var n=this;if(n.exist){var i=n.vertexs,r=i.length;if(!(r<3)){t.beginPath(),t.moveTo(i[0].x,i[0].y);for(var a=1;a<r;++a)t.lineTo(i[a].x,i[a].y);t.globalAlpha=.3*n.valpha,t.fillStyle=n.color,t.fill("evenodd"),t.globalAlpha=1,n.selected&&At(t,"evenodd")}}}},{key:"hit_test",value:function(t,e){return!!this.exist&&this._pt_hit(t,e)}},{key:"_pt_hit",value:function(t,e){var n=this.rect;if(t<n.left||t>n.right||e<n.top||e>n.bottom)return!1;var i=!1,r=this.vertexs,a=r.length,s=a-1;if(3==a)return x(t,e,r[0],r[1],r[2]);for(var o=0;o<a;s=o++){var l=r[o],u=r[s];l.y>e!=u.y>e&&t<(u.x-l.x)*(e-l.y)/(u.y-l.y)+l.x&&(i=!i)}return i}},{key:"rc_hit_test",value:function(t){var e=t.left,n=t.top,i=t.right,r=t.bottom,a=this.rect;if(e>a.right||i<a.left||n>a.bottom||r<a.top)return!1;if(e<=a.left&&i>=a.right&&n<=a.top&&r>=a.bottom)return!0;for(var s=this.vertexs,o=s.length,l=0,u=o-1;l<o;u=l++){var _=s[l],h=_.x,c=_.y,p=s[u],f=p.x,v=p.y,d=f-h,y=v-c,g=void 0,b=void 0;do{if(c<n&&v<n||c>n&&v>n||h<e&&f<e||h>i&&f>i)break;if(g=(n-c)*d/y+h,e<=g&&g<=i)return!0}while(0);do{if(c<r&&v<r||c>r&&v>r||h<e&&f<e||h>i&&f>i)break;if(g=(r-c)*d/y+h,e<=g&&g<=i)return!0}while(0);do{if(h<e&&f<e||h>e&&f>e||c<n&&v<n||c>r&&v>r)break;if(b=(e-h)*y/d+c,n<=b&&b<=r)return!0}while(0);do{if(h<i&&f<i||h>i&&f>i||c<n&&v<n||c>r&&v>r)break;if(b=(i-h)*y/d+c,n<=b&&b<=r)return!0}while(0)}return e>a.left&&i<a.right&&n>a.top&&r<a.bottom&&(!!this._pt_hit(e,n)&&(!!this._pt_hit(i,n)&&(!!this._pt_hit(e,r)&&!!this._pt_hit(i,r))))}},{key:"calc_perimeter",value:function(){var t=this,e=t.vertexs;if(!e)return 0;for(var n=e.length,i=0,r=e[0],a=void 0,s=1;s<n;++s)a=e[s],i+=l(r,a),r=a;return i+=l(r,e[0])}},{key:"calc_area",value:function(){return Lt(this.vertexs)}},{key:"gsf_pars",value:function(){return this.vertexs}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=qs({color:this.color}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"sget_name",value:function(){var t=this.get_label();if(t)return t;var e=this.vertexs;t="";for(var n=0;n<e.length;++n)t+=e[n].sget_name();return 3==e.length?"△"+t:t}},{key:"is_convex_polygon",value:function(){for(var t=this.vertexs,e=t.length,n=0,i=0;i<e;++i)for(var r=i,a=i+1==e?0:i+1,s=t[r],o=t[a],l=0;l<e;++l)if(l!=r&&l!=a){var u=Xt(s,o,t[l]);if(0===u)return!1;if(0!==n){if(n!==u)return!1}else n=u}return!0}}]),e}(Xo);R(Il,{class_name:"Polygon",type:"polygon",sub_type:"polygon",free_value:0,type_cname:"多边形",layer:500,color:"#008000",valpha:.3,_jpda:["color","valpha"]});var Bl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.left=t,a.top=n,a.text=i,a.mode=r,a.width=0,a.height=a.font_size+2*a.padding,a}return us(e,t),os(e,[{key:"update",value:function(){!this.width&&this.pad&&this.pad.ctx&&(0==this.mode?this._upd_0(this.pad.ctx):this._boxlize(this.pad.ctx))}},{key:"draw",value:function(t,e){0==this.mode?this.draw_text(t):this.render_tex(t,e)}},{key:"draw_text",value:function(t){var e=this,n=e.text.split("\n"),i=e.font_size,r=e.padding;t.font=i+"px "+e.font_family,e.width<=0&&e._upd_0(t),e.selected&&e.draw_sel(t),t.textBaseline="top",t.fillStyle=e.color;for(var a=e.left+r,s=e.top+r,o=0;o<n.length;++o)t.fillText(n[o],a,s),s+=i}},{key:"render_tex",value:function(t,e){var n=this.padding;if(this.width||this._boxlize(t),this.selected&&this.draw_sel(t),this.error_text)return t.textBaseline="top",t.fillStyle="red",void t.fillText(this.error_text,this.left,this.top);if(this.boxes){t.textBaseline="alphabetic",t.fillStyle=t.strokeStyle=this.color;for(var i=this.left+n,r=this.top+n,a=0;a<this.boxes.length;++a){var s=this.boxes[a];s.draw(t,i,r+s.height),r+=s.height+s.depth+n}}}},{key:"_upd_0",value:function(t){for(var e=this.text.split("\n"),n=e.length,i=2*this.padding,r=-1,a=0;a<n;++a){var s=t.measureText(e[a]).width;s>r&&(r=s)}this.width=r+i,this.height=n*this.font_size+i}},{key:"_boxlize",value:function(t){var e=this.padding,n=this.text.split(/\\newln\s*/),i=new eo(t,0,this.font_size),r=[];try{for(var a=0,s=0,o=0;o<n.length;++o){var l=new Ro(n[o]),u=dt(l.parse()),_=u.create_box(i);a<_.width&&(a=_.width),s+=_.height+_.depth+e,r.push(_)}this.boxes=r,this.width=a+2*e,this.height=s+2*e,this.error_text=null}catch(n){this.error_text=""+n,this.width=t.measureText(this.error_text).width+2*e,this.height=this.font_size+2*e}}},{key:"draw_sel",value:function(t){t.beginPath(),t.lineWidth=.5,t.strokeStyle="#000000",t.rect(this.left,this.top,this.width,this.height),t.stroke(),t.beginPath(),t.fillStyle="#ff00ff",t.rect(this.left+2,this.top+2,this.width-4,this.height-4),t.fill()}},{key:"hit_test",value:function(t,e){return!(!this.exist||!this.visible)&&(t>this.left&&e>=this.top&&t<=this.left+this.width&&e<=this.top+this.height)}},{key:"rc_hit_test",value:function(t){return Yt(this,t)}},{key:"get_text",value:function(){return this.text}},{key:"set_text",value:function(t){this.text!==t&&(this.text=t,this.error_text=null,this.boxes=null,this.width=this.height=0)}},{key:"on_move",value:function(t){return Ut(this,t)}}]),e}(Xo);R(Bl,{class_name:"TextBase",free_value:2,type:"text",color:"#000000",font_size:16,font_family:"Times New Roman",padding:3,left:0,top:0,width:0,height:0});var Nl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,r))}return us(e,t),os(e,[{key:"gsf_pars",value:function(){return[this.left,this.top,this.text,this.mode]}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return qs(t,{color:this.color}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"get_prop_pages",value:function(){return{0:"object",1:"label",2:"text",length:3,Default:"text"}}},{key:"init_text_ppage",value:function(t){t.set_fixed_text(this.get_text())}},{key:"apply_text_change",value:function(t){this.set_text(t.text)}}]),e}(Bl);R(Nl,{class_name:"FixedText",free_value:2,type:"text",sub_type:"fixed",type_cname:"文本",color:"#000000",_jpda:["left","top","text","mode"]});var Ml=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;ss(this,e);var s=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Qo&&n instanceof Qo&&i instanceof Qo&&(s.pA=t,s.pO=n,s.pB=i,s.style=Ht(r),s.a_sel=Ht(a),
s.is_Rt=!1,s.value=0,s._parents=[t,n,i],s.update()),s}return us(e,t),os(e,[{key:"unserialize",value:function(){this.pA=this._parents[0],this.pO=this._parents[1],this.pB=this._parents[2]}},{key:"update",value:function(){var t=this,e=t._parents[0],n=t._parents[1],i=t._parents[2];if(t.exist=!1,e&&n&&i&&e.exist&&n.exist&&i.exist){var r=u(e.x-n.x,e.y-n.y),a=u(i.x-n.x,i.y-n.y),s=h(r,a),o=s>vs?s-vs:s;t.is_Rt=bs(o-vs/2)<fs,2==t.a_sel?(t.value=s>vs?s:2*vs-s,s>=vs?(t.start_angle=r,t.end_angle=a):(t.start_angle=a,t.end_angle=r)):3==t.a_sel?(t.value=s,t.start_angle=r,t.end_angle=a):4==t.a_sel?(t.value=2*vs-s,t.start_angle=a,t.end_angle=r):(t.a_sel=1,t.value=s>vs?2*vs-s:s,s>vs?(t.start_angle=a,t.end_angle=r):(t.start_angle=r,t.end_angle=a)),t.value=t.value,t.exist=!0}}},{key:"valueOf",value:function(){return this.value}},{key:"draw",value:function(t,e){this.label&&this.label.show&&this.label.draw(t,e),this.is_Rt?this.draw_rt(t,e):this.draw_arc(t,e)}},{key:"draw_rt",value:function(t,e){var n=this,i=n.selected||n.highlight?"#ff00ff":n.color,r=ks(n.start_angle),a=xs(n.start_angle),s=ks(n.end_angle),o=xs(n.end_angle),l=n.pO,u=l.x,_=l.y,h=u+16*r,c=_+16*a,p=u+16*s,f=_+16*o,v=h+p-u,d=c+f-_,y=n.start_arrow||n.end_arrow;t.beginPath(),t.moveTo(u,_),t.lineTo(h,c),t.lineTo(v,d),t.lineTo(p,f),t.closePath(),t.globalAlpha=.3*n.valpha,t.fillStyle=i,t.fill(),t.globalAlpha=n.valpha,t.lineWidth=n.line_width,t.strokeStyle=i,t.beginPath();for(var g=0;g<n.style;++g){var b=16+5*g,m=u+r*b,x=_+a*b,k=u+s*b,w=_+o*b,j=m+k-u,O=x+w-_;t.moveTo(m,x),t.lineTo(j,O),t.lineTo(k,w)}if(t.stroke(),y){var P=16+5*(n.style-1);n.start_arrow&&(h=u+r*P,c=_+a*P,Wt(t,h,c,n.start_angle+vs/2)),n.end_arrow&&(h=u+s*P,c=_+o*P,Wt(t,h,c,n.end_angle-vs/2))}t.globalAlpha=1}},{key:"draw_arc",value:function(t,e){var n=this,i=n.pO,r=i.x,a=i.y,s=n.start_angle,o=n.end_angle,l=ks(s),u=xs(s),_=n.selected||n.highlight?"#ff00ff":this.color,h=n.valpha,c=16;t.beginPath(),t.moveTo(r,a),t.arc(r,a,c,s,o),t.globalAlpha=.3*h,t.fillStyle=_,t.fill();var p=this.start_arrow||this.end_arrow;t.globalAlpha=h,t.lineWidth=this.line_width,t.strokeStyle=_,t.beginPath();for(var f=0;f<this.style;++f){if(f&&t.moveTo(r+c*l,a+c*u),p&&f==n.style-1){if(c*n.value<7){t.arc(r,a,c,s,o);break}var v=n.value,d=7/c,y=s,g=o;n.start_arrow&&(y+=d,v-=d),n.end_arrow&&(g-=d,v-=d),f&&t.moveTo(r+c*ks(y),a+c*xs(y)),v>0&&t.arc(r,a,c,y,g)}else t.arc(r,a,c,s,o);c+=5}if(t.stroke(),p&&(c=16+5*(n.style-1))*n.value>=7){var b=7/c,m=(vs+b)/2,x=void 0,k=void 0;n.end_arrow&&(x=r+c*ks(o),k=a+c*xs(o),Wt(t,x,k,o-m)),n.start_arrow&&(x=r+c*ks(s),k=a+c*xs(s),Wt(t,x,k,s+m))}t.globalAlpha=1}},{key:"hit_test",value:function(t,e){if(!this.exist)return!1;var n=t-this.pO.x,i=e-this.pO.y,r=n*n+i*i,a=16+5*(this.style-1);if(r>a*a)return!1;var s=u(n,i);return this.start_angle<=this.end_angle?this.start_angle<=s&&s<=this.end_angle:s<=this.end_angle||s>=this.start_angle}},{key:"next_style",value:function(){++this.style,this.style>4&&(this.style=1),this.update()}},{key:"is_angle_mark",value:function(t,e,n){return this.pO===e&&(this.pA==t&&this.pB==n||this.pA==n&&this.pB==t)}},{key:"approx_angle_mark",value:function(t,e,n){if(t instanceof Qo&&e instanceof Qo&&n instanceof Qo){if(this.is_angle_mark(t,e,n))return!0;if(bs(l(this.pO,e))>fs)return!1;if(s(e,t,e,this.pA))return s(e,n,e,this.pB);if(s(e,n,e,this.pA))return s(e,t,e,this.pB)}return!1}},{key:"get_angle",value:function(){return this.value}},{key:"get_prop_pages",value:function(){return["object","label","mark"]}},{key:"init_mark_ppage",value:function(t){var e=["am_inferior_angle","am_reflex_angle","am_anticlock","am_clockwise"],n=Ht(this.a_sel),i=e[n-1];i||(i=e[0]),$("#"+i).prop("checked",!0);var r=$("#am_style"),a=Ht(this.style);r.prop("selectedIndex",a-1),$("#am_start_arrow").prop("checked",this.start_arrow),$("#am_end_arrow").prop("checked",this.end_arrow)}},{key:"apply_mark_change",value:function(t){this.style=Ht(t.style),this.a_sel=Ht(t.a_sel),this.start_arrow=t.start_arrow,this.end_arrow=t.end_arrow,this.update()}},{key:"calc_label_pos",value:function(t){var e=t.pos;e&&2==e.length||(e=[.5,30]);var n=e[0],i=e[1],r=h(this.start_angle,this.end_angle),a=r*n,s=this.start_angle+a,o=ks(s)*i+this.pO.x,l=xs(s)*i+this.pO.y;t.x=o-t.width/2,t.y=l-t.height/2}},{key:"set_label_pos",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=this.label.pos;n.length=2,n[0]=t,n[1]=e}},{key:"move_label_pos",value:function(t,e){if("down"==e.event)return void(e.old_pos={x:t.x,y:t.y});var n=e.old_pos;t.x=n.x+e.cur_x-e.start_x,t.y=n.y+e.cur_y-e.start_y;var i=t.x+t.width/2,r=t.y+t.height/2,a=i-this.pO.x,s=r-this.pO.y,o=_(a,s),l=ms(a*a+s*s),u=o-this.start_angle,c=h(this.start_angle,this.end_angle),p=t.pos;p.length=2,p[0]=u/c,p[1]=l}}],[{key:"find",value:function(t,n,i){var r=n.children();if(!r)return null;for(var a=0;a<r.length;++a){var s=r[a];if(s instanceof e&&s.is_angle_mark(t,n,i))return s}return null}}]),e}(Xo);R(Ml,{class_name:"AngleMark",type:"mark",sub_type:"amark",type_cname:"角标记",color:"#000080",line_width:2,style:1,a_sel:1,is_Rt:!1,start_angle:0,end_angle:0,value:0,start_arrow:!1,end_arrow:!1,_jpda:["line_width","style","a_sel","start_arrow","end_arrow"]});var ql=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,"",1));return r.pre_text="",r.pre_text=i,r}return us(e,t),os(e,[{key:"label_changed",value:function(){this.update()}},{key:"leng_text",value:function(t){if("hp"==this.unit){var e=t/100;return this.pre_text+e.toFixed(this.prec)+"\\space 单位"}if("cm"==this.unit){var n=t/Cs.PIX2CM;return this.pre_text+n.toFixed(this.prec)+"\\space 厘米"}if("in"==this.unit){var i=t/Cs.DPI[0];return this.pre_text+i.toFixed(this.prec)+" 英寸"}return this.pre_text+t.toFixed(this.prec)+" 像素"}},{key:"angle_text",value:function(t){if("d"==this.unit){var e=180*t/vs;return this.pre_text+e.toFixed(this.prec)+"°"}return this.pre_text+t.toFixed(this.prec)}},{key:"area_text",value:function(t){if("hp"==this.unit){var e=t/1e4;return this.pre_text+e.toFixed(this.prec)+" \\space 单位^2"}if("cm"==this.unit){var n=t/Cs.PIX2CM/Cs.PIX2CM;return this.pre_text+n.toFixed(this.prec)+" \\space 厘米^2"}if("in"==this.unit){var i=t/Cs.DPI[0]/Cs.DPI[0];return this.pre_text+i.toFixed(this.prec)+" 英寸^2"}return this.pre_text+t.toFixed(this.prec)+" 像素^2"}},{key:"ratio_text",value:function(t){return this.pre_text+t.toFixed(this.prec)}},{key:"gsf_pars",value:function(){var t=this._parents.slice(0);return t.push(this.left),t.push(this.top),t.push(""),t}},{key:"gsf_props",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return"#000000"!==this.color&&(t.color=this.color),2!==this.prec&&(t.prec=this.prec),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"get_prop_pages",value:function(){return["object","label","value"]}},{key:"init_value_ppage",value:function(t){t.set_value_prec(this.prec)}},{key:"apply_value_change",value:function(t){this.prec!=t.prec&&(this.prec=t.prec,this.update())}}]),e}(Bl);R(ql,{class_name:"MeasureBase",type:"measure",sub_type:"",type_cname:"测量",prec:2,unit:"",value:0,_jpda:["left","top","prec","unit"]});var Rl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof il&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0],r=i.get_label();this.pre_text=r?r+" = ":"m\\overline{"+i.sget_name()+"} = ";var a=l(i.p1,i.p2);this.value=a;var s=this.leng_text(a);this.set_text(s),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}]),e}(ql);R(Rl,{class_name:"Length",sub_type:"len",type_cname:"测量线段长度",unit:"hp"});var Fl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";ss(this,e);var s=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,i,r,a));return t instanceof Qo&&n instanceof Qo&&(s._parents=[t,n],s.update()),s}return us(e,t),os(e,[{key:"update",value:function(){var t=this;if(t._parents&&2==t._parents.length){var n=t._parents[0],i=t._parents[1];t.pre_text=n.sget_name()+i.sget_name()+" = ";var r=l(n,i);t.value=r;var a=t.leng_text(r);this.set_text(a),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}]),e}(ql);R(Fl,{class_name:"Distance",sub_type:"dist",type_cname:"测量两点间距离",unit:"hp"});var Dl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(!n||1!=n.length)return"";var i=n[0];if(Vt(i)){t.pre_text=i.sget_name()+" \\space 的周长 = ",t.value=i.calc_perimeter();var r=t.leng_text(t.value);this.set_text(r),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}]),e}(ql);R(Dl,{class_name:"Perimeter",sub_type:"peri",type_cname:"测量对象周长",unit:"hp"});var Ll=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0];if(Gt(i)){t.pre_text=i.sget_name()+" \\space 的周长 = ",t.value=i.calc_circum();var r=this.leng_text(t.value);this.set_text(r),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}}]),e}(ql);R(Ll,{class_name:"Circumference",sub_type:"circum",type_cname:"测量圆周长",unit:"hp"});var Xl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";ss(this,e);var o=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,a,s));return t instanceof Qo&&n instanceof Qo&&i instanceof Qo&&(o._parents=[t,n,i],o.update()),o}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&3==n.length){var i=n[0],r=n[1],a=n[2];t.pre_text="∠"+i.sget_name()+r.sget_name()+a.sget_name()+" = ",t.value=c(i,r,a);var s=this.angle_text(t.value);this.set_text(s),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}]),e}(ql);R(Xl,{class_name:"Angle",sub_type:"angle",type_cname:"测量角度",unit:"d"});var Yl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0];if(i instanceof Ml){t.pre_text="m∠"+i.sget_name()+" = ";var r=t.value=i.value,a=t.angle_text(r);t.set_text(a),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}}]),e}(ql);R(Yl,{class_name:"Angle2",sub_type:"angle2",type_cname:"测量角度",unit:"d"});var Ul=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0];if(Jt(i)){t.pre_text=i.sget_name()+" \\space 的面积 = ",this.value=i.calc_area();var r=this.area_text(this.value);this.set_text(r),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}}]),e}(ql);R(Ul,{class_name:"Area",sub_type:"area",type_cname:"测量面积",unit:"hp"});var Hl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0];if(Qt(i)){t.pre_text="m"+i.sget_name()+" = ",this.value=i.get_radian();var r=t.angle_text(this.value);this.set_text(r),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}}]),e}(ql);R(Hl,{class_name:"Radian",sub_type:"radian",type_cname:"测量弧的角度",unit:"d"});var Wl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0];if(Qt(i)&&Kt(i)){t.pre_text=i.sget_name()+" \\space 的长度 = ",t.value=i.get_radian()*i.get_radius();var r=t.leng_text(t.value);t.set_text(r),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}}]),e}(ql);R(Wl,{class_name:"ArcLength",sub_type:"arclen",type_cname:"测量弧长",unit:"hp"});var Vl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,r));return t instanceof Xo&&(a._parents=[t],a.update()),a}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&1==n.length){var i=n[0];if(Kt(i)){t.value=i.get_radius(),t.pre_text=i.sget_name()+" \\space 的半径 = ";var r=t.leng_text(t.value);t.set_text(r),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}}]),e}(ql);R(Vl,{class_name:"Radius",sub_type:"radius",type_cname:"测量半径",unit:"hp"});var Gl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";ss(this,e);var s=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,i,r,a));return t instanceof Xo&&n instanceof Xo&&(s._parents=[t,n],s.update()),s}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n||2==n.length){var i=n[0],r=n[1];if(Zt(i)&&Zt(r)){var a=i.leng(),s=r.leng();t.pre_text="\\frac{m\\overline{"+i.sget_name()+"}}{m\\overline{"+r.sget_name()+"}} = ",t.value=a/s;var o=t.ratio_text(t.value);t.set_text(o),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}},{key:"gsf_name",value:function(){return"Ratio/Segments"}}]),e}(ql);R(Gl,{class_name:"RatioSegments",sub_type:"ratsg",type_cname:"测量两线段比值"});var Jl=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";ss(this,e);var o=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,a,s));return t instanceof Xo&&n instanceof Xo&&i instanceof Xo&&(o._parents=[t,n,i],o.update()),o}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&3==n.length){var i=n[0],r=n[1],a=n[2];if(i instanceof Qo&&r instanceof Qo&&a instanceof Qo){t.pre_text="\\frac{"+i.sget_name()+a.sget_name()+"}{"+i.sget_name()+r.sget_name()+"} = ";var o=l(i,a),u=l(i,r);t.value=o/u,s(i,r,i,a)||(t.value=-t.value);var _=t.ratio_text(t.value);t.set_text(_),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this)}}}},{key:"gsf_name",value:function(){return"Ratio/Points"}}]),e}(ql);R(Jl,{class_name:"RatioPoints",sub_type:"ratpt",type_cname:"测量三点比值"});var Ql=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";ss(this,e);var s=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,i,r,a));return t instanceof Xo&&n instanceof Xo&&(s._parents=[t,n],s.update()),s}return us(e,t),os(e,[{key:"update",value:function(){var t=this,n=t._parents;if(n&&2==n.length){var i=n[0],r=n[1];r instanceof al&&(t.pre_text=r.sget_name()+" \\space 在 \\space "+i.sget_name()+" \\space 上 = ",t.value=r.t,t.set_text(t.ratio_text(r.t)),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this))}}}]),e}(ql);R(Ql,{class_name:"PointValue",sub_type:"ptval",type_cname:"点的值"});var Kl="normal",Zl="nochange";Ms.add_animate=function(t){if(t){var e=this,n=e._all_anim;n&&n.cur_anis&&(n.cur_anis.indexOf(t)>=0||(n.cur_anis.push(t),ne(n)))}},Ms.remove_animate=function(t){if(t){var e=this,n=e._all_anim;if(n&&n.cur_anis){var i=n.cur_anis.indexOf(t);i<0||(n.cur_anis.splice(i,1),t.finish("delete"),0==n.cur_anis.length&&ie(n))}}},Ms.clear_animate=function(){var t=this,e=t._all_anim;if(e){var n=e.cur_anis;if(e.cur_anis=null,n&&n.length)for(var i=0;i<n.length;++i)n[i].finish("term");ie(e),t._all_anim=te(t)}};var tu=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ss(this,t),this.type=e,this.owner=n,this.objs=i?i.slice(0):[],this._finished=!1}return os(t,[{key:"tick",value:function(){return"complete"}},{key:"finish",value:function(t){this._finished||(this._finished=!0,this.owner&&this.owner.animate_finished&&this.owner.animate_finished(this,t))}}]),t}(),eu=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"show",n=arguments[1],i=arguments[2];ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i));switch(r.alpha_speed=.1,t){case"show":r._tick_type="show";break;case"hide":r._tick_type="hide";break;default:r._tick_type=M(i)?"show":"hide"}return r}return us(e,t),os(e,[{key:"tick",value:function(){switch(this._tick_type){case"show":return this._fade_show();case"hide":return this._fade_hide();default:return"complete"}}},{key:"_fade_show",value:function(){var t=this.objs;if(!t||!t.length)return"complete";for(var e=t.length,n=0,i=0;i<e;++i){var r=t[i];r.visible&&r.valpha>=1?++n:(r.visible=!0,r.valpha+=this.alpha_speed,r.valpha>1&&(r.valpha=1))}return n>=e?"complete":Kl}},{key:"_fade_hide",value:function(){var t=this.objs;if(!t||!t.length)return"complete";for(var e=t.length,n=0,i=0;i<e;++i){var r=t[i];r.visible?(r.valpha-=this.alpha_speed,r.valpha<=0&&(r.valpha=0,r.visible=!1)):++n}return n>=e?"complete":Kl}}]),e}(tu),nu=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"",t,n));return i.times=3,i.show_ticks=10,i.hide_ticks=8,i.tick_count=0,i}return us(e,t),os(e,[{key:"tick",value:function(){var t=this.show_ticks,e=this.hide_ticks,n=t+e,i=this.tick_count++;return 0==i?(B(this.objs),Kl):i<5?Zl:(i-=5,i>=n*this.times-t?(B(this.objs),"complete"):i%n==0?(N(this.objs),Kl):(i-e)%n==0?(B(this.objs),Kl):Zl)}}]),e}(tu),iu=function(t){function e(t,n,i){ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"",t,n));r.pad=i;for(var a=[],s=[],o=0,l=0;l<n.length;l+=2){var u=ae(n[l+1],n[l]);a.push(u),s.push(n[l+1]),u.dist>o&&(o=u.dist)}o<fs&&(o=1),r._mitms=a;for(var _=0;_<a.length;++_)a[_].speed=2*a[_].dist/o;var h=C(s),c=E(h);return z(c),r.S2=c,r}return us(e,t),os(e,[{key:"tick",value:function(){var t=this._mitms;if(!t||!t.length)return"complete";for(var e=0,n=0;n<t.length;++n){var i=t[n];if(!i.fsh){var r=i.mp,a=i.dp,s=i.speed,o=r.x,l=r.y,u=a.x,_=a.y,h=u-o,c=_-l,p=h*h+c*c;if(s<.001&&(s=.1),p<s*s)r.x=u,r.y=_,i.fsh=!0,++e;else{var f=ms(p);isNaN(f)&&(f=1),r.x+=s*h/f,r.y+=s*c/f,++e}}}return e?(this.S2.forEach(function(t){return t.update()}),Kl):"complete"}}]),e}(tu),ru=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.left=t,r.top=n,r.text=i,r.pressed=!1,r}return us(e,t),os(e,[{key:"update",value:function(){var t=this,e=t.pad,n=void 0;if(e&&(n=e.ctx)){var i=t.padding;n.font="14px Arial";var r=n.measureText(t.text);t.width=2*i+r.width+8+2,t.height=2*i+t.font_size}}},{key:"draw",value:function(t,e){var n=this,i=n.padding,r=n.valpha,a=n.left,s=n.top,o=n.width,l=n.height,u=a+o,_=s+l;n.selected&&(t.beginPath(),t.lineWidth=1.2,t.strokeStyle="#FF00FF",t.rect(n.left-3,n.top-3,n.width+6,n.height+6),t.stroke()),r<1&&(t.globalAlpha=r),t.beginPath(),t.rect(a,s,o,l),t.fillStyle="#cccccc",t.fill(),t.strokeStyle="black",t.lineWidth=1,t.stroke(),t.beginPath(),t.rect(a+1,s+1,8,l-2),t.fillStyle=n.color,t.fill(),t.beginPath(),t.moveTo(u-3,s+1),t.lineTo(8+a+2,s+1),t.lineTo(8+a+2,_-2),t.strokeStyle=n.pressed?"black":"white",t.stroke(),t.beginPath(),t.moveTo(8+a+2,_-1),t.lineTo(u-1,_-1),t.lineTo(u-1,s+1),t.strokeStyle=n.pressed?"white":"black",t.stroke(),t.font="14px Arial",t.textBaseline="top",t.fillStyle="black";var h=n.pressed?i+1:i;t.fillText(n.text,a+8+h+1,s+h),r<1&&(t.globalAlpha=1)}},{key:"hit_test",value:function(t,e){return!(!this.exist||!this.visible)&&(!(t<this.left||e<this.top||t>this.left+this.width||e>this.top+this.height)&&(t<this.left+8||"button"))}},{key:"rc_hit_test",value:function(t){return Yt(this,t)}},{key:"on_move",value:function(t){return Ut(this,t)}},{key:"pos_snapshot",value:function(){return{left:this.left,top:this.top}}},{key:"unpos_snapshot",value:function(t){this.left=t.left,this.top=t.top}},{key:"on_mouse_paint",value:function(t,e){var n=this,i=n.hit_test(e.objX,e.objY),r=!!i;return n.pressed!=r&&(n.pressed=r,n.draw(t.ctx,t)),i}},{key:"fire_click",value:function(){}},{key:"animate_finished",value:function(){}},{key:"on_delete",value:function(t){}},{key:"init_label_ppage",value:function(t){t.set_label_text(this.text),t.label_show_opt(!1)}},{key:"apply_label_change",value:function(t){this.text!=t.text&&(this.text=t.text,this.update())}}]),e}(Xo);R(ru,{class_name:"Button",free_value:2,type:"button",sub_type:"button",padding:3,color:"#ff8000",font_size:14,_jpda:["left","top","text"]});var au=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i));if(r&&r.length){var s=a,o=(i||"").split("|");o.length<2&&o.push(o[0].replace("显示","隐藏")),a.text=o[0],s._parents=r.slice(0),s.init_text=i,s.text_arr=o}return a}return us(e,t),os(e,[{key:"set_init_text",value:function(t){var e=t.split("|");e.length<2&&e.push(e[0].replace("显示","隐藏")),this.init_text=t,this.text_arr=e,this.text=e[0]}},{key:"fire_click",value:function(){var t=this,e=t._parents;if(e&&e.length&&!t.ani)if(t.opt_fade){var n=t.ani=new eu(t.sub_type,t,e);t.pad.add_animate(n)}else{switch(t.sub_type){case"show":B(e);break;case"hide":N(e);break;default:q(e)}t.pad.draw(),t.ani}}},{key:"animate_finished",value:function(){if(this.pressed=!1,this.ani=null,"toggle"==this.sub_type){var t=M(this._parents);this.text=t?this.text_arr[0]:this.text_arr[1],this.update()}this.opt_sel&&(M(this._parents)||this.pad.select_objs(this._parents))}},{key:"get_prop_pages",value:function(){return["object","label","shbtn"]}},{key:"init_shbtn_ppage",value:function(t){var e=0;switch(this.sub_type){case"show":e=0;break;case"hide":e=1;break;default:e=2}t.set_shbtn_act(e),t.set_shbtn_sel(this.opt_sel),t.set_shbtn_fade(this.opt_fade)}},{key:"apply_shbtn_change",value:function(t){switch(t.act){case 0:this.sub_type="show";break;case 1:this.sub_type="hide";break;default:this.sub_type="toggle"}this.opt_sel=t.sel,this.opt_fade=t.fade}}]),e}(ru);R(au,{class_name:"ToggleVisibilityButton",sub_type:"toggle",type_cname:"显示/隐藏按钮",opt_sel:!1,opt_fade:!0,_jpda:["init_text","text_arr","opt_sel","opt_fade"]});var su=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i));return a.ani=null,r&&r.length&&(a._parents=r.slice(0)),a}return us(e,t),os(e,[{key:"fire_click",value:function(){if(this.pad){var t=this._parents;if(t&&t.length&&!this.ani){var e=this.ani=new nu(this,t);this.pad.add_animate(e)}}}},{key:"animate_finished",value:function(){this.pressed=!1,this.ani=null}}]),e}(ru);R(su,{class_name:"BlinkButton",sub_type:"blink",type_cname:"闪烁按钮"});var ou=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;ss(this,e);var l=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i));if(l.ani=null,r&&a&&s&&o){l._parents=r;r.length;l.speeds=a,l.onceOnlys=s,l.directions=o,l._init2()}return l}return us(e,t),os(e,[{key:"unserialize",value:function(){this._init2()}},{key:"_init2",value:function(){var t=this,e=t._parents,n=t.pt_num=e.length/2;t.aps=new Array(n),t.active=new Array(n);for(var i=0;i<n;++i){var r=e[2*i],a=e[2*i+1],s=a.create_ani_pt(r,a,t.speeds[i],t.onceOnlys[i],t.directions[i]);t.aps[i]=s,t.active[i]=!0}}},{key:"fire_click",value:function(){if(this.ani)return this.pad.remove_animate(this.ani),void(this.ani=null);if(this.pt_num){for(var t=[],e=0;e<this.pt_num;++e){var n=this.aps[e];n.animation_defined()?(this.active[e]=!0,n.setup_animating_point(),t.push(n.mover)):this.active[e]=!1}var i=C(t);this.S2=z(E(i)),this.ani=this,this.pad.add_animate(this)}}},{key:"animate_finished",value:function(){this.pressed=!1,this.ani=null}},{key:"tick",value:function(){for(var t=0,e=0;e<this.pt_num;++e)if(this.active[e]){var n=this.aps[e];n.animation_defined()?(++t,n.animate_point()&&(this.active[e]=!1)):this.active[e]=!1}return this.S2&&this.S2.forEach(function(t){return t.update()}),t>0?Kl:"complete"}},{key:"finish",value:function(){this.animate_finished()}},{key:"get_prop_pages",value:function(){return["object","label","animate"]}},{key:"init_animate_ppage",value:function(t){console.log("todo: AniamteButton.init_animate_ppage()")}},{key:"apply_animate_change",value:function(t){console.log("todo: AnimateButton.apply_animate_change()")}}]),e}(ru);R(ou,{class_name:"AnimateButton",sub_type:"animate",type_cname:"动画按钮",_jpda:["left","top","text","speeds","onceOnlys","directions"]});var lu=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;ss(this,e);var r=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t instanceof Xo&&Tt(t)&&(r.path1=t,r.t=n,r.style=Ht(i),r._parents=[t],r.update()),r}return us(e,t),os(e,[{key:"valueOf",value:function(){return this.t}},{key:"unserialize",value:function(){this.path1=this._parents[0]}},{key:"update",value:function(){var t=this;t.exist=!1;var e=t.path1;if(e.exist){var n=e.calc_point_on(t.t);t.Ox=n.x,t.Oy=n.y;var i=e.calc_tangent_on(t.t),r=i.x,a=i.y,s=ms(r*r+a*a);t.w=(t.style-1)*hu+cu,t.style<3&&(t.w+=pu),t.h=uu;var o=2*s;t.vh_x=r*t.w/o,t.vh_y=a*t.w/o,t.vv_x=a*t.h/o,t.vv_y=-r*t.h/o,t.vhg_x=r*hu/o,t.vhg_y=a*hu/o,t.hc2_x=a*_u/o,t.hc2_y=-r*_u/o,t.exist=!0}}},{key:"draw",value:function(t,e){var n=this;if(n.exist){var i=n.Ox-(n.style-1)/2*n.vhg_x,r=n.Oy-(n.style-1)/2*n.vhg_y;t.beginPath();for(var a=0;a<n.style;++a)t.moveTo(i+n.hc2_x,r+n.hc2_y),t.lineTo(i-n.hc2_x,r-n.hc2_y),i+=n.vhg_x,r+=n.vhg_y;t.strokeStyle=n.color,t.lineWidth=n.line_width,t.stroke(),n.selected&&(t.beginPath(),t.moveTo(n.Ox-n.vh_x+n.vv_x,n.Oy-n.vh_y+n.vv_y),t.lineTo(n.Ox+n.vh_x+n.vv_x,n.Oy+n.vh_y+n.vv_y),t.lineTo(n.Ox+n.vh_x-n.vv_x,n.Oy+n.vh_y-n.vv_y),t.lineTo(n.Ox-n.vh_x-n.vv_x,n.Oy-n.vh_y-n.vv_y),t.closePath(),t.fillStyle="rgba(255,0,255,0.1)",t.fill(),t.strokeStyle="#ff00ff",t.lineWidth=.5,t.stroke())}}},{key:"hit_test",value:function(t,e){if(!this.exist)return!1;t-=this.Ox,e-=this.Oy;var n=this.w/2,i=(t*this.vh_x+e*this.vh_y)/n;if(i>n||i<-n)return!1;var r=this.h/2,a=(t*this.vv_x+e*this.vv_y)/r;return!(a>r||a<-r)}},{key:"gsf_pars",value:function(){return[this.path1,this.t]}},{key:"gsf_props",value:function(t){return qs(t,{color:this.color}),ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"gsf_props",this).call(this,t)}},{key:"next_style",value:function(){++this.style,this.style>4&&(this.style=1),this.update()}},{key:"between_pt2",value:function(t,e){var i=this.path1;if(i instanceof il){if(!n(t,i.p1,i.p2))return!1;if(!n(e,i.p1,i.p2))return!1;var r=i.calc_point_on(this.t);return s(t,r,r,e)}return!1}}]),e}(Xo);R(lu,{class_name:"LineMark",type:"mark",sub_type:"lmark",color:"#000080",line_width:2,style:1,_jpda:["t","line_width","style"]});var uu=24,_u=14,hu=8,cu=6,pu=6,fu=function(){function t(){ss(this,t)}return os(t,[{key:"animation_defined",value:function(){return this.mover.exist&&this.path.exist}},{
key:"setup_animating_point",value:function(){}}]),t}(),vu=function(t){function e(t,n,i,r,a){ss(this,e);var s=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return s.mover=t,s.path=n,s.speed=i||3,s.onceOnly=r,s.dir=a||0,s}return us(e,t),os(e,[{key:"advance_mover",value:function(){this.mover.t=this.t,this.mover.update()}},{key:"setup_animating_point",value:function(){this.update_from_new_straight(),this.lowEnd=0,this.highEnd=1,this.rnd=0,this.advance_mover(),this.onceOnly&&(this.stopAfterFraction=this.t,this.hasBounced=!1),3===this.dir&&(this.delay=120/this.speed,this.rnd=this.delay-1)}},{key:"animate_point",value:function(){if(this.t+=this.dt,0==this.dir)this.t>this.highEnd?(this.dt=-this.dt,this.t=this.highEnd):this.t<this.lowEnd&&(this.dt=-this.dt,this.t=this.lowEnd);else if(1==this.dir){if(this.onceOnly&&this.hasBounced&&this.t>this.stopAfterFraction)return!0;this.t>this.highEnd&&(this.t=this.lowEnd,this.hasBounced=!0)}else if(2==this.dir){if(this.onceOnly&&this.hasBounced&&this.t<this.stopAfterFraction)return!0;this.t<this.lowEnd&&(this.t=this.highEnd,this.hasBounced=!0)}else{if(this.onceOnly&&this.hasBounced)return!0;if(++this.rnd<this.delay)return!1;this.rnd=0,this.t=Es()*(this.highEnd-this.lowEnd)+this.lowEnd,this.hasBounced=!0}return this.advance_mover(),!1}},{key:"modify_speed",value:function(){this.setup_animating_point()}},{key:"update_from_new_straight",value:function(){var t=this.path.p1,e=this.path.p2,n=e.x-t.x,i=e.y-t.y;this.r2=n*n+i*i;var r=ms(this.r2);this.dt=this.speed/r,2==this.dir&&(this.dt=-this.dt),this.t=this.mover.t}},{key:"get_dir_text",value:function(){return["双向","向前","向后","随机"]}}]),e}(fu),du=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t&&(a.pad=t,a.x=n,a.y=i,a.style=r,a.r=1,a.i=0,a.s=0,a._fd=!1),a}return us(e,t),os(e,[{key:"draw",value:function(t){var e=this.x,n=this.y,i=this.r;if(!(i<=0)){if(t.lineWidth=this.line_width,t.strokeStyle=this.color,t.beginPath(),0==this.style)for(;i>2;i-=5)t.moveTo(e+i,n),t.arc(e,n,i,0,2*vs);else for(;i>2;i-=5)t.rect(e-i,n-i,2*i,2*i);t.stroke()}}},{key:"tick",value:function(){switch(this.s){case 0:return this.r=this.i+=2.5,this.i>15&&(this.s=1),Kl;case 1:if(this.r=this.i-=2.5,this.i>0)return Kl}return"complete"}},{key:"finish",value:function(t){this._fd||(this._fd=!0,this.pad.remove_tmp_obj(this))}}]),e}(Xo);R(du,{type:"ani",sub_type:"blink_mark",color:"#000000",line_width:2});var yu=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;ss(this,e);var a=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.speed=15,a.len=100,t&&n instanceof Qo&&i instanceof Qo&&(a.pad=t,a.pS=n,a.pE=i,a.style=r,a.E=0),a}return us(e,t),os(e,[{key:"draw",value:function(t){this.aS&&this.aE&&(t.lineWidth=this.line_width,t.strokeStyle=this.color,t.beginPath(),Pt(t,this.aE.x,this.aE.y,this.aS.x,this.aS.y,[10,5]),t.stroke())}},{key:"tick",value:function(){if(this.is_end)return"complete";var t=this.E+=this.speed,e=t-this.len;return this.aE=this._cp(t),this.aS=this._cp(e),1==this.aS.tr?"complete":Kl}},{key:"finish",value:function(t){this._fd||(this._fd=1,this.pad.remove_tmp_obj(this))}},{key:"_cp",value:function(t){var e=this.pS,n=this.pE,i=n.x-e.x,r=n.y-e.y,a=ms(i*i+r*r),s=t/a;s<0?s=0:s>1&&(s=1);var o=s*i,l=s*r;return{x:o+e.x,y:l+e.y,tr:s}}}]),e}(Xo);R(yu,{class_name:"BlinkVec",type:"ani",sub_type:"blink_vec",color:"black",line_width:3});var gu=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"A",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;ss(this,t),this.prefix=e,this.num=n,this.mode=i}return os(t,[{key:"get_name",value:function(){switch(this.mode){case 1:return this.prefix+this.num;case 2:return null===this.num?this.prefix:this.prefix+"["+this.num+"]";default:return this.prefix+this.num}}},{key:"next",value:function(){var t=this.get_name();if(1==this.mode||2==this.mode)return this.num=""==this.num?1:oe(this.num),t;var e=this.prefix.charAt(this.prefix.length-1),n=mu.indexOf(e);return n>=0?(this.next_0(e,mu),t):(n=bu.indexOf(e))>=0?(this.next_0(e,bu),t):(this.num=""==this.num?1:oe(this.num),t)}},{key:"next_0",value:function(t,e){var n=e.indexOf(t);++n,n>=e.length?(this.prefix=this.prefix.substr(0,this.prefix.length-1)+e.charAt(0),this.num=""==this.num?1:oe(this.num)):this.prefix=this.prefix.substr(0,this.prefix.length-1)+e.charAt(n)}},{key:"clone",value:function(){return new t(this.prefix,this.num,this.mode)}}],[{key:"parse_text",value:function(e){var n=e.lastIndexOf("["),i=e.lastIndexOf("]");if(n<i&&i==e.length-1){var r=e.substr(n+1,i-n-1);return nt(r)?new t(e.substr(0,n),parseInt(r),2):new t(e,"",0)}var a=se(e);if(!a)return new t(e,"",0);var s=a.toString().length;return new t(e.substr(0,e.length-s),a,1)}}]),t}(),bu="abcdefghijklmnopqrstuvwxyz",mu="ABCDEFGHIJKLMNOPQRSTUVWXYZ",xu=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,t),this.owner=e}return os(t,[{key:"parse",value:function(t,e){function n(){for(;l<o;++l){var e=t.charAt(l);if(!Z(e)){if("{"!=e)return e;for(;l<o&&"}"!==t.charAt(l);)++l}}return null}function i(){for(var e=l;l<o;++l){var n=t.charAt(l);if("("==n||"["==n||";"==n||"{"==n||","==n||"]"==n)break}return t.substr(e,l-e).trim()}function r(){++l;for(var e=[],i=void 0;;){n();var r=t.charAt(l),o=r.charCodeAt(0);if(")"===r){++l;break}if(48<=o&&o<=57||"+"===r||"-"===r)i=a();else if("#"===r)++l,i=a();else{if("'"!==r&&'"'!==r)throw new SyntaxError("Invalid param.");i=s(r)}if(e.push(i),")"===(r=t.charAt(l))){++l;break}if(","!==r)throw new SyntaxError("Invalid param-list.");++l}return e}function a(){for(var e=l;l<o;++l){var n=t.charAt(l);if(Z(n)||")"===n||","===n||"]"===n||";"===n)break}var i=t.substr(e,l-e);return parseFloat(i)}function s(e){++l;for(var n=l,i=[];;++l){if(l>=o)throw new SyntaxError("Unterminated string");var r=t.charAt(l);if("\\"==r){switch(n<l&&i.push(t.substr(n,l-n)),++l,r=t.charAt(l)){case"\\":i.push("\\");break;case"t":i.push("\t");break;case"r":i.push("\r");break;case"n":i.push("\n");break;case"'":i.push("'");break;case'"':i.push('"');break;default:i.push(r)}n=l+1}else if(r==e){if(n<l&&i.push(t.substr(n,l-n)),++l,(r=t.charAt(l))!=e)break;i.push(r),n=l+1}}return i.join("")}for(var o=t.length,l=0,u=1,_=void 0;;){if(null==(_=n()))break;var h={idx:u++,args:[]};if(h.name=i(),!h.name)throw new SyntaxError("Missing object-name.");for(;"("===(_=n());)h.args.push(r());if(_=n(),"["===_&&(h.formats=function(){++l;for(var t=[];;){var e=n();if("]"==e){++l;break}var a=i();if("("==(e=n())){var s=r();s.unshift(a),t.push(s),e=n()}else t.push(a);if("]"==e){++l;break}if(","!=e)throw new SyntaxError("Invalid format-list");++l}return t}()),";"!==(_=n()))throw new SyntaxError("Unterminated object-form");++l,e(h,this.owner)}}}]),t}(),ku=function t(e){ss(this,t),this._top_timer=null,this._top_li=null,this._top_out=!1,this._top_ts=0,this._last_ts=0,this.gmenu=e},wu=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,t),this.owner=e}return os(t,[{key:"create",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this;n.opt=e,ve(n,new ku(n),t,e)}}]),t}(),ju={edit:"undo redo - del clear - btn - sel-all texed",show:"pt_sty ln_sty color - hide show_all - label cons_lst",cons:"poo midpt intp - seg ray line par perp bis - circ circ_rad arc arc_3",xfrm:"st_cent st_refl st_vec - x_xlate x_rota x_dila x_refl",meas:"mlen mdist mperi mcirf mang marea mrad marcl mradi mrat mptv - mcoor mabsc mordi mslop mform"},Ou={"-":{b:1},edit:{n:"edit",t:"编辑",items:"undo redo - del clear - btn - sel_all texed"},undo:"恢复(Ctrl+Z)",redo:"重做",del:"删除(Del)",clear:"全部清空",btn:{t:"按钮  >>",items:"sh_btn blk_btn ani_btn mv_btn"},sh_btn:"隐藏/显示按钮",blk_btn:"闪烁对象按钮",ani_btn:"动画按钮",mv_btn:"移动按钮",sel_all:"全选",texed:"编辑文本(Ctrl+E)",show:{n:"show",t:"显示",items:"pt_sty ln_sty color - hide show_all - label cons_lst"},pt_sty:{t:"点型  >>",items:"pts_1 pts_2 pts_3 pts_4"},pts_1:"最小",pts_2:"稍小",pts_3:"中等",pts_4:"最大",ln_sty:{t:"线型  >>",items:"lnw_1 lnw_2 lnw_3 lnw_4 - lns_0 lns_1 lns_2"},lnw_1:"极细",lnw_2:"细线",lnw_3:"中细",lnw_4:"粗线",lns_0:"实线",lns_1:"虚线",lns_2:"点线",color:{t:"颜色  >>",color:!0},hide:"隐藏对象",show_all:"显示所有隐藏",label:"属性和标签...  (Alt+/)",cons_lst:"构造列表...",cons:{t:"构造",n:"cons",items:"poo midpt intp - seg ray line par perp bis - circ circ_rad arc arc_3 - inte"},poo:"对象上的点",midpt:"中点(Ctrl+M)",intp:"交点",seg:"线段(Ctrl+L)",ray:"射线",line:"直线",par:"平行线",perp:"垂线",bis:"角平分线",circ:"以圆心和圆周上的点作圆",circ_rad:"以圆心和半径作圆",arc:"圆上的弧",arc_3:"过三点弧",inte:{t:"内部  >>",items:"poly cint sect arch"},poly:"多边形",cint:"圆内部",sect:"扇形",arch:"弓形",xfrm:{t:"变换",n:"xfrm",items:"st_cent st_refl st_vec - x_xlate x_rota x_dila x_refl"},st_cent:"标记中心",st_refl:"标记对称(反射)轴",st_vec:"标记向量",x_xlate:"平移...",x_rota:"旋转...",x_dila:"缩放...",x_refl:"对称(反射)",meas:{t:"度量",n:"meas",items:"mlen mdist mperi mcirf mang marea mrad marcl mradi mrat mptv - mcoor mabsc mordi mslop mform"},mlen:"长度",mdist:"距离",mperi:"周长",mcirf:"圆周长",mang:"角度",marea:"面积",mrad:"弧度角",marcl:"弧长",mradi:"半径",mrat:"比",mptv:"点的值",mcoor:"坐标",mabsc:"横坐标",mordi:"纵坐标",mslop:"斜率",mform:"方程"},Pu=function(){function t(e){ss(this,t),this.pad=e,this.root_ul=null,this.opt={}}return os(t,[{key:"create",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Te(this),this.container=t,this.opt=e,Se(e);var n=this.root_ul=le("ul","geo_toolbox");Ce(n,this,"select"),e.point&&Ce(n,this,"point"),e.lines&&Be(n,this,e),e.circle&&Ce(n,this,"circle"),e.poly&&Ne(n,this),e.mark&&Ce(n,this,"mark"),e.text&&Ce(n,this,"text"),e.macro&&De(this,n,e);var i=e.macro_items;if(i){i=i.split(",");for(var r=0;r<i.length;++r){var a=i[r],s=Cs.MacroTools2.name_map[a];s&&Xe(this,n,a,s.title)}}$(n).find("> li > span.select").addClass("selected"),_e(t,n)}},{key:"reset",value:function(){Re(this),$(this.root_ul).find("> li > span.select").addClass("selected")}}]),t}(),$u={select:"选择工具",point:"作点工具",circle:"作圆工具",segment:"作线段工具",ray:"作射线工具",line:"作直线工具",polygon:"多边形工具",polygon2:"多边形和边工具",polygon3:"多边形边工具",mark:"标记工具",text:"文本工具",macros:"自定义工具",angle:"角工具",triangle:"三角形",quadrangle:"四边形",solid_figure:"立体几何"},Au={},Su=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";ss(this,t),this._downed=!1,this._moved=!1,this.cur_point=null,this._down_x=0,this._down_y=0,this._up_x=0,this._up_y=0,this._mouse_x=0,this._mouse_y=0,this.pad=e,this.name=n}return os(t,[{key:"cleanup",value:function(){this.pad.highlight_objs(),Ue(this.pad,!1),this._downed=this._moved=!1,this.cur_point=null}},{key:"escape",value:function(){this.cleanup(),this.pad.select_tool("select"),this.pad.draw()}},{key:"is_move_started",value:function(t){if(this._moved)return!0;var e=t.objX-this._down_x,n=t.objY-this._down_y;return!(e*e+n*n<=28)&&(this._moved=!0,!0)}},{key:"mouse_down",value:function(t){}},{key:"mouse_move",value:function(t){}},{key:"mouse_up",value:function(t){}},{key:"dbl_click",value:function(t){}}]),t}(),Tu=function t(e,n,i,r,a){ss(this,t);var s=this;s.pad=e,s.hit_objs=n,s.cur_hit=i,s.org_selected=r,s.selected_objs=e.get_selected(),s.move_set=null,s.changed_objs=null,s.start_x=a.objX,s.start_y=a.objY,s.start_move=!1,s.last_x=a.objX,s.last_y=a.objY,s.memo={}},Eu={hit_first:!0,label:!0},zu={label:!0},Cu=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"select";ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i._mevt_data=null,i._drag=!1,i}return us(e,t),os(e,[{key:"cleanup",value:function(){ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this),this._mevt_data=null,this._drag=!1,this.pad.sel_box=null}},{key:"mouse_down",value:function(t){var e=this,n=e.pad,i=n.hit_test(t.objX,t.objY,zu);if(i.length){var r=i.hit_ret[0];if("button"===r){var a=n.select_tool("button");return a.button=i[0],a.mouse_down(t)}if("label"===r){var s=n.select_tool("label");return s.set_object(i[0]),s.mouse_down(t)}var o=i.get_next_selobj(),l=o.selected;o.selected||n.select_objs([o],!0),this._mevt_data=new Tu(n,i,o,l,t),n.draw()}else{n._selected_objs&&n._selected_objs.length;n.unselect_all(),this._drag=!0}}},{key:"mouse_move",value:function(t){if(this._mevt_data)return void this._move_obj(t);if(this._drag)return void(this.is_move_started(t)&&this.draw_select());var e=this.pad.hit_test(t.objX,t.objY,Eu);this.pad.set_cursor(e.length?"pointer":"default")}},{key:"mouse_up",value:function(t){this._mevt_data?this._end_move():this._drag&&this._end_drag(),this.cleanup(),this.pad.draw()}},{key:"dbl_click",value:function(t){if(!this._mevt_data&&!this._drag){var e=this.pad.hit_test(t.objX,t.objY,Eu);if(e&&e.length){var n=e[0];this.pad.select_objs([n],!1),n instanceof Qo?this.pad.set_rotate_center(n,!0):n instanceof il?this.pad.set_mirror_line(n,!0):n instanceof Nl&&Ge(this.pad,n)}}}},{key:"_move_obj",value:function(t){var e=this._mevt_data;if(e){if(!e.start_move){if(!Je(t.objX-e.start_x,t.objY-e.start_y))return;e.start_move=!0}e.cur_x=t.objX,e.cur_y=t.objY,e.move_event=t,this._do_move(e),e.last_x=t.objX,e.last_y=t.objY}}},{key:"_reselect_hitobj",value:function(t){}},{key:"draw_select",value:function(){var t=this,e=t._rc;e||(e=t._rc=new Bs),e.left=t._down_x,e.top=t._down_y,e.right=t._mouse_x,e.bottom=t._mouse_y,e.normalize();var n=t.pad,i=n.rc_hit_test(e);i.length?n.select_objs(i):n.unselect_all(),n.sel_box=e,n.draw()}},{key:"_end_drag",value:function(){this._drag=!1}},{key:"get_snapshot",value:function(t){var e={};for(var n in t)e[n]=t[n].pos_snapshot();return e}},{key:"_do_move",value:function(t){if(t.cur_x!=t.start_x||t.cur_y!=t.start_y){var e=t.move_set;if(!e){t.org_selected||(this.pad.select_objs([t.cur_hit],!1),t.selected_objs=this.pad._selected_objs),t.move_set=e=Ke(t),t.changed_objs=Ze(e);var n=this.get_snapshot(e);t.start_snapshot=n}for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];r.on_move(t),r.label&&r.calc_label_pos(r.label)}t.changed_objs.forEach(function(t){t.update(),t.label&&t.calc_label_pos(t.label)}),this.pad.draw()}}},{key:"_end_move",value:function(){var t=this,e=this._mevt_data;if(!e.start_move&&e.org_selected)return void this._reselect_hitobj(e);e.start_move&&function(){var n=e.move_set,i=t.get_snapshot(n),r=t.pad.get_history();r.do_oper("移动对象",function(){r.add_move_rec(e.start_snapshot,i)})}()}}]),e}(Su),Iu=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";ss(this,t),this.name=e,this.length=0}return os(t,[{key:"is_empty",value:function(){return 0==this.length}},{key:"add",value:function(t){return this[this.length++]=t,this}},{key:"play",value:function(t){for(var e=0;e<this.length;++e)t.play_record(this[e])}},{key:"rplay",value:function(t){for(var e=this.length-1;e>=0;--e)t.undo_record(this[e])}}]),t}(),Bu=function(){function t(e){ss(this,t),this.pad=e,this.clear()}return os(t,[{key:"clear",value:function(){this.list=[],this.ptr=0,this.cur_op=null}},{key:"do_oper",value:function(t,e){var n=this;if(n.cur_op)return e(n);n.begin_oper(t);var i=e(n);return n.end_oper(),i}},{key:"begin_oper",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.cur_op=new Iu(t)}},{key:"end_oper",value:function(){var t=this,e=t.cur_op;null!=e&&(e.is_empty()||(t.list[t.ptr]=t.cur_op,t.list.length=++t.ptr),t.cur_op=null)}},{key:"add_rec",value:function(t){return this.cur_op.add(t),this}},{key:"add_create_rec",value:function(t){return this.add_rec({type:"create",obj_id:t.obj_id,obj:t}),this}},{key:"add_update_rec",value:function(t,e,n,i){var r=JSON.stringify({prop:e,oldv:n,newv:i});return this.add_rec({type:"update",obj_id:t.obj_id,obj:t,data:r}),this}},{key:"add_delete_rec",value:function(t){return this.add_rec({type:"delete",obj_id:t.obj_id,obj:t}),this}},{key:"add_move_rec",value:function(t,e){return this.add_rec({type:"move",start:JSON.stringify(t),end:JSON.stringify(e)}),this}},{key:"can_undo",value:function(){return this.ptr>0}},{key:"undo",value:function(){var t=this;if(t.can_undo()){t.list[t.ptr-1].rplay(t),--t.ptr}return t}},{key:"can_redo",value:function(){return this.ptr<this.list.length}},{key:"redo",value:function(){var t=this;if(t.can_redo()){t.list[t.ptr].play(t),++t.ptr}return t}},{key:"play_record",value:function(t){switch(t.type){case"create":this._redo_create(t);break;case"update":this._redo_update(t);break;case"delete":this._redo_delete(t);break;case"move":this._redo_move(t);break;default:throw new Error("Unsupport op type")}}},{key:"undo_record",value:function(t){switch(t.type){case"create":this._undo_create(t);break;case"update":this._undo_update(t);break;case"delete":this._undo_delete(t);break;case"move":this._undo_move(t)}}},{key:"_redo_create",value:function(t){var e=t.obj;this.pad.insert_after(e,e.prev_obj)}},{key:"_redo_update",value:function(t){var e=t.obj,n=JSON.parse(t.data);e[n.prop]=n.newv}},{key:"_redo_delete",value:function(t){var e=t.obj;this.pad.delete_obj(e)}},{key:"_redo_move",value:function(t){this._move(JSON.parse(t.end))}},{key:"_undo_create",value:function(t){var e=t.obj;this.pad.delete_obj(e)}},{key:"_undo_update",value:function(t){var e=t.obj,n=JSON.parse(t.data);e[n.prop]=n.oldv}},{key:"_undo_delete",value:function(t){var e=t.obj,n=e.prev_obj;n&&console.assert(n._in_pad&&n.pad===this.pad),this.pad.insert_after(e,n),e.update()}},{key:"_undo_move",value:function(t){this._move(JSON.parse(t.start))}},{key:"_move",value:function(t){var e={};for(var n in t)if(t.hasOwnProperty(n)){var i=this.pad.get_object_by_id(n);e[n]=i,i.unpos_snapshot(t[n])}Ze(e).forEach(function(t){return t.update()})}}]),t}(),Nu=1;Ms.init=function(t){this.opt=qs(t,{HIT_RANGE:Cs.HIT_RANGE,DEF_PT_SIZE:3.5}),this.id=Nu++,Ns._notify_hooks(this,Ns.onCreate),this.clear()},Ms.clear=function(){this.head_obj=this.tail_obj=null,this.obj_count=0,this.obj_by_id={},this._last_objid=0;this.point_size=3.5,this.clear_tool(),this._toolbox&&this._toolbox.reset(),this.paint_q=[],this._selected_objs=[],this._highlighted_objs=[],this._tmp_objs=[],this.pt_namer=new gu("A","",0),this.ln_namer=new gu("l","",1),this.cir_namer=new gu("c","",1),this.track_point=new ul(0,0),this.track_point.visible=!1,this._history=new Bu(this),this._mouse_tool=new Cu(this,"select"),ee(this),this._all_anim=te(this),Ns._notify_hooks(this,Ns.onClear)},Ns.create_pad=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="";t.firstChild&&3==t.firstChild.nodeType&&(n=t.firstChild.textContent.trim(),t.removeChild(t.firstChild));var i=new Ns(e),r=t.clientWidth,a=t.clientHeight,s=r,o=a;s<=10&&(s=640),o<=10&&(o=Ts(.618*s));var l=i.container=t,u=le("canvas");if(u.innerHTML="您所使用的浏览器不支持 HTML 的 canvas(画布)功能, 因此不能使用网页画板功能.",!Cs.have_canvas)return _e(l,u),null;if(i.frame_table=function(){var n=!e.dis_menu,u=!e.dis_toolbox;if(!n&&!u)return null;var _=void 0,h=void 0,c=le("table","geo_frame");c.setAttribute("cellspacing","0"),c.setAttribute("cellpadding","0"),c.style.width=r+"px",c.style.height=a+"px",_e(t,c);var p=le("tbody");if(_e(c,p),n){o-=24;var f=le("tr","geo_menu_tr");_e(p,f),u&&_e(f,le("td")),_=le("td","geo_menu_td"),_e(f,_)}var v=le("tr","geo_canvas_tr");_e(p,v),u&&(s-=40,h=le("td","geo_tbox_td"),_e(v,h));var d=le("td","geo_canvas_td");if(_e(v,d),l=d,n){(i._menu=new wu(i)).create(_,e.menu)}if(u){(i._toolbox=new Pu(i)).create(h,e.toolbox)}return c}(),l.appendChild(u),u.tabIndex=0,u.width=s,u.height=o,u.style.outline="none",i.bind_canvas(u),n&&!e.dis_init_gscript)throw i.draw(),new Error("todo: 如果有脚本, 则现在解析并显示.");return i},Ms.bind_canvas=function(t){var e=this,n=t;return n&&n.getContext?(e.canvas=t,e.ctx=t.getContext("2d"),e.width=t.width,e.height=t.height,e.rc=new Bs(0,0,e.width,e.height),rn(n,"mousedown",e.on_mouse_down.bind(e)),rn(n,"mousemove",e.on_mouse_move.bind(e)),rn(n,"mouseup",e.on_mouse_up.bind(e)),rn(n,"dblclick",e.on_dbl_click.bind(e)),rn(n,"keydown",e.on_key_down.bind(e)),e):(console.error("Cannot get canvas_obj from canvas id:"+t),e)};Ms.draw=function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this;if(e.ctx)return"_draw_timer"in e||(e._draw_timer=setTimeout(function(){delete e._draw_timer,an(e,t)},0)),e},Ms.draw_direct=function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this;return"_draw_timer"in e&&(clearTimeout(e._draw_timer),delete e._draw_timer),an(e,t),e};var Mu={"Point on object":hn,Oopt:hn,Point:function(t){var e=t.args[0];return Cs.Point.new_xy(e[0],e[1])},Midpoint:function(t){var e=t.args[0],n=this.read_gobjs(e[0]);return Cs.Point.new_midpt(n)},Segment:function(t){var e=t.args[0],n=this.read_gobjs(e[1]),i=this.read_gobjs(e[0]);return Cs.Line.new_seg(n,i)},Ray:function(t){var e=t.args[0],n=this.read_gobjs(e[1]),i=this.read_gobjs(e[0]);return Cs.Line.new_ray(n,i)},Line:function(t){var e=t.args[0],n=this.read_gobjs(e[1]),i=this.read_gobjs(e[0]);return Cs.Line.new_sline(n,i)},"Circle by radius":_n,CircleByRadius:_n,"Circle interior":function(t){var e=t.args[0],n=this.read_gobjs(e[0]);return Cs.CircleInterior(n)},Circle:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return new Cs.Circle(n,i)},Intersect:pn,Intersect1:fn,Intersect2:vn,Perpendicular:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return Cs.Line.new_perpl(n,i)},Parallel:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return Cs.Line.new_paral(n,i)},Bisector:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]);return Cs.Line.new_bisl(n,i,r)},Polygon:function(t){for(var e=t.args[0],n=e.length,i=0;i<n;++i)e[i]=this.read_gobjs(e[i]);return new Cs.Polygon(e)},Reflection:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=new Cs.Reflection(i);return n.xform_obj(r)},Dilation:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=new Cs.Dilation(i,r);return n.xform_obj(a)},"Dilation/3PtRatio":un,"Dilation/SegmentRatio":un,"Dilation/MarkedRatio":un,Rotation:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3]||1,s=new Cs.Rotation(i,r,a);return n.xform_obj(s)},"Rotation/MeasuredAngle":un,"Rotation/MarkedAngle":un,PlotXY:un,PlotFixedXY:un,Translation:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=new Cs.Translation(i,r);return n.xform_obj(a)},"Translation/MarkedAngle/FixedDistance":un,"Translation/FixedAngle/MarkedDistance":un,"Translation/MarkedAngle/MarkedDistance":un,PolarTranslation:un,VectorTranslation:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]),a=new Cs.VectorTranslation(i,r);return n.xform_obj(a)},Locus:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]),a=e[3]||200;return new Cs.Locus(i,r,n,a)},ImageOnPoint:un,ImageBetweenPoints:un,Image:un,MoveButton:un,AnimateButton:function(t){var e=t.args[0],n=e[0],i=e[1],r=e[2],a=this.gobjs_from_ints(t.args[1]),s=t.args[2],o=t.args[3],l=t.args[4];return new Cs.AnimateButton(n,i,r,a,s,o,l)},ShowButton:function(t){var e=t.args[0],n=e[0],i=e[1],r=e[2],a=t.args[1],s=this.gobjs_from_ints(a);return Cs.Button.new_show_button(this,n,i,r,s)},HideButton:function(t){var e=t.args[0],n=e[0],i=e[1],r=e[2],a=t.args[1],s=this.gobjs_from_ints(a);return Cs.Button.new_hide_button(this,n,i,r,s)},ToggleVisibilityButton:function(t){var e=t.args[0],n=e[0],i=e[1],r=e[2],a=t.args[1],s=this.gobjs_from_ints(a);return Cs.Button.new_toggle_button(this,n,i,r,s)},SimultaneousButton:un,AxisX:un,AxisY:un,UnitPoint:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1];return Cs.Point.new_unpt(n,i)},SquareUnitPoint:function(t){var e=t.args[0],n=this.read_gobjs(e[0]);return Cs.Point.new_squpt(n)},RectangularUnitPoint:un,HorizontalAxis:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return new Cs.HorizontalAxis(n,i)},VerticalAxis:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return new Cs.VerticalAxis(n,i)},Parameter:un,Length:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Length(n,i,r,a)},Angle:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]),a=e[3],s=e[4],o=e[5];return new Cs.Angle(n,i,r,a,s,o)},Angle2:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Angle2(n,i,r,a)},Perimeter:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Perimeter(n,i,r,a)},Circumference:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Circumference(n,i,r,a)},Area:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Area(n,i,r,a)},Radius:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Radius(n,i,r,a)},Radian:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.Radian(n,i,r,a)},"Ratio/Segments":function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3],s=e[4];return new Cs.RatioSegments(n,i,r,a,s)},"Ratio/Points":function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]),a=e[3],s=e[4],o=e[5];return new Cs.RatioPoints(n,i,r,a,s,o)},Slope:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3],s=e[4];return new Cs.Slope(n,i,r,a,s)},Distance:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3],s=e[4];return new Cs.Distance(n,i,r,a,s)},PointValue:un,Calculate:un,FunctionPlot:un,Function:un,"Origin&Unit":un,UnitCircle:un,Coordinates:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3],s=e[4];return new Cs.Coordinates(n,i,r,a,s)},Abscissa:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3],s=e[4];return new Cs.Abscissa(n,i,r,a,s)},Ordinate:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=e[2],a=e[3],s=e[4];return new Cs.Ordinate(n,i,r,a,s)},CoordinateDistance:un,CoordSysByAxes:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]);return new Cs.CoordSysByAxes(n,i)},FixedPoint:un,DriverPoint:un,PeggedText:un,ConcatText:un,FixedText:function(t){var e=t.args[0],n=e[0],i=e[1],r=e[2]||"",a=e[3]||0;return new Cs.FixedText(n,i,r,a)},Colorized_Spectrum:un,Colorized_Grayscale:un,Colorized_RGB:un,Colorized_HSV:un,BlinkButton:function(t){var e=t.args[0],n=e[0],i=e[1],r=e[2],a=t.args[1],s=this.gobjs_from_ints(a);return Cs.Button.new_blink_button(this,n,i,r,s)},LineMark:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2];return new Cs.LineMark(n,i,r)},AngleMark:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]),a=e[3]||1,s=e[4]||1;return new Cs.AngleMark(n,i,r,a,s)},Arc:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]);return new Cs.Arc(n,i,r)},ArcByThreePoint:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=this.read_gobjs(e[1]),r=this.read_gobjs(e[2]);return new Cs.ArcByThreePoint(n,i,r)},ArcLength:function(t){var e=t.args[0],n=this.read_gobjs(e[0]),i=e[1],r=e[2],a=e[3];return new Cs.ArcLength(n,i,r,a)},Sector:function(t){var e=t.args[0],n=this.read_gobjs(e[0]);return new Cs.Sector(n)},Arched:function(t){var e=t.args[0],n=this.read_gobjs(e[0]);return new Cs.Arched(n)}},qu=function(){function t(){ss(this,t),this.text=[],this.name_map={},this.name_x=0,this.name_0=0}return os(t,[{key:"add_line",value:function(t){return this.text.push(t),this}},{key:"get_content",value:function(){return this.text.join("\n")}},{key:"get_line0",value:function(){return this.text[0]}}]),t}(),Ru=/[a-zA-Z0-9]/,Fu="ABCDEFGHIJKLMNOPQRSTUVWXYZ";Ms.save_gsf=function(){return on(this)},Ms.parse_gsf=function(t){ln(this,t),this.draw()},Ms.read_gobjs=function(t){return this.obj_by_id[t]},Ms.gobjs_from_ints=function(t){var e=[],n=void 0,i=t.length;for(n=0;n<i;++n)e[n]=this.read_gobjs(t[n]);return e},Ms.save_gex=function(){yn(this)},Ms.save_as_png=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.canvas)return"";var e=this.canvas.toDataURL("image/png");return t?e:e.substring(22)},Ms.save_json=function(){this.reset_sid();var t={date:""+(new Date).toString(),gobjects:[]},e={pad:this,format:"json",file:t};return this.each(function(n){if(!n.is_temp){var i=n.to_json(e);t.gobjects.push(i)}}),t},Ms.load_json=function(t){this.clear();for(var e={pad:this,format:"json",file:t,obj_map:{},map_parents:function(t){if(!t)return null;for(var e=[],n=t.length,i=0;i<n;++i){var r=t[i];e[i]=this.obj_map[r]}return e}},n=t.gobjects,i=n.length,r=0;r<i;++r){var a=n[r],s=kn(this,e,a);this.append_obj(s)}},Ms.get_rotate_center=function(){var t=this._rotate_center;return t&&t._in_pad&&t.pad==this?t:null},Ms.set_rotate_center=function(t,e){if(this._rotate_center=t,t&&e){var n=new du(this,t.x,t.y,0);this.append_to_tmp(n),this.add_animate(n)}},Ms.get_mirror_line=function(){var t=this._mirror_line;return t&&t._in_pad&&t.pad==this?t:null},Ms.set_mirror_line=function(t,e){if(this._mirror_line=t,t&&e){var n=t.p1,i=t.p2,r=n.x,a=n.y,s=i.x,o=i.y,l=new du(this,2*r/3+s/3,2*a/3+o/3,1),u=new du(this,r/3+2*s/3,a/3+2*o/3,1);this.append_to_tmp(l),this.append_to_tmp(u),this.add_animate(l),this.add_animate(u)}},Ms.get_xlate_vec=function(){var t=this._xlate_vec;return t&&t.pS&&t.pE&&t.pS._in_pad&&t.pE._in_pad?t:null},Ms.set_xlate_vec=function(t,e){if(t&&e){this._xlate_vec={pS:t,pE:e};var n=new yu(this,t,e);this.append_to_tmp(n),this.add_animate(n)}else this._xlate_vec=null},Ms.get_size=function(){if(this.frame_table){var t=$(this.frame_table);return{x:t.width(),y:t.height()}}return this.get_canvas_size()},Ms.set_size=function(t,e){if(!this.container||!this.frame_table)return this.set_canvas_size(t,e);var n={width:t+"px",height:e+"px"};$(this.container).css(n),$(this.frame_table).css(n);var i=!this.opt.dis_menu,r=!this.opt.dis_toolbox,a=t,s=e;i&&(s-=24),r&&(a-=40),this.set_canvas_size(a,s)},Ms.get_canvas_size=function(){return{x:this.width,y:this.height}},Ms.set_canvas_size=function(t,e){var n=this.canvas;n&&(n.width=t,n.height=e,n.style.width=t+"px",n.style.height=e+"px",this.width=t,this.height=e,this.rc=new Bs(0,0,t,e))};var Du={object:{idx:0,title:"对象"},label:{idx:1,title:"标签"},value:{idx:2,title:"数值"},animate:{idx:3,title:"动画"},mark:{idx:4,title:"标记笔"},move:{idx:5,title:"移动"},text:{idx:6,title:"文本"},shbtn:{idx:7,title:"隐藏/显示"}},Lu=function(){function t(e,n){ss(this,t),this.pad=e,this.obj=n}return os(t,[{key:"open",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"label";if(this.def_page=t,this.pages=this.obj.get_prop_pages(),this.pages&&this.pages.length){this.$dlg_div=He();var e=this;We("../data/dialog/prop_dialog.js",function(t,n){e.$dlg_div.html(n),e._after_load()})}}},{key:"_after_load",value:function(){var t=this;$("#prop_dlg_form").submit(function(){return t.on_ok(),!1}),this.$tabs=$("#prop_dlg_body"),this.$tabs.tabs({activate:t.on_tabs_activate.bind(t)}),this._setup_tabs(),this.$dlg_div.dialog({title:"对象属性",width:436,height:320,dialogClass:"prop-dialog",open:t.on_open.bind(t),close:t.on_close.bind(t),buttons:{"确定":t.on_ok.bind(t),"取消":t.on_cancel.bind(t)}})}},{key:"_setup_tabs",value:function(){for(var t={},e=null,n=0;n<this.pages.length;++n){var i=this.pages[n];i==(this.pages.Default||this.def_page)&&(e=Du[i].idx),t[i]=i,$("#"+i+"_page_tab").show();var r=Du[i];this.$tabs.tabs("enable",r.idx)}
for(var a in Du)if(!t[a]){var s=Du[a];this.$tabs.tabs("disable",s.idx),$("#"+a+"_page_tab").hide()}null!==e&&this.$tabs.tabs("option","active",e),this.used_pages=t}},{key:"on_open",value:function(){for(var t=0;t<this.pages.length;++t)switch(this.pages[t]){case"object":this.obj.init_object_ppage(this);break;case"label":this.obj.init_label_ppage(this);break;case"value":this.obj.init_value_ppage(this);break;case"animate":this.obj.init_animate_ppage(this);break;case"mark":this.obj.init_mark_ppage(this);break;case"move":this.obj.init_move_ppage(this);break;case"text":this.obj.init_text_ppage(this);break;case"shbtn":this.obj.init_shbtn_ppage(this);break;default:throw new Error("todo: init property page "+this.pages[t])}this.pad.draw()}},{key:"on_tabs_activate",value:function(t,e){"label_prop_page"==e.newPanel[0].id&&$("#label_text").select().focus()}},{key:"on_ok",value:function(){for(var t={},e=0;e<this.pages.length;++e){var n=this.pages[e];switch(n){case"object":t.object=this.collect_object_data();break;case"label":t.label=this.collect_label_data();break;case"value":t.value=this.collect_value_data();break;case"animate":t.animate=this.collect_animate_data();break;case"mark":t.mark=this.collect_mark_data();break;case"move":t.move=this.collect_move_data();break;case"text":t.text=this.collect_text_data();break;case"shbtn":t.shbtn=this.collect_shbtn_data();break;default:console.warn("todo: collect data for ppage "+n)}}this._close(),this.obj.apply_prop_change(t),this.pad.draw()}},{key:"on_cancel",value:function(){this._close()}},{key:"on_close",value:function(t){Ve(t),this.$dlg_div.dialog("destroy"),this.$dlg_div.empty()}},{key:"collect_object_data",value:function(){return{visible:!$("#geo_object_visible").prop("checked"),selectable:$("#geo_object_selectable").prop("checked")}}},{key:"std_init_object_page",value:function(t){this.set_object_desc(t.type_cname+" "+t.get_disp_name(1)),this.fill_parent_objs(t.parents()),this.fill_children_objs(t.children()),this.set_object_visible(!!t.visible),this.set_object_selectable(t.selectable)}},{key:"set_object_desc",value:function(t){$("#geo_object_desc",this.$dlg_div).html(t)}},{key:"fill_parent_objs",value:function(t){var e=$("#geo_parent_objs");e.empty(),t&&t.length?(e.append(ue("父对象")),this._fill_list(e,t)):e.append(ue("无父对象"))}},{key:"fill_children_objs",value:function(t){var e=$("#geo_children_objs");e.empty(),t&&t.length?(e.append(ue("子对象")),this._fill_list(e,t)):e.append(ue("无子对象"))}},{key:"_fill_list",value:function(t,e){if(e&&e.length)for(var n=0;n<e.length;++n){var i=e[n],r=i.type_cname+" "+i.get_disp_name(),a=ue(r,i.obj_id);t.append(a)}}},{key:"set_object_visible",value:function(t){$("#geo_object_visible").prop("checked",!t)}},{key:"set_object_selectable",value:function(t){$("#geo_object_selectable").prop("checked",t)}},{key:"collect_label_data",value:function(){return{text:$("#label_text").val(),show:$("#label_show").prop("checked")}}},{key:"std_init_label_page",value:function(t){t.label&&t.label.text||(this.pad.make_name_for(t),"point"==t.type&&t.auto_label_pos()),$("#label_text").val(t.label.text).select(),$("#label_show").prop("checked",!!t.label.show),this.label_show_opt(!0)}},{key:"set_label_text",value:function(t){$("#label_text").val(t)}},{key:"label_show_opt",value:function(t){var e=$("#label_show_opt");t?e.show():e.hide()}},{key:"collect_value_data",value:function(){return{prec:qi($("#value_prec"),2)}}},{key:"set_value_prec",value:function(t){Mi($("#value_prec"),t,2)}},{key:"collect_animate_data",value:function(){return{}}},{key:"collect_mark_data",value:function(){for(var t=["am_inferior_angle","am_reflex_angle","am_anticlock","am_clockwise"],e=1,n=0;n<t.length;++n)if($("#"+t[n]).prop("checked")){e=n+1;break}return{a_sel:e,style:$("#am_style").prop("selectedIndex")+1,start_arrow:$("#am_start_arrow").prop("checked"),end_arrow:$("#am_end_arrow").prop("checked")}}},{key:"collect_move_data",value:function(){return{speed:qi($("#mpp_move_speed"),3)}}},{key:"collect_text_data",value:function(){return{text:$("#fixed_text_input").val()}}},{key:"set_fixed_text",value:function(t){$("#fixed_text_input").val(t)}},{key:"collect_shbtn_data",value:function(){var t=0;return t=$("#shbtn_show").prop("checked")?0:$("#shbtn_hide").prop("checked")?1:2,{act:t,sel:$("#shbtn_sel").prop("checked"),fade:$("#shbtn_fade").prop("checked")}}},{key:"set_shbtn_act",value:function(t){switch(t){case 0:$("#shbtn_show").prop("checked",!0);break;case 1:$("#shbtn_hide").prop("checked",!0);break;default:$("#shbtn_toggle").prop("checked",!0)}}},{key:"set_shbtn_sel",value:function(t){$("#shbtn_sel").prop("checked",t)}},{key:"set_shbtn_fade",value:function(t){$("#shbtn_fade").prop("checked",t)}},{key:"_close",value:function(){this.$dlg_div&&this.$dlg_div.dialog("close")}}]),t}();Ms.label_dlg=function(){var t=this.get_selected();if(t)switch(t.length){case 0:break;case 1:Ni(this);break;default:this.mobj_label_dlg(t.slice(0))}},Ms.mobj_label_dlg=function(t){if(t&&t.length){var e=this;Ri(e,function(n,i){if(n){for(var r=gu.parse_text(n),a=0;a<t.length;++a){var s=t[a],o=s.get_label();s.set_label(r.next(),i),"point"!=s.type||o||s.auto_label_pos()}e.draw()}})}};var Xu=function(){function t(){ss(this,t),this.$dlg_div=He()}return os(t,[{key:"show",value:function(t){var e=this;this.callback=t,We("../data/dialog/rotate_dialog.js",function(t,n){e.$dlg_div.html(n),e.open()})}},{key:"open",value:function(){var t=this;$("#geo_rotate_dlg").submit(function(){return t.on_ok()}),this.$dlg_div.dialog({title:"旋转变换",modal:!0,width:400,height:280,dialogClass:"prop-dialog",open:function(){return t.open()},close:function(e){return t.on_close(e)},buttons:{"确定":function(){return t.on_ok()},"取消":function(){return t.on_cancel()}}})}},{key:"close",value:function(){this.$dlg_div.dialog("close")}},{key:"destroy",value:function(){this.$dlg_div.dialog("destroy"),this.$dlg_div.empty()}},{key:"on_open",value:function(){$("#rot_angle").select().focus()}},{key:"on_close",value:function(t){Ve(t),this.destroy()}},{key:"on_ok",value:function(){var t=parseFloat($("#rot_angle").val()),e=parseFloat($("#rot_scale").val());if(this.close(),isNaN(e)&&(e=1),isNaN(t))return!1;var n={ang:t,rad:t*Math.PI/180,scale:e};return this.callback&&this.callback(n),!1}},{key:"on_cancel",value:function(){this.close()}}]),t}(),Yu={undo:wi,redo:Oi,del:$i,btn:Bn,sh_btn:Bn,blk_btn:Bn,ani_btn:zi,sel_all:Ii,pt_sty:Di,ln_sty:Xi,color:Hi,hide:Bn,show_all:ha,poo:tr,midpt:nr,intp:rr,seg:sr,ray:sr,line:sr,par:_r,perp:_r,bis:pr,circ:vr,circ_rad:yr,arc:br,arc_3:xr,inte:wr,poly:jr,cint:Pr,sect:Ar,arch:Ar,st_cent:Vr,st_refl:Jr,st_vec:Kr,x_xlate:ta,x_rota:ra,x_refl:sa,mlen:Un,mdist:Wn,mperi:Gn,mcirf:Qn,mang:Zn,marea:ei,mrad:ii,marcl:ai,mradi:oi,mrat:ui,mptv:hi},Uu={undo:ji,redo:Pi,del:Ai,clear:Si,sh_btn:Ti,blk_btn:Ei,ani_btn:Ci,sel_all:Bi,pts_1:Li,pts_2:Li,pts_3:Li,pts_4:Li,lnw_1:Yi,lnw_2:Yi,lnw_3:Yi,lnw_4:Yi,lns_0:Ui,lns_1:Ui,lns_2:Ui,"#000000":Wi,"#ff0000":Wi,"#ff8000":Wi,"#ffff00":Wi,"#00ff00":Wi,"#00ffff":Wi,"#0000ff":Wi,"#ff00ff":Wi,"#8a66d9":Wi,"#800080":Wi,"#008000":Wi,"#000080":Wi,"#800000":Wi,"#c0854a":Wi,"#c0c0c0":Wi,"#808080":Wi,hide:Vi,show_all:Gi,label:Ji,cons_lst:Qi,poo:er,midpt:ir,intp:ar,seg:or,ray:lr,line:ur,par:hr,perp:cr,bis:fr,circ:dr,circ_rad:gr,arc:mr,arc_3:kr,poly:Or,cint:$r,sect:Sr,arch:Tr,st_cent:Gr,st_refl:Qr,st_vec:Zr,x_xlate:ea,x_rota:aa,x_refl:oa,mlen:Hn,mdist:Vn,mperi:Jn,mcirf:Kn,mang:ti,marea:ni,mrad:ri,marcl:si,mradi:li,mrat:_i,mptv:ci};Ms.on_menu_status=function(t){var e=Yu[t];return e?e(this,t):Uu.hasOwnProperty(t)},Ms.on_menu_click=function(t){var e=Uu[t];e&&e(this,t)},Ms.on_set_label=function(t){var e=this.get_selected().slice(0);if(e.length){for(var n=gu.parse_text(t),i=0;i<e.length;++i){var r=e[i];r.set_label(n.next(),1),"point"==r.type&&r.auto_label_pos()}this.draw()}};var Hu={27:function(t){t.escape()},46:function(t){t._readonly||t.on_menu_click("del")},"Alt+191":function(t){t.label_dlg()},"Ctrl+77":function(t){t.on_menu_click("midpt")},"Ctrl+76":function(t){t.on_menu_click("seg")},"Ctrl+90":function(t){t.on_menu_click("undo")},"Ctrl+82":function(t){t.on_menu_click("redo")}};Ms.on_key_down=function(t){var e=t.keyCode.toString();t.shiftKey&&(e="Shift+"+e),t.altKey&&(e="Alt+"+e),t.ctrlKey&&(e="Ctrl+"+e);var n=Hu[e];n&&(n(this,t),pe(t))};var Wu=function(){function t(){ss(this,t),this.length=0,this.points=[],this.hit_ret=[],this.hit_label=null,this._as_array=!0}return os(t,[{key:"get_next_selobj",value:function(){var t=this,e=t.points,n=void 0,i=void 0;if(e&&(i=e.length)>0){for(n=i-1;n>=0;--n)if(e[n].selected)return e[n];return e[e.length-1]}for(i=t.length,n=i-1;n>=0;--n)if(t[n].selected)return t[n];return t[i-1]}}]),t}(),Vu={},Gu={groups:["angle","triangle","quadrangle","solid_figure"],angle:{name:"angle",title:"角工具",tools:[{name:"angle_30",title:"30°角"},{name:"angle_45",title:"45°角"},{name:"angle_60",title:"60°角"},{name:"angle_90",title:"90°角"},{name:"angle_120",title:"120°角(带标记)"},{name:"angle_180",title:"平角"},{name:"angle_360",title:"周角"}]},triangle:{name:"triangle",title:"三角形",tools:[{name:"tri",title:"任意三角形"},{name:"eqtri",title:"等边三角形"},{name:"isotri1",title:"等腰三角形1"},{name:"isotri2",title:"等腰三角形2"},{name:"isorttri",title:"等腰直角三角形"},{name:"rttri",title:"直角三角形"},{name:"rttri30",title:"含30°角的直角三角形"}]},quadrangle:{name:"quadrangle",title:"四边形",tools:[{name:"quadg",title:"四边形"},{name:"parag",title:"平行四边形"},{name:"rectg",title:"矩形"},{name:"diamg",title:"菱形"},{name:"squareg",title:"正方形"},{name:"trapzg",title:"梯形"},{name:"rttrap",title:"直角梯形"},{name:"isotrap",title:"等腰梯形"}]},solid_figure:{name:"solid_figure",title:"立体几何",tools:[{name:"cube",title:"正方体"},{name:"cuboid",title:"长方体"},{name:"rectangular_pyramid",title:"四棱锥"},{name:"circular_cone",title:"圆锥"}]},name_map:null,title_map:null};Cs.MacroTools2=Gu,function(){for(var t=Vu,e={},n=Gu.groups,i=0;i<n.length;++i)for(var r=n[i],a=Gu[r].tools,s=0;s<a.length;++s){var o=a[s],l=o.name,u=o.title;t[l]=o,e[u]=o}Gu.name_map=t,Gu.title_map=e}();var Ju=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),r=i.mdata=Vu[n];if(!r.loaded){console.log("macro-tool "+n+" need load data...");var a=function(){var t=r.url?r.url:"macrotool.php?tool="+n;return Cs.DATA_PATH+t+"&jsoncallback=?"}();$.getJSON(a,function(t){var e=JSON.parse(t);qs(r,e),r.loaded=!0})}return i.cleanup(),i}return us(e,t),os(e,[{key:"cleanup",value:function(){ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this),this.pp_arr=[],this.pp_num=0,this.is_track=!1,this.objs=[]}},{key:"mouse_down",value:function(t){if(this.mdata.loaded&&!this._downed){this._downed=!0;var e=this.create_or_pick_point(t.objX,t.objY);if(this._is_dup_pp(e))return void this.pad.draw();this._rm_track(),this.is_track=!1,this._add_pp(e,!1),this._cr_objs(),this.pp_num>=this.mdata.prev_points.length&&(this._fsh_cons(),this.cleanup(),this._downed=!0),this.pad.draw()}}},{key:"mouse_move",value:function(t){if(!this._downed){var e=this.move_track_point(t.objX,t.objY);if(this.pp_num>0&&!this.is_track){this.is_track=!0;var n={p:e,create:!1};this._add_pp(n,!0),this._cr_objs()}else this._upd_track();this.pad.draw()}}},{key:"mouse_up",value:function(t){this._downed=!1,this.pad.draw()}},{key:"escape",value:function(){this._rm_all(),this.cleanup()}},{key:"_is_dup_pp",value:function(t){for(var e=0;e<this.pp_num;++e)if(this.pp_arr[e].p===t.p)return!0;return!1}},{key:"_rm_track",value:function(){for(var t=this.objs,e=t.length,n=e-1;n>=0;--n){var i=t[n];i&&i.track&&(i.create&&this.pad.remove_tmp_obj(i.o),t[n]=null)}if(this.pp_num>0){this.pp_arr[this.pp_num-1].track&&(--this.pp_num,this.pp_arr.length=this.pp_num)}}},{key:"_upd_track",value:function(){this.objs.forEach(function(t){t&&t.track&&t.o.update()})}},{key:"_add_pp",value:function(t,e){var n=this.pp_num++;t.track=e,this.pp_arr[n]=t;var i=this.mdata.prev_points[n];this.objs[i]={o:t.p,create:t.create,track:e}}},{key:"_cr_objs",value:function(){for(var t=this.mdata,e=t.gobjects,n=t.prev_points,i=this.objs,r={pad:this.pad,format:"json",file:null,map_parents:function(t){if(!t)return null;for(var e=[],n=t.length,r=0;r<n;++r){var a=t[r];e[r]=i[a].o}return e},obj_map:{}},a=0;a<e.length;++a){var s=e[a],o=s.sid,l=n.indexOf(o);if(l>=0){if(l>=this.pp_num)break}else if(!i[o]){if(!function(t){for(var e=0;e<t.length;++e){var n=t[e];if(!i[n])return!1}return!0}(s.parents))break;var u=function(t){for(var e=0;e<t.length;++e){var n=t[e];if(i[n].track)return!0}return!1}(s.parents),_=kn(this.pad,r,s);_.visible||(_.visible=null),i[o]={o:_,create:!0,track:u},this.pad.append_to_tmp(_)}}}},{key:"_fsh_cons",value:function(){this._rm_all();for(var t=this.objs,e=t.length,n=0;n<e;++n){var i=t[n];i&&i.create&&this.pad.append_obj(i.o)}this.objs=[],this.pp_arr=[],this.pp_num=0;var r=this.mdata;void 0===r.counter?r.counter=1:++r.counter}},{key:"_rm_all",value:function(){for(var t=this.objs,e=t.length,n=e-1;n>=0;--n){var i=t[n];i&&i.create&&(i.o._in_pad?this.pad.delete_obj(i.o):this.pad.remove_tmp_obj(i.o))}}}]),e}(Su),Qu={};Ms.hit_test=function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Qu,i=n.skip,r=n.hit_first,a=n.label,s=n.filter,o=new Wu,l=this.head_obj;l;l=l.next_obj)if(l.exist&&l.visible&&l!==i&&!l.is_temp&&(!s||s(l))){if(a&&l.label){var u=l.label.hit_test(t,e);if(u)return o[o.length++]=l,o.hit_ret.push("label"),o.hit_label=l.label,o}var _=l.hit_test(t,e);if(_&&(o[o.length++]=l,o.hit_ret.push(_),"point"==l.type&&o.points.push(l),r))return o}return o},Ms.rc_hit_test=function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qu,n=e.skip,i=e.hit_first,r=new Wu,a=this.head_obj;a;a=a.next_obj)if(a.exist&&a.visible&&a!==n&&!a.is_temp){var s=a.rc_hit_test(t,e);if(s&&(r[r.length++]=a,r.hit_ret.push(s),"point"==a.type&&r.points.push(a),i))return r}return r},Ms.set_cursor=function(t){var e=this.canvas;return e&&e.style.cursor!=t&&(e.style.cursor=t),this},Ms.get_track_point=function(){return this.track_point},Ms.on_mouse_down=function(t){this.set_key_focus(),pa(t);var e=fa(this);e._down_x=e._mouse_x=t.objX,e._down_y=e._mouse_y=t.objY,e.mouse_down(t)},Ms.on_mouse_move=function(t){pa(t);var e=fa(this);e._mouse_x=t.objX,e._mouse_y=t.objY,e.mouse_move(t)},Ms.on_mouse_up=function(t){pa(t);var e=fa(this);e._up_x=e._mouse_x=t.objX,e._up_y=e._mouse_y=t.objY,e.mouse_up(t)},Ms.on_dbl_click=function(t){this.set_key_focus(),pa(t);var e=fa(this);e&&e.dbl_click(t)},Ms.escape=function(){function t(){e._toolbox&&e._toolbox.reset()}var e=this,n=e._mouse_tool;if(!n)return void t();"select"==n.name?(e.unselect_all(),e.draw(),t()):(n.escape(),t(),e.select_tool("select"))},Ms.clear_tool=function(){return this._mouse_tool&&this._mouse_tool.cleanup(),this.select_tool("select"),this},Ms.select_tool=function(t){this._mouse_tool&&this._mouse_tool.cleanup();var e=Au[t];return e?(this._mouse_tool=new e(this,t),this.draw(),this._mouse_tool):(console.error("select_tool error: "+t),null)},Ms.on_tool_clicked=function(t){this.set_key_focus(),"macros"!=t&&this.select_tool(t)},Ms.on_macro_tool=function(t){return this.set_key_focus(),this._mouse_tool&&this._mouse_tool.cleanup(),this._mouse_tool=new Ju(this,t),this.draw(),this._mouse_tool};var Ku=Su.prototype;Ku.move_track_point=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=this.pad;r.highlight_objs();var a=this.cur_point;a||(a=this.cur_point=r.get_track_point()),a.x=t,a.y=e,a.visible=!n,a.highlight=!1;var s=r.hit_test(t,e,{skip:a,filter:i});if(!s.length)return a;if(a.visible=!0,s.points.length>0){var o=s.points[s.points.length-1];return a.x=o.x,a.y=o.y,r.highlight_objs([a]),a}var l=va(s,t,e);if(l)return r.highlight_objs([l.obj1,l.obj2]),a.x=l.x,a.y=l.y,a;var u=s[s.length-1];if("line"==u.type||"circle"==u.type){r.highlight_objs([u]);var _=u.point_proj_info(t,e);return a.x=_.x,a.y=_.y,a}return a},Ku.create_or_pick_point=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=this,r=this.pad,a=null,s=r.hit_test(t,e,{skip:i.cur_point,filter:n});if(0==s.length)return a=ll.new_xy(t,e,r),r.append_obj(a),{p:a,create:!0};if(s.points.length>0)return a=s.points[s.points.length-1],{p:a,create:!1};var o=va(s,t,e);if(o)return(a=Cs.Point.find_intpt(o.obj1,o.obj2,o.isel))?(a.visible=!0,{p:a,create:!1}):(a=Cs.Point.new_intpt(o.obj1,o.obj2,o.isel,r),r.append_obj(a),{p:a,create:!0});var l=s[s.length-1];if("line"==l.type||"circle"==l.type){var u=l.point_proj_info(t,e);return a=ll.new_oopt(l,u.t,r),r.append_obj(a),{p:a,create:!0}}return a=ll.new_xy(t,e,r),r.append_obj(a),{p:a,create:!0}};var Zu=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return us(e,t),os(e,[{key:"mouse_move",value:function(t){this.pad.is_readonly()||this._downed||(this.move_track_point(t.objX,t.objY),this.pad.draw())}},{key:"mouse_down",value:function(t){var e=this,n=e.pad;if(!n.is_readonly()){e._downed=!0;var i=e.create_or_pick_point(t.objX,t.objY);i.create&&n.get_history().do_oper("创建点",function(t){t.add_create_rec(i.p)}),n.select_objs([i.p]),n.highlight_objs(),e.cur_point=null,n.draw()}}},{key:"mouse_up",value:function(t){this._downed=!1,this.cleanup(),this.pad.draw()}}]),e}(Su),t_=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i._setup_creator(),i.cur_point=null,i.prev_pp=null,i.tmp_obj=null,i}return us(e,t),os(e,[{key:"cleanup",value:function(){ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this);var t=this;t._rm_tmp(),t.prev_pp&&t.prev_pp.create&&t.pad.delete_obj(this.prev_pp.p),t.prev_pp=null,t.delay_move=!1}},{key:"mouse_down",value:function(t){var e=this,n=e.pad;if(!n.is_readonly()&&!e._downed){e._downed=!0;var i=e.create_or_pick_point(t.objX,t.objY);n.select_objs([i.p]),n.highlight_objs(null),e.cur_point=null;var r=e.prev_pp;r?(e._rm_tmp(),r.p!=i.p?e.cons_obj(r,i):r.create&&n.delete_obj(r.p),e.prev_pp=null):(e.prev_pp=i,e.delay_move=!0,e._down_x=t.objX,e._down_y=t.objY),n.draw()}}},{key:"mouse_move",value:function(t){var e=this,n=e.pad;if(!n.is_readonly()&&(!e._downed||e.prev_pp)){if(e.prev_pp&&e.delay_move){var i=e._down_x-t.objX,r=e._down_y-t.objY;if(i*i+r*r<=28)return;e.delay_move=!1}var a=e.prev_pp;if(a){var s=e.move_track_point(t.objX,t.objY,!1,function(t){return t!=a.p});s!=a.p&&(e.tmp_obj||(e.tmp_obj=e.new_object(a.p,s),n.append_to_tmp(e.tmp_obj)),this.tmp_obj.update())}else e.move_track_point(t.objX,t.objY,!0);n.draw()}}},{key:"mouse_up",value:function(t){var n=this;if(n._downed&&n.prev_pp&&n.cur_point){n._rm_tmp();var i=n.create_or_pick_point(t.objX,t.objY);i.p!=n.prev_pp.p?n.cons_obj(n.prev_pp,i):n.cleanup(),n.prev_pp=null,n.pad.highlight_objs(null)}n._downed=n.delay_move=!1,ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this),n.pad.draw()}},{key:"_setup_creator",value:function(){switch(this.name){case"segment":this.new_object=bl.new_seg,this.find_object=bl.find_seg,this.obj_name="线段";break;case"ray":this.new_object=bl.new_ray,this.find_object=bl.find_ray,this.obj_name="射线";break;case"line":this.new_object=bl.new_sline,this.find_object=bl.find_sline,this.obj_name="直线";break;case"circle":this.new_object=xl.new_circle,this.find_object=xl.find_circle,this.obj_name="圆";break;default:throw new Error("TwoptTool unknown tool name: "+this.name)}}},{key:"_rm_tmp",value:function(){this.tmp_obj&&(this.pad.remove_tmp_obj(this.tmp_obj),this.tmp_obj=null)}},{key:"cons_obj",value:function(t,e){var n=this;if(t.p!==e.p){var i=this,r=i.pad,a=i.find_object(t.p,e.p);return a?a.visible=!0:function(){a=i.new_object(t.p,e.p),r.append_obj(a);var s=r.get_history();s.do_oper("创建"+n.obj_name,function(){t.create&&s.add_create_rec(t.p),e.create&&s.add_create_rec(e.p),s.add_create_rec(a)})}(),r.select_objs([a]),a}}}]),e}(Su),e_=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.pps=[],i.segs=[],i.created_objs=[],i.tmp_poly=null,i.cr_poly=!0,"polygon2"==n&&(i.cr_seg=!0),"polygon3"==n&&(i.cr_seg=!0,i.cr_poly=!1),i}return us(e,t),os(e,[{key:"cleanup",value:function(){this.tmp_poly&&(this.pad.remove_tmp_obj(this.tmp_poly),this.tmp_poly=null),this._rm_tmp_seg(!0),this.pps=[],this.segs=[],this.created_objs=[],ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this)}},{key:"mouse_down",value:function(t){var e=this;if(!e.pad.is_readonly()&&!e._downed){e._downed=!0,e._rm_tmp_seg();var n=e._build_filter(),i=e.create_or_pick_point(t.objX,t.objY,n);if(i.create&&this.created_objs.push(i.p),e.pad.highlight_objs(),e._pp_end(i))return e._downed=!1,e.cr_seg&&e._cl_seg(),e.cr_poly&&e._cr_poly(),e._set_undo_rec(),e.cleanup(),void e.pad.draw();e.delay_move=!0,e._down_x=t.objX,e._down_y=t.objY,e._add_pp(i),e.pad.draw()}}},{key:"mouse_move",value:function(t){var e=this,n=e.pad;if(!n.is_readonly()){if(e.delay_move){var i=e._down_x-t.objX,r=e._down_y-t.objY;if(i*i+r*r<=28)return;e.delay_move=!1}if(0==e.pps.length)e.move_track_point(t.objX,t.objY,!0),n.draw();else{var a=e._build_filter(),s=e.move_track_point(t.objX,t.objY,!1,a);e.cr_seg&&e._upd_seg(s),e.cr_poly&&e._upd_poly(s),n.draw()}}}},{key:"mouse_up",value:function(t){this._downed&&(this._downed=!1,this.pad.draw())}},{key:"escape",value:function(){var t=this,e=t.pad;t.tmp_poly&&e.remove_tmp_obj(t.tmp_poly),t.tmp_poly=null,t._rm_tmp_seg(!0);var n=t.created_objs;if(n&&n.length)for(var i=n.length-1;i>=0;--i)e.delete_obj(n[i]);t.cleanup()}},{key:"_build_filter",value:function(){var t=this;return t.cr_seg?function(e){if(!(e instanceof pl))return!0;for(var n=t.segs,i=n.length,r=0;r<i;++r)if(n[r].seg===e)return!1;return!0}:null}},{key:"_pp_end",value:function(t){for(var e=this.pps,n=e.length,i=0;i<n;++i)if(e[i].p==t.p)return!0;return!1}},{key:"_add_pp",value:function(t){var e=this,n=e.pps;if(n.push(t),e.cr_seg&&e._cr_seg(),e.cr_poly){e.tmp_poly||(e.tmp_poly=new Il([]),e.tmp_poly.color=w(),e.pad.append_to_tmp(e.tmp_poly));for(var i=e.tmp_poly.vertexs=[],r=0;r<n.length;++r)i[r]=n[r].p;e.tmp_poly.update()}}},{key:"_cr_seg",value:function(){var t=this.pps,e=t.length;if(!(e<2)){var n=t[e-1],i=t[e-2];this._cr_s2(i,n)}}},{key:"_cl_seg",value:function(){var t=this.pps,e=t.length;if(!(e<3)){var n=t[e-1],i=t[0];this._cr_s2(n,i)}}},{key:"_cr_s2",value:function(t,e){var n=this.segs,i=bl.find_seg(t.p,e.p);i?(i.visible=!0,n.push({seg:i,create:!1})):(i=bl.new_seg(t.p,e.p),this.pad.append_obj(i),i.update(),n.push({seg:i,create:!0}),this.created_objs.push(i))}},{key:"_upd_poly",value:function(t){var e=this.tmp_poly;if(e){var n=e.vertexs;n.indexOf(t)>=0||(n.push(t),e.update())}}},{key:"_rm_tmp_seg",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this;e._seg_last&&(e.pad.remove_tmp_obj(e._seg_last),e._seg_last=null),t&&e._seg_first&&(e.pad.remove_tmp_obj(e._seg_first),e._seg_first=null)}},{key:"_upd_seg",value:function(t){var e=this;if(e.cr_seg){var n=e.pps,i=n.length;if(i){if(!e._seg_last){var r=n[i-1].p;e._seg_last=new pl(r,t),e.pad.append_to_tmp(e._seg_last)}if(e._seg_last.update(),i>1){if(!e._seg_first){var a=n[0].p;e._seg_first=new pl(t,a),e.pad.append_to_tmp(e._seg_first)}e._seg_first.update()}}}}},{key:"_cr_poly",value:function(){if(this.cr_poly){var t=this.pps,e=t.length,n=[];if(!(e<3)){for(var i=0;i<e;++i)n.push(t[i].p);var r=new Il(n);r.color=this.tmp_poly.color,this.pad.append_obj(r),r.update(),this.created_objs.push(r)}}}},{key:"_set_undo_rec",value:function(){var t=this.created_objs;t&&t.length&&this.pad.get_history().do_oper("构造多边形",function(e){for(var n=0;n<t.length;++n)e.add_create_rec(t[n])})}}]),e}(Su),n_=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"mark";return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return us(e,t),os(e,[{key:"mouse_move",value:function(t){var e=this,n=e.pad;{if(!e._downed){var i=n.hit_test(t.objX,t.objY);if(0==i.length)return void n.set_cursor("default");if(i.points.length>0)return void n.set_cursor("crosshair");var r=i[i.length-1];return"line"==r.type||"circle"==r.type?void n.set_cursor("crosshair"):"mark"==r.type?void n.set_cursor("pointer"):void n.set_cursor("default")}if(e.amark_pt){var a=e._try_create_amark(t.objX-e._down_x,t.objY-e._down_y,!1);return n.draw_direct(!0),void(a&&a.draw(n.ctx,n))}if(e.mark instanceof lu){if(!e.is_move_started(t))return;var s=e.mark.path1,o=s.point_proj_info(t.objX,t.objY);return e.mark.t=o.t,e.mark.update(),void n.draw()}}}},{key:"mouse_down",value:function(t){var e=this,n=e.pad;e._downed=!0,e._moved=!1,e.cached_amark_pt=null;var i=n.hit_test(t.objX,t.objY);if(0!=i.length){if(i.points.length>0)return void(e.amark_pt=i.points[0]);var r=i[i.length-1];if(r instanceof il||r instanceof sl)return void(e.path_obj=r);(r instanceof lu||r instanceof Ml)&&(e.mark=r,n.select_objs([r]),n.draw(),e.mark_moved=!1)}}},{key:"mouse_up",value:function(t){var e=this,n=e.pad,i=t.objX,r=t.objY;if(e._downed){if(e._downed=!1,e.amark_pt){return e._try_create_amark(t.objX-e._down_x,t.objY-e._down_y,!0)&&n.draw_direct(!0),e.amark_pt=null,void(e._moved=!1)}if(e.mark)return e._moved||(e.mark.next_style(),n.draw()),void(e.mark=null);if(e.path_obj){var a=e.path_obj.point_proj_info(i,r),s=new lu(e.path_obj,a.t,1);n.append_obj(s),n.select_objs([s]),n.draw(),n.set_cursor("pointer"),e.path_obj=null}}}},{key:"cleanup",value:function(){ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this),this.amark_pt=null,this.cached_amark_pt=null,this.cached_ray_arr=null}},{key:"_try_create_amark",value:function(t,e,n){var i=this,r=void 0;if(i.amark_pt===i.cached_amark_pt?r=i.cached_ray_arr:(r=i.cached_ray_arr=Aa(i.pad,i.amark_pt),i.cached_amark_pt=i.amark_pt),!r||r.length<=1)return null;var a=u(t,e),s=Ea(r,a),o=i.pad,l=i.amark_pt;if(n){var _=i.foc_pt_on_edge(s[0],l),h=i.foc_pt_on_edge(s[1],l),c=Ml.find(_,l,h);return c||(c=new Ml(_,l,h,1),o.append_obj(c)),c}var p=za(s[0],l),f=za(s[1],l);return new Ml(p,l,f,1)}},{key:"foc_pt_on_edge",value:function(t,e){var n=t.line,i=$a(this.pad,n),r=void 0;if((r=1==t.dir?Ia(i,t.t+fs):Ca(i,t.t-fs))>=0)return i[r].pt;var a=100/n.leng(),s=n.calc_pt_t(e),o=1==t.dir?s+a:s-a,l=ll.new_oopt(n,o);return this.pad.append_obj(l),l}}]),e}(Su),i_=function(t){function e(t){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"button"))}return us(e,t),os(e,[{key:"mouse_down",value:function(t){this._downed=!0,this.button&&this.button.on_mouse_paint(this.pad,t)}},{key:"mouse_move",value:function(t){this.button&&this.button.on_mouse_paint(this.pad,t)}},{key:"mouse_up",value:function(t){if(this._downed){this.button.hit_test(t.objX,t.objY)&&this.button.fire_click()}this._downed=!1,this.button.draw(this.pad.ctx,this.pad),this.pad.select_tool("select"),this.pad.on_mouse_move(t)}}]),e}(Su),r_=function(t){function e(t){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"label"))}return us(e,t),os(e,[{key:"set_object",value:function(t){this.obj=t,this.label=t.label}},{key:"cleanup",value:function(){ls(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"cleanup",this).call(this),this.event=null}},{key:"mouse_down",value:function(t){this.event="down",this.start_x=t.objX,this.start_y=t.objY,this.cur_x=t.objX,this.cur_y=t.objY,this.delta_x=0,this.delta_y=0,this.label.on_move(this),this.pad.highlight_objs([this.obj]),this.pad.draw()}},{key:"mouse_move",value:function(t){this.is_move_started(t)&&(this.event="move",this.cur_x=t.objX,this.cur_y=t.objY,this.delta_x=t.objX-this.start_x,this.delta_y=t.objY-this.start_y,this.label.on_move(this),this.pad.draw())}},{key:"mouse_up",value:function(t){this.event="up",this.cur_x=t.objX,this.cur_y=t.objY,this.delta_x=t.objX-this.start_x,this.delta_y=t.objY-this.start_y,this.label.on_move(this),this.pad.highlight_objs(null),this.pad.draw(),this.pad.select_tool("select")}}]),e}(Su),a_=function(t){function e(t){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,"text"))}return us(e,t),os(e,[{key:"mouse_down",value:function(t){var e=new Nl(t.objX,t.objY,"请输入文本",0);this.pad.append_obj(e),this.pad.select_objs([e]),this.pad.draw(),this.pad.escape(),Ge(this.pad,e)}}]),e}(Su);Au.select=Cu,Au.point=Zu,Au.segment=t_,Au.ray=t_,Au.line=t_,Au.circle=t_,Au.polygon=Au.polygon2=Au.polygon3=e_,Au.mark=n_,Au.button=i_,Au.label=r_,Au.text=a_,Au.macro=Ju,ll.new0=function(){return ll.new_xy()},ll.new_xy=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=new ll(t,e);return ll._init_point(i,n),i},ll.new_vpoint=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=new ul(t,e);return ll._init_point(i,n),i},ll.new_midpt=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=new rl(t);return ll._init_point(n,e),n.update(),n},ll.new_oopt=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=new al(t,e);return ll._init_point(i,n),i.update(),i},ll.new_intpt=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=new ol(t,e,n);return ll._init_point(r,i),r.update(),r},ll.new_xformed=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=new _l(t,e);return n.update(),n},ll.new_unpt=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,n=new hl(t,e);return n.update(),n},ll.new_squpt=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=new cl(t);return e.update(),e},Qo.prototype.xform_obj=function(t){return ll.new_xformed(this,t)},Qo.prototype.auto_label_pos=function(){if(this.label&&this.label.show&&this.label.text){var t=Ba(this);t&&t.length&&(this.label.update_data(this.pad),Na(this.label,this,t))}};var s_=function(){for(var t=Ma(),e=0;e<t.length;++e){var n=t[e];n.a=u(n.x,n.y),n.d=ms(n.x*n.x+n.y*n.y)}return t}();sl.prototype.xform_obj=function(t){return new wl(this,t)};var o_="pop",l_={object:null,point:"object",line:"object",seg:"line",ray:"line",sline:"line",paral:"sline",perpl:"sline",bisl:"ray",circ:"object",mark:"object",amark:"mark",judge:"object",func:"object",coll:"func",not_coll:"func",para:"func",perp:"func",intpt_ll:"func",midpt:"func",cycl:"func",eqdist:"func",eqang:"func",con_tri:"func",sim_tri:"func",equ_tri:"func",ang_is:"func",tri:"func"},u_={unlabel:"error",errtype:"error",multi:"error",invisible:"error",unexist:"error",error:null,false:"error"},__=function(){function t(e,n){ss(this,t),this.name=e,this.conds=n}return os(t,[{key:"has_err_type",value:function(t){return this.conds.hasOwnProperty(t)}},{key:"trans_error_info",value:function(t,e,n){for(var i="",r=e;r&&!(i=this.conds[r]);r=u_[r]);if(i||(i="一般的检查错误("+e+","+n+")"),!t)return i;G(t)||(t=[t]);for(var a=$s(t.length,h_.length),s=0;s<a;++s){var o=t[s],l=Xa(o),u=h_[s];l&&u&&(i=O(i,u,l))}return i}}]),t}(),h_=["$x","$y","$z","$u","$v","$w"],c_=257,p_={"==":"==","~=":"~=",">=":">=","<=":"<=","!=":"!="},f_=function(){function t(e,n){ss(this,t),this.opt_newln=!0,this.opt_idenws=!1,this.opt_dollar=!0,this.opt_prime=!0,this.str=e,this.len=e.length,this.ptr=0,this.ch=-1,this.cc=-1,this.token=-1,this.lvalue=null,this.line=1,this.col=0,this.opt=n||{}}return os(t,[{key:"cur_ch",value:function(){var t=this,e=t.ptr;if(e>=t.len)return t.ch="",t.cc=-1,"";var n=t.ch=t.str.charAt(e);return t.cc=n.charCodeAt(0),n}},{key:"next_ch",
value:function(){var t=this;return t.ptr>=t.len?(t.ch="",t.cc=-1,""):("\n"===t.str.charAt(t.ptr++)?(++t.line,t.col=0):++t.col,t.cur_ch())}},{key:"skip_ws",value:function(){for(;;){var t=this.cur_ch();if(" "===t||"\t"===t||"\r"===t);else if("\n"!==t||!this.opt_newln)return t;this.next_ch()}}},{key:"is_iden_start",value:function(t){if(null===t)return!1;var e=t.charCodeAt(0);return 65<=e&&e<=90||97<=e&&e<=122||"_"===t||!("$"!==t||!this.opt_dollar)}},{key:"is_iden_ch",value:function(t){if(null===t)return!1;var e=t.charCodeAt(0);return 48<=e&&e<=57||"_"===t||(65<=e&&e<=90||97<=e&&e<=122||(!(36!==e||!this.opt_dollar)||!(39!==e&&34!==e||!this.opt_prime)))}},{key:"read_iden",value:function(){for(var t=this,e=t.cur_ch(),n=t.next_ch();;){if(!t.is_iden_ch(n))break;e+=n,n=t.next_ch()}return t.lvalue=e,t.token=c_,c_}},{key:"read_num",value:function(){for(var t=this,e=t.cur_ch(),n="";48<=this.cc&&this.cc<=57;)n+=e,e=this.next_ch();if("."===e)for(n+=".",e=this.next_ch();48<=this.cc&&this.cc<=57;)n+=e,e=this.next_ch();if("e"===e||"E"===e){if(n+="E",e=this.next_ch(),"-"!==e&&"+"!==e||(n+=e,e=this.next_ch()),!(48<=this.cc&&this.cc<=57))return this.lvalue="",this.token=256;for(;48<=this.cc&&this.cc<=57;)n+=e,e=this.next_ch()}return this.lvalue=parseFloat(n),this.token=258}},{key:"read_str",value:function(){for(var t=this,e=t.cur_ch(),n="",i=t.next_ch();;)if(i===e){if((i=t.next_ch())!==e)break;n+=e,i=t.next_ch()}else{if(""===i)return t.lvalue="",t.token=256;n+=i,i=t.next_ch()}return t.lvalue=n,t.token=259}},{key:"read_sgn",value:function(t){var e=this,n=e.next_ch();if(""!==n){var i=p_[t+n];if(i)return e.next_ch(),e.token=e.lvalue=i}return e.token=e.lvalue=t}},{key:"next_tok",value:function(){var t=this,e=t.skip_ws();if(""===e)return t.token=t.lvalue=-1;if(t.is_iden_start(e))return t.read_iden();var n=e.charCodeAt(0);return 48<=n&&n<=57?t.read_num():"'"===e||'"'===e?t.read_str():t.read_sgn(e)}}]),t}(),v_=function(t){function e(t){ss(this,e);var n=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.name="CheckError",n}return us(e,t),e}(Error),d_=function(){function t(e){ss(this,t),this.name=e,this.bind_num=0,this.val=null}return os(t,[{key:"toString",value:function(){return"{SYM "+this.name+" = "+this.val+"}"}},{key:"is_bound",value:function(){return this.bind_num>0}},{key:"add_bind",value:function(t){0==this.bind_num?this.val=t:1==this.bind_num?this.val=[this.val,t]:this.val.push(t),++this.bind_num}},{key:"get_bind",value:function(t){t||(t=j);var e=this.bind_num,n=this.val;if(0==e)return null;if(1==e)return t(n)?n:null;for(var i=null,r=0,a=0;a<e;++a){var s=n[a];t(s)&&(0==r?i=s:1==r?i=[i,s]:i.push(s),++r)}return i}},{key:"typed_val",value:function(t){return this.get_bind(function(e){return e.type===t||e.sub_type===t})}}]),t}(),y_=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;ss(this,t),this.parent=e,this.rules={}}return os(t,[{key:"add_rule",value:function(t){return this.rules[t.name]=t,this}},{key:"find_rule",value:function(t,e){for(var n=this,i=n.rules,r=t;r;){var a=i[r];if(a)for(var s=e;s;s=u_[s])if(a.has_err_type(s))return a;if("object"===r)break;r=l_[r]||"object"}return n.parent?n.parent.find_rule(t,e):null}},{key:"get_parent",value:function(){return this.parent}}]),t}(),g_=void 0,b_=function t(){ss(this,t)},m_=function(t){function e(t,n){ss(this,e);var i=_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.name=t,n&&(i.alias=n),i}return us(e,t),os(e,[{key:"invoke",value:function(t,e){return e[this.alias||this.name].apply(e,t)}}]),e}(b_),x_={print:function(){try{console.log.apply(console,arguments)}catch(t){}},abs:Math.abs,acos:Math.acos,asin:Math.asin,atan:Math.atan,atan2:Math.atan2,ceil:Math.ceil,cos:Math.cos,exp:Math.exp,floor:Math.floor,log:Math.log,max:Math.max,min:Math.min,pow:Math.pow,random:Math.random,round:Math.round,sin:Math.sin,sqrt:Math.sqrt,tan:Math.tan,px2cm:function(t){return t/Cs.PIX2CM},cm2px:function(t){return t*Cs.PIX2CM},rad2d:function(t){return 180*t/vs},d2rad:function(t){return t*vs/180},any_line:new m_("any_line","line")};"point line seg x_seg ray sline paral perpl bisl circ angle_v angle bisln coll not_coll para perp intpt_ll midpt cycl eqdist eqang con_tri sim_tri equ_tri ang_is tri acute_tri right_tri obtuse_tri amark lmark mk_ss ratio ratio_2 is_square is_rect is_diam is_paralg is_trapz quad intpt vpoint vline vseg judge dist at_ray at_seg at_line pt_at is_refl ln_intp cc_intp lc_intp cr_rel cr_devi cr_xtang cr_itang cr_intp cr_inc xpoly vpoly in_poly refl_pt sm_side foot tri_centroid tri_orthocentre tri_circumcentre tri_incentre ln_xk same_pt ang_r2 ang_rel is_sel sel_tool obj_num mt_cnt".split(" ").forEach(function(t){x_[t]=new m_(t)});var k_={add:function(t,e){return t+e},sub:function(t,e){return t-e},mult:function(t,e){return t*e},div:function(t,e){return t/e},mod:function(t,e){return t%e},eq:function(t,e){return t==e},neq:function(t,e){return t!=e},aeq:function(t,e){return bs(t-e)<fs},lt:function(t,e){return t<e},gt:function(t,e){return t>e},le:function(t,e){return t<=e},ge:function(t,e){return t>=e}},w_=function(){function t(){ss(this,t),this.init()}return os(t,[{key:"init",value:function(){this.vars={_PI:Math.PI,_E:Math.E},this.sym_tab={},this.rules=Ua(),this.stack=[],this.sp=0,this.error_count=0,this.check_result="",this.disable_error=!1}},{key:"bind_pad",value:function(t){var e=this,n=e.sym_tab;e.pad=t,t.each(function(t){var e=t.name||t.get_label();if(e){var i=n[e];i||(n[e]=i=new d_(e)),i.add_bind(t)}})}},{key:"exec",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this,i=n.stack,r=[],a=t.fn.code,s=0,o=void 0,l=void 0,u=void 0;;){var _=a[s++];switch(_){case"push_const":i[this.sp++]=a[s++];break;case o_:i[--this.sp]=null;break;case"get_global":o=a[s++],i[this.sp++]=n.get_global(o);break;case"set_global":o=a[s++],n.set_global(o,i[this.sp-1]);break;case"get_arg":o=a[s++],i[this.sp++]=e[o];break;case"set_arg":o=a[s++],e[o]=i[this.sp-1];break;case"get_local":o=a[s++],i[this.sp++]=r[o];break;case"set_local":o=a[s++],r[o]=i[this.sp-1];break;case"get_field":l=a[s++],o=this.stack[this.sp-1],u=this.get_fieldx(o,l),i[this.sp-1]=u;break;case"set_field":throw new Error("SET_FIELD not supported");case"add":case"sub":case"mult":case"div":case"mod":case"eq":case"neq":case"aeq":case"lt":case"le":case"gt":case"ge":l=i[--this.sp],i.length=this.sp,o=i[this.sp-1],u=k_[_](o,l),i[this.sp-1]=u;break;case"u_+":i[this.sp-1]=+i[this.sp-1];break;case"u_-":i[this.sp-1]=-i[this.sp-1];break;case"u_!":i[this.sp-1]=!i[this.sp-1];break;case"jmp":o=a[s++],s+=o;break;case"jmp_true":o=a[s++],i[this.sp-1]&&(s+=o);break;case"jmp_false":o=a[s++],i[this.sp-1]||(s+=o);break;case"invoke":case"at_invoke":this.invoke(a[s++],"at_invoke"==_);break;case"chain_rule":u=a[s++],this.rules=new y_(this.rules),this.rules.add_rule(u);break;case"unchain_rule":this.rules=this.rules.get_parent();break;case"return":return o=i[--this.sp],i.length=this.sp,o;case"halt":return null;default:throw new Error("Invalid inst: "+_)}}}},{key:"get_global",value:function(t){if(this.vars.hasOwnProperty(t))return this.vars[t];if("$"!==t.charAt(0))return this.sym_tab.hasOwnProperty(t)?this.sym_tab[t]:x_.hasOwnProperty(t)?x_[t]:this.sym_tab[t]=new d_(t)}},{key:"get_fun",value:function(t){return x_.hasOwnProperty(t)?x_[t]:this.vars.hasOwnProperty(t)?this.vars[t]:null}},{key:"set_global",value:function(t,e){this.vars[t]=e,e instanceof Xo&&e.is_virtual&&!e.name&&(e.name="$"===t.charAt(0)?t.substring(1):t)}},{key:"intern_symbol",value:function(t){t=String(t);var e=this,n=e.sym_tab;return n.hasOwnProperty(t)?n[t]:n[t]=new d_(t)}},{key:"get_fieldx",value:function(t,e){return null==t?null:t instanceof Xo&&"name"===e?t.name||t.get_label():t[e]}},{key:"invoke",value:function(t,e){for(var n=this.stack,i=[],r=this.sp=this.sp-t,a=0;a<t;++a)i.push(n[r++]);var s=n[this.sp-1];n.length=this.sp,s instanceof d_&&(s=this.get_fun(s.name));var o=this.disable_error;this.disable_error=e;try{var l=void 0;if(s instanceof b_)l=s.invoke(i,this);else if(s instanceof W_)l=this.exec(s,i);else{if(!K(s))throw new TypeError("The "+s+" is not a function");l=s.apply(null,i)}this.vars.$last$=l,n[this.sp-1]=l}finally{this.disable_error=o}}},{key:"raise_error",value:function(t,e,n){var i=this.rules.find_rule(t,e);if(!i)return null;var r=i.trans_error_info(n,e,t);if(!r)return null;if(this.vars.$error_count=++this.error_count,this.vars.$check_result=this.check_result=r,this.disable_error)return null;throw new v_(r)}},{key:"lookup_bind",value:function(t,e){var n=t.sub_type||t.type;if(!e.is_bound())return t.restrain||this.raise_error(n,"unlabel",e),null;var i=e.get_bind(t.filter);return null==i?(t.restrain||this.raise_error(n,"errtype",e),null):G(i)?(this.raise_error(n,"multi",e),i[0]):i.visible?i.exist?i:(this.raise_error(n,"unexist",e),null):(this.raise_error(n,"invisible",e),null)}},{key:"to_symbol",value:function(t){return t instanceof d_?t:J(t)||Q(t)?this.intern_symbol(t):t}},{key:"try_to_symbol",value:function(t){return Ya(t)?t:J(t)||Q(t)?this.intern_symbol(t):null}},{key:"point",value:function(){for(var t={type:"point",filter:function(t){return t.as_type("point")}},e=null,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];for(var a=0;a<i.length;++a){var s=this.try_to_symbol(i[a]);if(null==s)throw new TypeError("point() need symbol/string/number params");e=this.lookup_bind(t,s)}return e}},{key:"get_point",value:function(t){if(t instanceof Qo)return t;if(!Wa(t))throw new SyntaxError(t+" can not refer to a Point");return this.point(t)}},{key:"with_points",value:function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=t.length,r=[],a=0;a<i;++a){var s=this.get_point(t[a]);if(!s)return n;r.push(s)}return e.apply(this,r)}},{key:"get_line_value",value:function(t){if(t instanceof il)return t;if(!Wa(t))throw new SyntaxError(t+" can not refer to a Line");return this.line(t)}},{key:"line",value:function(t,e){var n={type:"line",filter:function(t){return t.as_type("line")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("line",t,e);default:Va()}}},{key:"seg",value:function(t,e){var n={type:"line",sub_type:"seg",filter:function(t){return t.as_type("segment")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("seg",t,e);default:Va()}}},{key:"x_seg",value:function(t,e){var n=this;return n.with_points([t,e],function(t,e){function i(n){if("segment"!==n.sub_type)return!1;var i=n.p1,r=n.p2;return i===t&&r===e||i===e&&r===t||(l(i,t)<fs&&l(r,e)<fs||l(i,e)<fs&&l(r,t)<fs)}var r=n.pad.filter(i);return r&&r.length||n.raise_error("seg","unexist",is(t,e)),r[0]})}},{key:"ray",value:function(t,e){var n={type:"line",sub_type:"ray",filter:function(t){return t.as_type("ray")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("ray",t,e);default:Va()}}},{key:"sline",value:function(t,e){var n={type:"line",sub_type:"sline",filter:function(t){return t.as_type("sline")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("sline",t,e);default:Va()}}},{key:"paral",value:function(t,e){var n={type:"line",sub_type:"paral",filter:function(t){return t.as_type("paral")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("paral",t,e);default:Va()}}},{key:"perpl",value:function(t,e){var n={type:"line",sub_type:"perpl",filter:function(t){return t.as_type("perpl")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("perpl",t,e);default:Va()}}},{key:"bisl",value:function(t,e){var n={type:"line",sub_type:"bisl",filter:function(t){return t.as_type("bisl")}};switch(arguments.length){case 1:return this._line_l(n,t);case 2:return this._line_AB("bisl",t,e);default:Va()}}},{key:"_line_l",value:function(t,e){if(e&&"line"==e.type)return e;var n=this,i=n.try_to_symbol(e);if(!Ya(i))throw new TypeError("line() need symbol type param");return n.lookup_bind(t,i)}},{key:"_line_AB",value:function(t,e,n){var i=this;return i.with_points([e,n],function(e,n){if(e===n)return i.raise_error(t,"error",[e,n]),null;var r=i.pad,a=void 0;switch(t){case"line":a=jn(r,e,n);break;case"seg":a=On(r,e,n);break;case"ray":a=Pn(r,e,n);break;case"sline":a=$n(r,e,n);break;case"paral":a=An(r,e,n);break;case"perpl":a=Sn(r,e,n);break;case"bisl":a=Tn(r,e,n);break;default:throw new SyntaxError("Unknown line obj_type: "+t)}var s=is(e,n);return a&&a.length?a.length>1?"line"===t?Ga(a,e,n):(i.raise_error(t,"multi",s),a[0]):a[0].visible?a[0]:(i.raise_error(t,"invisible",s),a[0]):(i.raise_error(t,"unexist",s),null)})}},{key:"get_circ_value",value:function(t){if(t instanceof sl)return t;if(!Wa(t))throw new SyntaxError(t+" can not refer to a Circle");return this.circ(t)}},{key:"circ",value:function(t,e,n){switch(arguments.length){case 1:return this._circ_c(t);case 2:return this._circ_OA(t,e);case 3:return this._circ_ABC(t,e,n);default:Va()}}},{key:"_circ_c",value:function(t){var e=this.try_to_symbol(t);if(e){var n=this.lookup_bind(j_,e);if(n)return n}var i=this.get_point(e);if(!i)return this.raise_error("circle","unlabel",e),null;var r=En(this.pad,i);return this._chk_circ_ret(r,e)}},{key:"_circ_OA",value:function(t,e){var n=this;return n.with_points([t,e],function(t,e){var i=is(t,e);if(t==e)return n.raise_error("circle","error",i),null;var r=zn(n.pad,t,e);return n._chk_circ_ret(r,i)})}},{key:"_circ_ABC",value:function(t,e,n){var i=this;return i.with_points([t,e,n],function(t,e,n){var r=is(t,e,n);if(t===e||t===n||e===n)return i.raise_error("circle","error",r),null;var a=Cn(i.pad,t,e,n);return i._chk_circ_ret(a,r)})}},{key:"_chk_circ_ret",value:function(t,e){if(!t||!t.length)return this.raise_error("circle","unexist",e),null;var n=t[0];return t.length>1?(this.raise_error("circle","multi",e),n):n.visible?n:(this.raise_error("circle","invisible",e),n)}},{key:"angle_v",value:function(t,e,n){if(3!=arguments.length)throw new SyntaxError("Function angle_v() need 3 parameters");return this.with_points([t,e,n],function(t,e,n){return c(t,e,n)},0)}},{key:"angle",value:function(t,e,n){if(3!=arguments.length)throw new SyntaxError("Function angle() need 3 parameters");var i=this;return i.with_points([t,e,n],function(t,e,n){return i.line(e,t)&&i.line(e,n)},!1)}},{key:"bisln",value:function(t,e,n,i,r){var a=this;return a.with_points([t,e,n,i,r],function(s,o,l,u,_){var h=p(u,l,s,o),c=p(s,o,u,_);if(bs(h-c)<fs)return!0;var f=is(t,e),v=is(n,i,r);return a.raise_error("bisln","false",[f,v]),!1})}},{key:"with_lines",value:function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=t.length,r=[],a=0;a<i;++a){var s=this.get_line_value(t[a]);if(!s)return n;r.push(s)}return e.apply(this,r)}},{key:"coll",value:function(t,e,i){if(3!=arguments.length)throw new SyntaxError("Function coll() need 3 parameters");var r=this;return this.with_points([t,e,i],function(t,e,i){return!!n(t,e,i)||(r.raise_error("coll","false",[t,e,i]),!1)},!1)}},{key:"not_coll",value:function(t,e,i){if(3!=arguments.length)throw new SyntaxError("Function not_coll() need 3 parameters");var r=this;return this.with_points([t,e,i],function(t,e,i){return!n(t,e,i)||(r.raise_error("not_coll","false",[t,e,i]),!1)},!1)}},{key:"para",value:function(t,e,n,i){switch(arguments.length){case 2:return this._para_2(t,e);case 3:return this._para_3(t,e,n);case 4:return this._para_4(t,e,n,i)}throw new SyntaxError("Function para() need 2~4 parameters")}},{key:"_para_2",value:function(t,e){var n=this;return n.with_lines([t,e],function(i,a){return!!r(i.p1,i.p2,a.p1,a.p2)||(n.raise_error("para","false",[t,e]),!1)},!1)}},{key:"_para_3",value:function(t,e,n){var i=this;return i.with_points([t,e],function(a,s){return i.with_lines([n],function(o){if(!r(a,s,o.p1,o.p2)){var l=is(t,e);return i.raise_error("para","false",[l,n]),!1}return!0},!1)},!1)}},{key:"_para_4",value:function(t,e,n,i){var a=this;return a.with_points([t,e,n,i],function(s,o,l,u){if(!r(s,o,l,u)){var _=is(t,e),h=is(n,i);return a.raise_error("para","false",[_,h]),!1}return!0},!1)}},{key:"perp",value:function(t,e,n,i){switch(arguments.length){case 2:return this._perp_2(t,e);case 3:return this._perp_3(t,e,n);case 4:return this._perp_4(t,e,n,i)}throw new SyntaxError("Function perp() need 2~4 parameters")}},{key:"_perp_2",value:function(t,e){var n=this;return this.with_lines([t,e],function(t,e){return!!a(t.p1,t.p2,e.p1,e.p2)||(n.raise_error("perp","false",[t,e]),!1)},!1)}},{key:"_perp_3",value:function(t,e,n){var i=this;return i.with_points([t,e],function(t,e){return i.with_lines([n],function(r){if(!a(t,e,r.p1,r.p2)){var s=is(t,e);return i.raise_error("perp","false",[s,n]),!1}return!0},!1)},!1)}},{key:"_perp_4",value:function(t,e,n,i){var r=this;return r.with_points([t,e,n,i],function(t,e,n,i){if(!a(t,e,n,i)){var s=is(t,e),o=is(n,i);return r.raise_error("perp","false",[s,o]),!1}return!0},!1)}},{key:"intpt_ll",value:function(t,e,n,i,r){switch(arguments.length){case 3:return this._intpt_ll_3(t,e,n);case 5:return this._intpt_ll_5(t,e,n,i,r)}throw new SyntaxError("Function intpt_ll() need 3 or 5 parameters")}},{key:"_intpt_ll_3",value:function(t,e,i){var r=this;return r.with_points([t],function(t){return r.with_lines([e,i],function(e,i){var a=e.p1,s=e.p2,o=i.p1,l=i.p2;return!(!n(t,a,s)||!n(t,o,l))||(r.raise_error("intpt_ll","false",[t,e,i]),!1)},!1)},!1)}},{key:"_intpt_ll_5",value:function(t,e,i,r,a){var s=this;return s.with_points([t,e,i,r,a],function(t,e,i,r,a){if(!n(t,e,i)||!n(t,r,a)){var o=is(e,i),l=is(r,a);return s.raise_error("intpt_ll","false",[t,o,l]),!1}return!0},!1)}},{key:"midpt",value:function(t,e,n){if(3!=arguments.length)throw new SyntaxError("Function midpt() need 3 parameters");var r=this;return r.with_points([t,e,n],function(t,e,n){return!!i(t,e,n)||(r.raise_error("midpt","false",[t,e,n]),!1)},!1)}},{key:"cycl",value:function(t,e,n,i){if(4!=arguments.length)throw new SyntaxError("Function cycl() need 4 parameters");var r=this;return r.with_points([t,e,n,i],function(t,e,n,i){var a=d(t,e,n);if(a){var s=l(a,i),o=l(a,t)+l(a,e)+l(a,n);if(bs(s-o/3)<fs)return!0}return r.raise_error("cycl","false",[t,e,n,i]),!1},!1)}},{key:"eqdist",value:function(t,e,n,i){if(4!=arguments.length)throw new SyntaxError("Function eqdist() need 4 parameters");var r=this;return r.with_points([t,e,n,i],function(t,e,n,i){var a=l(t,e),s=l(n,i);if(bs(a-s)<fs)return!0;var o=is(t,e),u=is(n,i);return r.raise_error("eqdist","false",[o,u]),!1},!1)}},{key:"eqang",value:function(t,e,n,i,r,a){if(6!=arguments.length)throw new SyntaxError("Function eqang() need 6 parameters");var s=this;return s.with_points([t,e,n,i,r,a],function(t,e,n,i,r,a){var o=c(t,e,n),l=c(i,r,a);if(bs(o-l)<fs)return!0;var u=is(t,e,n),_=is(i,r,a);return s.raise_error("eqang","false",[u,_]),!1},!1)}},{key:"con_tri",value:function(t,e,n,i,r,a){if(6!=arguments.length)throw new SyntaxError("Function con_tri() need 6 parameters");var s=this;return s.with_points([t,e,n,i,r,a],function(t,e,n,i,r,a){var o=l(t,e),u=l(i,r),_=l(e,n),h=l(r,a),c=l(n,t),p=l(a,i);if(bs(o-u)<fs&&bs(_-h)<fs&&bs(c-p)<fs)return!0;var f=is(t,e,n),v=is(i,r,a);return s.raise_error("con_tri","false",[f,v]),!1},!1)}},{key:"sim_tri",value:function(t,e,n,i,r,a){if(6!=arguments.length)throw new SyntaxError("Function sim_tri() need 6 parameters");var s=this;return s.with_points([t,e,n,i,r,a],function(t,e,n,i,r,a){var o=l(t,e),u=l(i,r),_=o/u,h=l(e,n),c=l(r,a),p=h/c,f=l(n,t),v=l(a,i),d=f/v,y=(_+p+d)/3;if(bs(y-_)<fs&&bs(y-p)<fs&&bs(y-d)<fs)return!0;var g=is(t,e,n),b=is(i,r,a);return s.raise_error("sim_tri","false",[g,b]),!1},!1)}},{key:"equ_tri",value:function(t,e,n){if(3!=arguments.length)throw new SyntaxError("Function equ_tri() need 3 parameters");var i=this;return i.with_points([t,e,n],function(t,e,n){var r=l(t,e),a=l(e,n),s=l(n,t),o=(r+a+s)/3;if(bs(o-r)<fs&&bs(o-a)<fs&&bs(o-s)<fs)return!0;var u=is(t,e,n);return i.raise_error("equ_tri","false",u),!1},!1)}},{key:"ang_is",value:function(t,e,n,i){if(4!=arguments.length)throw new SyntaxError("Function ang_is() need 4 parameters");var r=this;return r.with_points([t,e,n],function(t,e,n){var a=c(t,e,n);if(bs(a-i/180*vs)<fs)return!0;var s=is(t,e,n);return r.raise_error("ang_is","false",[s,i]),!1},!1)}},{key:"tri",value:function(t,e,i,r){if(arguments.length<3)throw new SyntaxError("Function tri() need 3~4 parameters");var a=this;return a.with_points([t,e,i],function(t,e,i){if(n(t,e,i))return a.raise_error("tri","false",[t,e,i]),!1;if(Ja(r,"seg")){if(!a.seg(t,e)||!a.seg(e,i)||!a.seg(i,t))return!1}else if(Ja(r,"line")&&(!a.line(t,e)||!a.line(e,i)||!a.line(i,t)))return!1;return!0},!1)}},{key:"_chk_tri_and_calc_angle",value:function(t,e,n,i){return this.tri(t,e,n,i)?[c(e,t,n),c(t,e,n),c(t,n,e)]:null}},{key:"acute_tri",value:function(t,e,n,i){var r=this;return r.with_points([t,e,n],function(t,e,n){var a=r._chk_tri_and_calc_angle(t,e,n,i);if(!a)return!1;var s=a[0],o=a[1],l=a[2],u=vs/2+fs;return s<=u&&o<=u&&l<=u||(r.raise_error("acute_tri","false",[t,e,n]),!1)},!1)}},{key:"right_tri",value:function(t,e,n,i){var r=this;return r.with_points([t,e,n],function(t,e,n){var a=r._chk_tri_and_calc_angle(t,e,n,i);if(!a)return!1;var s=a[0];return bs(s-vs/2)<fs||(r.raise_error("right_tri","false",[t,e,n]),!1)},!1)}},{key:"obtuse_tri",value:function(t,e,n,i){var r=this;return r.with_points([t,e,n],function(t,e,n){var a=r._chk_tri_and_calc_angle(t,e,n,i);if(!a)return!1;var s=a[0],o=a[1],l=a[2],u=vs/2+fs;return s>=u||o>=u||l>=u||(r.raise_error("obtuse_tri","false",[t,e,n]),!1)},!1)}},{key:"amark",value:function(t,e,n){switch(arguments.length){case 1:return this._amark_1(t);case 3:return this._amark_3(t,e,n)}throw new SyntaxError("Function amark() need 1 or 3 parameters")}},{key:"_amark_1",value:function(t){if(t instanceof Ml)return t;var e=this.to_symbol(t);if(!Ya(e))throw new SyntaxError("amark(n) need a name parameter");var n={type:"amark",filter:function(t){return t.is_type("amark")}};return this.lookup_bind(n,e)}},{key:"_amark_3",value:function(t,e,n){var i=this;return i.with_points([t,e,n],function(t,e,n){function r(i){return i instanceof Ml&&i.approx_angle_mark(t,e,n)}var a=i.pad.filter(r);return a&&a.length?a.length>1?(i.raise_error("amark","multi",[t,e,n]),a[0]):a[0]:(i.raise_error("amark","unexist",[t,e,n]),null)},null)}},{key:"lmark",value:function(t,e){if(2!=arguments.length)throw new SyntaxError("Function lmark() need 2 parameters");var n=this;return n.with_points([t,e],function(t,e){function i(n){return n instanceof lu&&n.between_pt2(t,e)}var r=n.pad.filter(i);return r&&r.length?r[0]:(n.raise_error("lmark","unexist",[t,e]),null)},null)}},{key:"mk_ss",value:function(t,e){return!(!t||!e||"mark"!=t.type||"mark"!=e.type)&&(t.style===e.style||(this.raise_error("mk_ss","false",[t,e]),!1))}},{key:"ratio",value:function(t,e,n,i,r,a,s,o){if(8!=arguments.length)throw new SyntaxError("Function ratio() need 8 parameters");var u=this;return u.with_points([t,e,n,i,r,a,s,o],function(_,h,c,p,f,v,d,y){var g=l(_,h),b=l(c,p),m=l(f,v),x=l(d,y);if(bs(g*x-b*m)<fs)return!0;var k=is(t,e),w=is(n,i),j=is(r,a),O=is(s,o);return u.raise_error("ratio","false",[k,w,j,O]),!1},!1)}},{key:"ratio_2",value:function(t,e,n,i,r,a){if(6!=arguments.length)throw new SyntaxError("Function ratio_2() need 6 parameters");var s=this;return s.with_points([t,e,n,i],function(o,u,_,h){var c=l(o,u),p=l(_,h);if(bs(c*a-p*r)<fs)return!0;var f=is(t,e),v=is(n,i);return s.raise_error("ratio_2","false",[f,v,r,a]),!1},!1)}},{key:"is_square",value:function(t,e,n,i,r){function a(t,e,n,i){var r=l(t,e),a=l(e,n),s=l(n,i),o=l(i,t);return!!(Qa(r,a)&&Qa(a,s)&&Qa(s,o)&&Qa(o,r))&&!!Za(t,e,n,i)}return this._quad_helper(a,"is_square",t,e,n,i,r)}},{key:"is_rect",value:function(t,e,n,i,r){function a(t,e,n,i){var r=l(t,e),a=l(e,n),s=l(n,i),o=l(i,t);return!(!Qa(r,s)||!Qa(a,o))&&!!Za(t,e,n,i)}return this._quad_helper(a,"is_rect",t,e,n,i,r)}},{key:"is_diam",value:function(t,e,n,i,r){function a(t,e,n,i){var r=l(t,e),a=l(e,n),s=l(n,i),o=l(i,t);return!!(Qa(r,a)&&Qa(a,s)&&Qa(s,o)&&Qa(o,r))&&(!!ts(e,t,i,i,n,e)&&!!ts(t,i,n,n,e,t))}return this._quad_helper(a,"is_diam",t,e,n,i,r)}},{key:"is_paralg",value:function(t,e,n,i,r){function a(t,e,n,i){var r=l(t,e),a=l(e,n),s=l(n,i),o=l(i,t);return!(!Qa(r,s)||!Qa(a,o))&&(!!ts(e,t,i,i,n,e)&&!!ts(t,i,n,n,e,t))}return this._quad_helper(a,"is_paralg",t,e,n,i,r)}},{key:"is_trapz",value:function(t,e,n,i,a){function s(t,e,n,i){return!!r(t,e,n,i)&&!r(t,i,e,n)}return this._quad_helper(s,"is_trapz",t,e,n,i,a)}},{key:"quad",value:function(t,e,i,r,a){function s(t,e,i,r){return!(n(t,e,i)||n(e,i,r)||n(i,r,t)||n(r,t,e))}return this._quad_helper(s,"quad",t,e,i,r,a)}},{key:"_quad_helper",value:function(t,e,n,i,r,a,s){var o=this;return o.with_points([n,i,r,a],function(n,i,r,a){if(!t(n,i,r,a))return o.raise_error(e,"false",[n,i,r,a]),!1;if(Ja(s,"seg")){if(!(o.seg(n,i)&&o.seg(i,r)&&o.seg(r,a)&&o.seg(a,n)))return!1}else if(Ja(s,"line")&&!(o.line(n,i)&&o.line(i,r)&&o.line(r,a)&&o.line(a,n)))return!1;return!0},!1)}},{key:"intpt",value:function(t){var e=this.get_point(t);return!!e&&(e&&"intpt"==e.sub_type?e:(this.raise_error("intpt","false",e),!1))}},{key:"vpoint",value:function(t,e,n){var i=es(t),r=es(e),a=new ul(i,r);return a.label.text=a.name=ns(n)||"",a}},{key:"vline",value:function(t,e,n){return this.with_points([t,e],function(t,e){var i=new bl(t,e);return i.obj_id=0,i.is_virtual=!0,i.set_label(ns(n)||""),i})}},{key:"vseg",value:function(t,e,n){return this.with_points([t,e],function(t,e){var i=new pl(t,e);return i.obj_id=0,i.is_virtual=!0,i.label.text=i.name=ns(n)||"",i})}},{key:"judge",value:function(t){return!!t||(this.raise_error("judge","false",null),!1)}},{key:"dist",value:function(t,e){return this.with_points([t,e],function(t,e){return l(t,e)},0)}},{key:"at_ray",value:function(t,e,n){var i=this;return this.with_points([t,e,n],function(t,e,n){var r=new bl(e,n),a=o(t.x,t.y,r);return!!a&&(!(bs(a.d)>fs||a.t<-fs)||(i.raise_error("at_ray","false",[t,e,n]),!1))},!1)}},{key:"at_seg",value:function(t,e,n){var i=this;return this.with_points([t,e,n],function(t,e,n){var r=new bl(e,n),a=o(t.x,t.y,r);return!!a&&(!(bs(a.d)>fs||a.t<-fs||a.t>1+fs)||(i.raise_error("at_seg","false",[t,e,n]),!1))},!1)}},{key:"at_line",value:function(t,e){var i=this;return this.with_points([t],function(t){return i.with_lines([e],function(e){return n(t,e.p1,e.p2)},!1)},!1)}},{key:"pt_at",value:function(t,e){var n=es(t),i=es(e),r=null,a=Number.MAX_VALUE;return this.pad.each(function(t){if(t instanceof Qo){var e=n-t.x,s=i-t.y,o=ms(e*e+s*s);if(o>fs)return;o<a&&(r=t,a=o)}}),r}},{key:"is_refl",value:function(t,e,n){var i=this;return i.with_points([t,e],function(t,e){return i.with_lines([n],function(n){var r=m(t.x,t.y,n);return!!(r&&bs(r.x-e.x)<fs&&bs(r.y-e.y)<fs)||(i.raise_error("is_refl","false",[t,e,n]),!1)},!1)},!1)}},{key:"ln_intp",value:function(t,e){var n=this;return n.with_lines([t,e],function(t,e){var i=Et(t,e);return i&&i.length?n.vpoint(i[0].x,i[0].y):null},null)}},{key:"_intp_ret_which",value:function(t,e){if(!t||!t.length)return null;var n=es(e);if(1==n)return this.vpoint(t[0].x,t[0].y);if(2==n)return t.length<2?null:this.vpoint(t[1].x,t[1].y);var i={count:t.length,length:t.length};return t.length>=1&&(i.p1=i[0]=this.vpoint(t[0].x,t[0].y)),t.length>=2&&(i.p2=i[1]=this.vpoint(t[1].x,t[1].y)),i}},{key:"cc_intp",value:function(t,e,n){var i=this.get_circ_value(t),r=this.get_circ_value(e);if(!i||!r)return null;var a=Ct(i,r);return this._intp_ret_which(a,n)}},{key:"lc_intp",value:function(t,e,n){var i=this.get_line_value(t),r=this.get_circ_value(e);if(!i||!r)return null;var a=zt(i,r);return this._intp_ret_which(a,n)}},{key:"cr_rel",value:function(t,e){var n=this.get_circ_value(t),i=this.get_circ_value(e);if(!n||!i)return 0;var r=n.get_radius(),a=i.get_radius(),s=r+a,o=bs(r-a),u=l(n.center(),i.center());return u>=s+fs?1:bs(u-s)<fs?2:bs(u-o)<fs?4:u<o?r<a?5:6:3}},{key:"cr_devi",value:function(t,e){return 1==this.cr_rel(t,e)||(this.raise_error("cr_devi","false",[t,e]),!1)}},{key:"cr_xtang",value:function(t,e){return 2==this.cr_rel(t,e)||(this.raise_error("cr_xtang","false",[t,e]),!1)}},{key:"cr_itang",value:function(t,e){return 4==this.cr_rel(t,e)||(this.raise_error("cr_itang","false",[t,e]),!1)}},{key:"cr_intp",value:function(t,e){return 3===this.cr_rel(t,e)||(this.raise_error("cr_intp","false",[t,e]),!1)}},{key:"cr_inc",value:function(t,e){return 5==this.cr_rel(t,e)||(this.raise_error("cr_inc","false",[t,e]),!1)}},{key:"xpoly",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];var r=ns(t).split(","),a=arguments.length-1;if(a<4)throw new SyntaxError("Function xpoly() need at least 4 points");for(var s=[],o=0;o<a;++o)s[o]=this.get_point(arguments[o+1]);for(var l=new Il(s),u=0;u<r.length;++u){var _=r[u].trim();switch(_){case"line":case"seg":if(!this._chk_poly_edge(l,_))return!1;break;case"convex":if(!l.is_convex_polygon())return this.raise_error("xpoly","false",l),!1}}return!0}},{key:"_chk_poly_edge",value:function(t,e){for(var n=t.vertexs,i=n.length,r=0;r<i;++r){var a=n[r],s=r+1==i?n[0]:n[r+1];if("line"==e){if(!this.line(a,s))return!1}else if(!this.seg(a,s))return!1}return!0}},{key:"vpoly",value:function(t,e,n){for(var i=arguments.length,r=Array(i>3?i-3:0),a=3;a<i;a++)r[a-3]=arguments[a];var s=arguments.length;if(s<3)throw new SyntaxError("Function xpoly() need at least 3 points");for(var o=[],l=!1,u=0;u<s;++u)o[u]=this.get_point(arguments[u]),null==o[u]&&(l=!0);if(l)return null;var _=new Il(o);return _.is_virtual=!0,_}},{key:"in_poly",value:function(t,e){var n=this.get_point(t);return!!n&&(!!(e&&e instanceof Il)&&e.hit_test(n.x,n.y))}},{key:"refl_pt",value:function(t,e){var n=this.get_point(t),i=this.get_line_value(e);if(!n||!i)return null;var r=m(n.x,n.y,i);return this.vpoint(r.x,r.y)}},{key:"sm_side",value:function(t,e,n){var i=this;return i.with_points([t,e],function(t,e){return i.with_lines([n],function(n){var i=n.p1,r=n.p2,a=i.x,s=i.y,o=r.x,l=r.y,u=l-s,_=a-o,h=o*s-a*l,c=u*t.x+_*t.y+h,p=u*e.x+_*e.y+h;return bs(c)<fs||bs(p)<fs?0:c*p>0?1:-1},0)},0)}},{key:"foot",value:function(t,e,n){return this.with_lines([n],function(n){var i=o(t,e,n);return i?this.vpoint(i.x,i.y):null},null)}},{key:"tri_centroid",value:function(t,e,n){var i=this;return i.with_points([t,e,n],function(t,e,n){var r=(t.x+e.x+n.x)/3,a=(t.y+e.y+n.y)/3;return i.vpoint(r,a)})}},{key:"tri_orthocentre",value:function(t,e,n){return this.with_points([t,e,n],function(t,e,n){var i=y(t,e,n);return this.vpoint(i.x,i.y)})}},{key:"tri_circumcentre",value:function(t,e,n){return this.with_points([t,e,n],function(t,e,n){var i=d(t,e,n);return i?this.vpoint(i.x,i.y):null})}},{key:"tri_incentre",value:function(t,e,n){return this.with_points([t,e,n],function(t,e,n){var i=g(t,e,n);return i?this.vpoint(i.x,i.y):null})}},{key:"ln_xk",value:function(t){return this.with_lines([t],function(t){var e=t.p1,n=t.p2,i=e.x,r=e.y,a=n.x,s=n.y,o=a-i,l=s-r,u=180*Math.atan2(l,o)/Math.PI;return u>=0&&u<=90?u:u>90&&u<=180?180-u:u<0&&u>=-90?-u:180+u},0)}},{key:"same_pt",value:function(t,e){return t===e||this.with_points([t,e],function(t,e){if(t===e)return!0;var n=bs(t.x-e.x),i=bs(t.y-e.y);return n<fs&&i<fs},!1)}},{key:"ang_r2",value:function(t,e){var i=this.amark(t),r=this.amark(e);if(!i||!r)return-1;var a=i.pO,o=i.pA,l=i.pB,u=r.pO,_=r.pA,h=r.pB;if(!this.same_pt(a,u))return-2;if(n(o,a,_)&&n(l,a,h));else{if(!n(o,a,h)||!n(l,a,_))return-3;var c=_;_=h,h=c}var p=s(a,o,a,_),f=s(a,l,a,h);return p?f?1:2:f?2:3}},{key:"ang_rel",value:function(t,e,i,r,a){var o=this;return this.with_lines([t,e,i],function(t,e,i){var l=o.amark(r),u=o.amark(a);if(!l||!u)return-1;var _=l.pO,h=l.pA,c=l.pB;if(n(t.p1,t.p2,h)){if(!n(i.p1,i.p2,c))return-2}else{if(!n(i.p1,i.p2,h))return-2;if(!n(t.p1,t.p2,c))return-2;var p=h;h=c,c=p}var f=u.pO,v=u.pA,d=u.pB;if(n(e.p1,e.p2,v)){if(!n(i.p1,i.p2,d))return-2}else{if(!n(i.p1,i.p2,v))return-2;if(!n(e.p1,e.p2,d))return-2;var y=v;v=d,d=y}var g=s(_,c,_,f),b=s(f,d,f,_),m=i.p1,x=i.p2,k=x.y-m.y,w=m.x-x.x,j=x.x*m.y-m.x*x.y,O=k*h.x+w*h.y+j,P=k*v.x+w*v.y+j,$=O*P>=0;return g?b?$?1:2:$?3:4:b?$?3:4:$?5:6},-1)}},{
key:"is_sel",value:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var i=0;i<arguments.length;++i){var r=arguments[i];if(Wa(r)&&(r=this.to_symbol(r)),r instanceof d_){if(!r.is_bound())return this.raise_error("object","unlabel",r),!1;var a=r.get_bind();if(G(a)&&(a=a[0]),!a.selected)return this.raise_error("object","false",r),!1}else{if(!(r instanceof Xo))throw new SyntaxError("Parameter of function is_sel() is invalid");if(!r.selected)return this.raise_error("object","false",r),!1}}return!0}},{key:"sel_tool",value:function(t){var e=ns(t),n=this.pad._mouse_tool;if(!n)return!1;var i=n.name;return i===e||("any_line"==e&&("segment"==i||"ray"==i||"line"==i)||(this.raise_error("object","false",e),!1))}},{key:"obj_num",value:function(t){t=ns(t);var e=0;return this.pad.each(function(n){null!=t&&""!=t&&n.type!=t&&n.sub_type!=t||e++}),e}}]),t}(),j_={type:"circle",filter:function(t){return t.as_type("circle")},restrain:!0},O_={"+":"+","-":"-","!":"!","@":"@"},P_={"+":{op:"add",l:12},"-":{op:"sub",l:12},"*":{op:"mult",l:13},"/":{op:"div",l:13},"%":{op:"mod",l:13},"!=":{op:"neq",l:9},"==":{op:"eq",l:9},"~=":{op:"aeq",l:9},"<":{op:"lt",l:10},"<=":{op:"le",l:10},">":{op:"gt",l:10},">=":{op:"ge",l:10},"&":{op:"&",l:5},"|":{op:"|",l:6},and:{op:"&",l:5},or:{op:"|",l:6},"=":{op:"=",l:2,r:1}},$_=function(){function t(e,n){ss(this,t),this.pad=e,this.str=n}return os(t,[{key:"parse",value:function(){return this.lex=new f_(this.str),this.module=this.func=new Y_,this.top_level(),this.module}},{key:"compile",value:function(t){var e=new A_(t);t.gen_code(e);var n=e.get_code(),i=new H_(t.name,[],[],n);return new W_(i,[])}},{key:"exec",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=new w_;try{return n.bind_pad(this.pad),n.exec(t,e)}catch(t){if(t instanceof v_)return t.message;throw t}}},{key:"syntax_error",value:function(t){throw new SyntaxError(t+" At line: "+this.lex.line+", col: "+this.lex.col)}},{key:"next_token",value:function(){return this.tok=this.lex.next_tok(),this.lvalue=this.lex.lvalue,this.tok}},{key:"top_level",value:function(){var t=this.module.body.stats;for(this.next_token();-1!==this.tok;){var e=this.stat();e&&t.push(e)}}},{key:"stat",value:function(){if(";"===this.tok)return this.next_token(),new M_;if("{"===this.tok)return this.block_stat();if(this.tok===c_){if("if"===this.lvalue)return this.if_stat();if("while"===this.lvalue)return this.while_stat();if("return"===this.lvalue)return this.return_stat();if("defun"===this.lvalue)return this.defun_stat();if("var"===this.lvalue)return this.var_stat()}return this.expr_stat()}},{key:"stat_list",value:function(){for(var t=new R_;"}"!==this.tok;){var e=this.stat();t.stats.push(e)}return t}},{key:"block_stat",value:function(){this.expect_char("{");var t=this.stat_list();return this.expect_char("}"),t}},{key:"if_stat",value:function(){this.next_token(),this.expect_char("(");var t=this.expr();this.expect_char(")");var e=this.stat(),n=null;return this.tok===c_&&"else"===this.lvalue&&(this.next_token(),n=this.stat()),new F_(t,e,n)}},{key:"while_stat",value:function(){this.next_token(),this.expect_char("(");var t=this.expr();this.expect_char(")");var e=this.stat();return new D_(t,e)}},{key:"return_stat",value:function(){this.next_token();var t=this.expr();return new L_(t)}},{key:"defun_stat",value:function(){var t=this.func,e=this.func=new X_(null,[],[],null);this.func.parent=t;try{this.next_token(),this.tok!==c_&&this.syntax_error("Defun name is expected"),e.name=this.lvalue,this.next_token(),this.expect_char("(");var n=this.read_plist();return e.plist=function(t){for(var e=[],n=0;n<t.length;++n){var i={index:n,name:t[n]};e.push(i)}return e}(n),this.expect_char(")"),this.expect_char("{"),e.body=this.stat_list(),this.expect_char("}"),e}finally{this.func=t}}},{key:"read_plist",value:function(){var t=[];if(this.tok!==c_)return t;for(t.push(this.lvalue),this.next_token();","===this.tok;)this.next_token(),this.tok!==c_&&this.syntax_error("Symbol is expected when parse param-list"),t.push(this.lvalue),this.next_token();return t}},{key:"var_stat",value:function(){this.next_token(),this.tok!==c_&&this.syntax_error("Var name is expected");var t=this.lvalue;this.next_token();var e=this.func.fadd_lvar(t),n=null;return"="===this.tok&&(this.next_token(),n=this.expr()),this.expect_char(";"),new U_(e,n)}},{key:"expr_stat",value:function(){var t=this.expr(),e=this.cond_clause(!0);return this.expect_char(";"),new q_(t,e)}},{key:"expr",value:function(){return this.sub_expr(-1)}},{key:"cond_clause",value:function(t){for(var e=null;this.tok===c_&&La(this.lvalue);){var n=this.lvalue;this.next_token();var i=void 0;259===this.tok?(i=this.lvalue,this.next_token()):this.syntax_error("Handler string expected."),null===e&&(e={}),e[n]=i}return e}},{key:"sub_expr",value:function(t){var e=rs(this.tok),n=void 0;if(e){this.next_token();var i=this.sub_expr(20);n=this.cr_un_node(e,i)}else n=this.simple_expr();for(var r=as(this.tok,this.lvalue);r&&r.l>t;){this.next_token();var a=this.sub_expr(r.r||r.l);n=this.cr_bin_node(r.op,n,a),r=as(this.tok,this.lvalue)}return n}},{key:"cr_un_node",value:function(t,e){return"@"===t&&(e instanceof B_||this.syntax_error("@ operator must preceed a function call.")),new N_(t,e)}},{key:"cr_bin_node",value:function(t,e,n){return"="===t?new I_(e,n):"|"===t||"&"===t?new z_(t,e,n):new E_(t,e,n)}},{key:"simple_expr",value:function(){if(258===this.tok||259===this.tok){var t=new S_(this.lvalue);return this.next_token(),t}if("("===this.tok){this.next_token();var e=this.expr();return this.expect_char(")"),e}if(this.tok===c_)return this.var_or_func();this.syntax_error("Invalid token: "+this.tok)}},{key:"var_or_func",value:function(){var t=this.lvalue;this.next_token();for(var e=new T_(t);;)if("."===this.tok){this.next_token();var n=this.expect_name();e=new C_(e,n)}else{if("("!==this.tok)break;var i=this.func_args();e=new B_(e,i)}return e}},{key:"func_args",value:function(){if(this.next_token(),")"===this.tok)return this.next_token(),[];var t=this.expr_list1();return this.expect_char(")"),t}},{key:"expr_list1",value:function(){var t=[];for(t.push(this.expr());","===this.tok;)this.next_token(),t.push(this.expr());return t}},{key:"expect_char",value:function(t){if(this.tok===t)return void this.next_token();this.syntax_error("Token '"+t+"' expected.")}},{key:"expect_name",value:function(){if(this.tok===c_){var t=this.lvalue;return this.next_token(),t}this.syntax_error("A name is expected.")}}]),t}(),A_=function(){function t(e){ss(this,t),this.def=e,this.code=[]}return os(t,[{key:"get_code",value:function(){return this.code}},{key:"emit_code0",value:function(t){var e=this.code.length;return this.code.push(t),e}},{key:"emit_code1",value:function(t,e){var n=this.code.length;return this.code.push(t,e),n}},{key:"code_addr",value:function(){return this.code.length}},{key:"set_jmp_addr",value:function(t,e){this.code[t+1]=e-t-2}}]),t}(),S_=function(){function t(e){ss(this,t),this.cst=e}return os(t,[{key:"toString",value:function(){return String(this.cst)}},{key:"gen_code",value:function(t){t.emit_code1("push_const",this.cst)}}]),t}(),T_=function(){function t(e){ss(this,t),this.name=e}return os(t,[{key:"gen_code",value:function(t){var e=t.def,n=e.fd_parm(this.name);if(n)return void t.emit_code1("get_arg",n.index);var i=e.fd_lvar(this.name);if(i)return void t.emit_code1("get_local",i.index);t.emit_code1("get_global",this.name)}}]),t}(),E_=function(){function t(e,n,i){ss(this,t),this.oper=e,this.l=n,this.r=i}return os(t,[{key:"toString",value:function(){return"("+this.oper+" "+this.l+" "+this.r+")"}},{key:"gen_code",value:function(t){this.l.gen_code(t),this.r.gen_code(t),t.emit_code0(this.oper)}}]),t}(),z_=function(){function t(e,n,i){ss(this,t),this.op=e,this.l=n,this.r=i}return os(t,[{key:"toString",value:function(){return"("+this.op+" "+this.l+" "+this.r+")"}},{key:"gen_code",value:function(t){"|"===this.op?this._or(t):this._and(t)}},{key:"_or",value:function(t){this.l.gen_code(t);var e=t.emit_code1("jmp_true",0);t.emit_code0(o_),this.r.gen_code(t);var n=t.code_addr();t.set_jmp_addr(e,n)}},{key:"_and",value:function(t){this.l.gen_code(t);var e=t.emit_code1("jmp_false",0);t.emit_code0(o_),this.r.gen_code(t);var n=t.code_addr();t.set_jmp_addr(e,n)}}]),t}(),C_=function(){function t(e,n){ss(this,t),this.l=e,this.r=n}return os(t,[{key:"toString",value:function(){return this.l+"."+this.r}},{key:"gen_code",value:function(t){this.l.gen_code(t),t.emit_code1("get_field",this.r)}}]),t}(),I_=function(){function t(e,n){ss(this,t),this.l=e,this.r=n}return os(t,[{key:"gen_code",value:function(t){this.r.gen_code(t);var e=t.def,n=e.fd_parm(this.l.name);if(n)return void t.emit_code1("set_arg",n.index);var i=e.fd_lvar(this.l.name);if(i)return void t.emit_code1("set_local",i.index);t.emit_code1("set_global",this.l.name)}}]),t}(),B_=function(){function t(e,n){ss(this,t),this.f=e,this.args=n}return os(t,[{key:"gen_code",value:function(t){this._invoke(t,"invoke")}},{key:"at_invoke",value:function(t){this._invoke(t,"at_invoke")}},{key:"_invoke",value:function(t,e){this.f.gen_code(t);for(var n=this.args,i=n.length,r=0;r<i;++r)n[r].gen_code(t);t.emit_code1(e,i)}}]),t}(),N_=function(){function t(e,n){ss(this,t),this.oper="u_"+e,this.r=n}return os(t,[{key:"toString",value:function(){return"("+this.oper+" "+this.r+")"}},{key:"gen_code",value:function(t){"u_@"===this.oper?this.r.at_invoke(t):(this.r.gen_code(t),t.emit_code0(this.oper))}}]),t}(),M_=function(){function t(){ss(this,t)}return os(t,[{key:"gen_code",value:function(){}}]),t}(),q_=function(){function t(e,n){ss(this,t),this.expr=e,this.conds=n}return os(t,[{key:"gen_code",value:function(t){if(this.conds){var e=new __("object",this.conds);t.emit_code1("chain_rule",e)}this.expr.gen_code(t),t.emit_code0(o_),this.conds&&t.emit_code0("unchain_rule")}}]),t}(),R_=function(){function t(){ss(this,t),this.stats=[]}return os(t,[{key:"gen_code",value:function(t){for(var e=0;e<this.stats.length;++e)this.stats[e].gen_code(t)}}]),t}(),F_=function(){function t(e,n,i){ss(this,t),this.test=e,this.cons=n,this.alt=i}return os(t,[{key:"gen_code",value:function(t){this.test.gen_code(t);var e=t.emit_code1("jmp_false",0);t.emit_code0(o_),this.cons.gen_code(t);var n=t.emit_code1("jmp",0),i=t.code_addr();t.set_jmp_addr(e,i),t.emit_code0(o_),this.alt&&this.alt.gen_code(t);var r=t.code_addr();t.set_jmp_addr(n,r)}}]),t}(),D_=function(){function t(e,n){ss(this,t),this.test=e,this.body=n}return os(t,[{key:"gen_code",value:function(t){var e=t.code_addr();this.test.gen_code(t);var n=t.emit_code1("jmp_false",0);t.emit_code0(o_),this.body.gen_code(t),t.emit_code1("jmp",e-t.code_addr()-2);var i=t.code_addr();t.emit_code0(o_),t.set_jmp_addr(n,i)}}]),t}(),L_=function(){function t(e){ss(this,t),this.expr=e}return os(t,[{key:"gen_code",value:function(t){this.expr.gen_code(t),t.emit_code0("return")}}]),t}(),X_=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];ss(this,t),this.name=e,this.plist=n,this.lvar=i,this.body=r,this.is_main=a}return os(t,[{key:"gen_code",value:function(t){var e=new A_(this);this.body.gen_code(e),e.emit_code0("halt");var n=e.get_code(),i=new H_(this.name,this.plist,[],n),r=new W_(i,[]);t.emit_code1("push_const",r),t.emit_code1("set_global",this.name),t.emit_code0(o_)}},{key:"fd_lvar",value:function(t){for(var e=this.lvar,n=e.length,i=0;i<n;++i)if(e[i].name===t)return e[i];return null}},{key:"fadd_lvar",value:function(t){var e=this.fd_lvar(t);return e||(e={index:this.lvar.length,name:t},this.lvar.push(e)),e}},{key:"fd_parm",value:function(t){var e=(this.plist,!0),n=!1,i=void 0;try{for(var r,a=this.plist[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var s=r.value;if(s.name===t)return s}}catch(t){n=!0,i=t}finally{try{!e&&a.return&&a.return()}finally{if(n)throw i}}return null}}]),t}(),Y_=function(t){function e(){return ss(this,e),_s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"__main__",[],[],new R_,!0))}return us(e,t),os(e,[{key:"gen_code",value:function(t){this.body.gen_code(t),t.emit_code0("halt")}}]),e}(X_),U_=function(){function t(e,n){ss(this,t),this.vd=e,this.init=n}return os(t,[{key:"gen_code",value:function(t){}}]),t}(),H_=function t(e,n,i,r){ss(this,t),this.name=e,this.code=r},W_=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ss(this,t),this.fn=e,this.clv=n},V_=function(){function t(e,n){ss(this,t),this.pad=e,n=null==n?"":String(n),n.length>0&&";"!==n.charAt(n.length-1)&&(n+=";"),this.str=n}return os(t,[{key:"check",value:function(){try{this.parser=new $_(this.pad,this.str);var t=this.parser.parse(),e=this.parser.compile(t);return this.last_result=this.parser.exec(e)}catch(t){return console.error(t),this.last_exception=t,this.last_result=t.msg||String(t)}}}]),t}();Cs.CheckScriptParser=$_,Cs.Checker3=V_;var G_=function(){function t(){ss(this,t)}return os(t,[{key:"exec",value:function(){try{var t=new $_(this.pad,this.str),e=t.parse(),n=t.compile(e),i=t.exec(n);return this.last_reuslt=i}catch(t){return this.last_exception=t,this.last_reuslt=t.msg||""+t}}}],[{key:"parse",value:function(e,n){var i=new t;return i.pad=e,i.str=n,i}}]),t}();Cs.Checker=G_,function(){Ko.src=Cs.DATA_PATH+"/cross.png"}(),Cs.StringBuffer=hs,Cs.GeoPad=Ns,Cs.GObject=Xo,Cs.Translation=Ho,Cs.VectorTranslation=Wo,Cs.Rotation=Vo,Cs.Reflection=Jo,Cs.Dilation=Go,Cs.Point=ll,Cs.FreePoint=ll,Cs.VirtualPoint=ul,Cs.Midpoint=rl,Cs.PointOnObject=al,Cs.IntersectPoint=ol,Cs.XformedPoint=_l,Cs.UnitPoint=hl,Cs.SquareUnitPoint=cl,Cs.Segment=pl,Cs.Ray=fl,Cs.Line=bl,Cs.Parallel=dl,Cs.Perpendicular=yl,Cs.Bisector=gl,Cs.XformedLine=ml,Cs.Circle=xl,Cs.CircleByRadius=kl,Cs.CircleInterior=jl,Cs.XformedCircle=wl,Cs.HorizontalAxis=Ol,Cs.VerticalAxis=Pl,Cs.CoordSysByAxes=$l,Cs.Arc=Sl,Cs.ArcByThreePoint=Tl,Cs.Sector=zl,Cs.Arched=Cl,Cs.Polygon=Il,Cs.FixedText=Nl,Cs.Length=Rl,Cs.Distance=Fl,Cs.Perimeter=Dl,Cs.Circumference=Ll,Cs.Angle=Xl,Cs.Angle2=Yl,Cs.Area=Ul,Cs.Radian=Hl,Cs.ArcLength=Wl,Cs.Radius=Vl,Cs.RatioSegments=Gl,Cs.RatioPoints=Jl,Cs.PointValue=Ql,Cs.Animate=tu,Cs.FadeAnimate=eu,Cs.BlinkAnimate=nu,Cs.MoveAnimate=iu,Cs.PointOnStraightAnim=vu,Cs.Button=ru,Cs.ToggleVisibilityButton=au,Cs.BlinkButton=su,Cs.AnimateButton=ou,Cs.AngleMark=Ml,Cs.LineMark=lu,Cs.BlinkMark=du,Cs.BlinkVec=yu,Cs.ObjNamer=gu,Cs.GscriptParser=xu,Cs.Menu=wu,Cs.Toolbox=Pu,Cs.create_pad=Ns.create_pad,Cs.version="0.2.0 (2017-5-25)"}();
//# sourceMappingURL=geo-0.2.1.min.js.map
